<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì•„ì›ƒë°”ìš´ë“œ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .dashboard-wrap { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    .dashboard-header .header-right { display: flex; align-items: center; gap: 12px; }
    .dashboard-header h1 { margin: 0; font-size: 20px; }
    .back-link { color: #0066cc; text-decoration: none; font-weight: 600; }
    .back-link:hover { text-decoration: underline; }
    .dashboard-section { margin-bottom: 24px; }
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
    .dashboard-card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .dashboard-card h3 { margin: 0 0 12px 0; font-size: 16px; color: #333; }
    .dashboard-card .hint { font-size: 12px; color: #666; margin-bottom: 12px; }
    .toolbar { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
    .toolbar label { font-size: 13px; color: #555; }
    .toolbar select, .toolbar input { padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
    .toolbar button { padding: 8px 16px; background: #17a; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
    .toolbar button:hover { background: #158; }
    .toolbar button:disabled { background: #999; cursor: not-allowed; }
    .stats-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 12px; }
    .stats-table th, .stats-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    .stats-table th { background: #f5f5f5; font-weight: 600; }
    .stats-table tr:hover { background: #f9f9f9; }
    .stats-table .text-left { text-align: left; }
    .stats-table .number { font-weight: 600; color: #333; }
    .distribution-section { margin-top: 24px; }
    .distribution-card {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .distribution-card h4 { margin: 0 0 12px 0; font-size: 14px; color: #333; }
    .distribution-list { max-height: 300px; overflow-y: auto; }
    .distribution-item {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .distribution-item-info { flex: 1; }
    .distribution-item-info strong { display: block; margin-bottom: 4px; }
    .distribution-item-info span { font-size: 11px; color: #666; }
    .distribution-item-actions { display: flex; gap: 8px; }
    .distribution-item-actions button {
      padding: 4px 12px;
      font-size: 11px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-assign { background: #28a745; color: #fff; }
    .btn-assign:hover { background: #218838; }
    .btn-reassign { background: #ffc107; color: #333; }
    .btn-reassign:hover { background: #e0a800; }
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.show { display: flex; }
    .modal-box {
      background: #fff;
      border-radius: 12px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      padding: 16px 20px;
      background: #1a1a1a;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h3 { margin: 0; font-size: 16px; }
    .modal-close {
      padding: 6px 12px;
      background: #444;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .modal-close:hover { background: #555; }
    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    .modal-body label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    .modal-body select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      margin-bottom: 16px;
    }
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .msg { padding: 12px; border-radius: 6px; margin-bottom: 12px; font-size: 13px; }
    .msg.info { background: #e7f3ff; color: #004; }
    .msg.error { background: #ffe0e0; color: #800; }
    .msg.success { background: #d4edda; color: #155724; }
    .loading { padding: 20px; text-align: center; color: #666; }
    .login-lock {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #f5f5f5;
      padding: 20px;
    }
    .login-box {
      background: #fff;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      max-width: 400px;
      width: 100%;
    }
    .login-box h2 {
      margin: 0 0 24px 0;
      font-size: 20px;
      text-align: center;
      color: #333;
    }
    .login-box input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 12px;
      box-sizing: border-box;
    }
    .login-box button {
      width: 100%;
      padding: 12px;
      background: #17a;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
    }
    .login-box button:hover {
      background: #158;
    }
    .login-box .error {
      color: #dc3545;
      font-size: 13px;
      margin-top: 8px;
      text-align: center;
    }
    /* íƒ­ UX */
    .dashboard-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 0;
    }
    .dashboard-tab {
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      background: #f5f5f5;
      border: none;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      transition: all 0.2s;
    }
    .dashboard-tab:hover { color: #333; background: #eee; }
    .dashboard-tab.active {
      color: #17a;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-bottom: 2px solid #fff;
      margin-bottom: -2px;
    }
    .dashboard-tab-content { display: none; }
    .dashboard-tab-content.active { display: block; }
    /* ì¹´ë“œ ê·¸ë£¹ */
    .card-group-title { font-size: 15px; font-weight: 700; color: #1a1a1a; margin: 0 0 16px 0; padding-bottom: 8px; border-bottom: 2px solid #17a; }
    .flow-step { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
    .flow-step-num { width: 28px; height: 28px; background: #17a; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; flex-shrink: 0; }
    .flow-step-desc { font-size: 13px; color: #555; }
    .stats-summary { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px; }
    .stats-summary-item { background: #f8f9fa; padding: 12px 20px; border-radius: 8px; border-left: 4px solid #17a; font-size: 13px; }
    .stats-summary-item strong { display: block; font-size: 18px; color: #333; margin-top: 4px; }
  </style>
</head>
<body>
  <!-- ë¡œê·¸ì¸ í™”ë©´ -->
  <div id="loginLock" class="login-lock" style="display: none;">
    <div class="login-box">
      <h2>ì•„ì›ƒë°”ìš´ë“œ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h2>
      <input type="email" id="loginEmail" placeholder="ì´ë©”ì¼" autocomplete="email">
      <input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password">
      <button type="button" id="loginBtn">ë¡œê·¸ì¸</button>
      <div id="loginError" class="error"></div>
    </div>
  </div>

  <!-- ëŒ€ì‹œë³´ë“œ í™”ë©´ -->
  <div id="dashboardView" class="dashboard-wrap" style="display: none;">
    <div class="dashboard-header">
      <div>
        <h1>ì•„ì›ƒë°”ìš´ë“œ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h1>
        <a href="index.html" class="back-link">â† ìœ ë² ì´ìŠ¤ ëª©ë¡ìœ¼ë¡œ</a>
      </div>
      <div class="header-right">
        <span id="adminUserEmail" style="font-size: 12px; color: #666;"></span>
        <button type="button" class="toolbar button" id="adminLogoutBtn" style="background: #666; color: #fff; font-size: 12px;">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div class="dashboard-tabs">
      <button type="button" class="dashboard-tab active" data-tab="distribution">ë¬¼ëŸ‰ ë¶„ë°°</button>
      <button type="button" class="dashboard-tab" data-tab="stats">í†µê³„Â·ì´ë ¥</button>
    </div>

    <!-- íƒ­1: ë¬¼ëŸ‰ ë¶„ë°° (ìœ í˜•ë³„ ë¶„ë¦¬) -->
    <div id="tab-distribution" class="dashboard-tab-content active">
    <div class="distribution-account-select" style="margin-bottom: 20px; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
      <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #555;">ğŸ“Œ ìë™ ë¶„ë°°í•  ìƒë‹´ì‚¬ (ì²´í¬í•œ ê³„ì •ì—ê²Œë§Œ ê· ë“± ë¶„ë°°)</div>
      <div style="display: flex; flex-wrap: wrap; gap: 12px 20px; align-items: center;">
        <label style="font-size: 12px; color: #666; margin-right: 8px;"><input type="checkbox" id="distAccountAll" checked> ì „ì²´</label>
        <span id="distAccountCheckboxes"></span>
      </div>
    </div>

    <!-- ìœ í˜•1: í™˜ë¶ˆ/êµí™˜ ë¯¸ì²´í¬ -->
    <div class="dashboard-section">
      <div class="dashboard-card" style="border-left: 4px solid #17a;">
        <h3 class="card-group-title">í™˜ë¶ˆ/êµí™˜ ë¯¸ì²´í¬ â€” ì¡°íšŒ ë° ë¶„ë°°</h3>
        <p class="hint">í™˜ë¶ˆÂ·êµí™˜ ì²´í¬ê°€ ì•ˆ ëœ ì ‘ìˆ˜ê±´ì„ ì¡°íšŒí•˜ê³  ìƒë‹´ì‚¬ì—ê²Œ ë¶„ë°°í•©ë‹ˆë‹¤.</p>
        <div class="toolbar">
          <button type="button" class="load-dist-btn" data-type="noCheck">ì „ì²´ ì¡°íšŒ</button>
          <button type="button" class="auto-dist-btn" data-type="noCheck" style="background: #ffc107; color: #333;">ìë™ ê· ë“± ë¶„ë°°</button>
          <button type="button" class="select-dist-btn" data-type="noCheck" style="background: #17a; color: #fff;">ì„ íƒ ë¶„ë°°</button>
        </div>
        <div class="dist-loading" data-type="noCheck" style="display: none;">ì¡°íšŒ ì¤‘â€¦</div>
        <div class="dist-result" data-type="noCheck"></div>
      </div>
    </div>

    <!-- ìœ í˜•2: ì¦ë¹™ì˜¤ë¥˜(ë°˜ë ¤) -->
    <div class="dashboard-section">
      <div class="dashboard-card" style="border-left: 4px solid #dc3545;">
        <h3 class="card-group-title">ì¦ë¹™ì˜¤ë¥˜(ë°˜ë ¤) â€” ì¡°íšŒ ë° ë¶„ë°°</h3>
        <p class="hint">ì¦ë¹™ì˜¤ë¥˜ë¡œ ë°˜ë ¤ëœ ì ‘ìˆ˜ê±´ì„ ì¡°íšŒí•˜ê³  ìƒë‹´ì‚¬ì—ê²Œ ë¶„ë°°í•©ë‹ˆë‹¤.</p>
        <div class="toolbar">
          <button type="button" class="load-dist-btn" data-type="proofError">ì „ì²´ ì¡°íšŒ</button>
          <button type="button" class="auto-dist-btn" data-type="proofError" style="background: #ffc107; color: #333;">ìë™ ê· ë“± ë¶„ë°°</button>
          <button type="button" class="select-dist-btn" data-type="proofError" style="background: #17a; color: #fff;">ì„ íƒ ë¶„ë°°</button>
        </div>
        <div class="dist-loading" data-type="proofError" style="display: none;">ì¡°íšŒ ì¤‘â€¦</div>
        <div class="dist-result" data-type="proofError"></div>
      </div>
    </div>

    <div class="dashboard-section">
      <div class="toolbar">
        <button type="button" id="resetDistributionBtn" style="background: #666; color: #fff;" title="ë¯¸ì²˜ë¦¬ ê±´ë§Œ íšŒìˆ˜ (ì²˜ë¦¬ì™„ë£Œ ê±´ì€ ì²˜ë¦¬ìì—ê²Œ ìœ ì§€)">ì „ì²´ ë¶„ë°° ì´ˆê¸°í™”</button>
      </div>
    </div>

    <div class="dashboard-section">
      <div class="dashboard-card">
        <h3 class="card-group-title">2. ìƒë‹´ì‚¬ë³„ ì”ì—¬ê±´ ë° ì´ê´€</h3>
        <p class="hint">ë¶„ë°°ëœ ë¯¸ì²˜ë¦¬ ê±´ì„ í™•ì¸í•˜ê³  ì´ê´€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í†µê³„ì™€ ë™ì¼í•œ ê¸°ì¤€ â€” ë¶„ë°° ì „ì²´)</p>
        <div class="toolbar">
          <button type="button" id="loadRemainingBtn">ì”ì—¬ê±´ ì¡°íšŒ</button>
        </div>
        <div id="remainingLoading" class="loading" style="display: none;">ì”ì—¬ê±´ ì¡°íšŒ ì¤‘â€¦</div>
        <div id="remainingResult"></div>
      </div>
    </div>
    </div>

    <!-- íƒ­2: í†µê³„Â·ì´ë ¥ -->
    <div id="tab-stats" class="dashboard-tab-content">
    <div class="dashboard-section">
      <div class="dashboard-card">
        <h3 class="card-group-title">ìƒë‹´ì‚¬ë³„ ì‹¤ì Â·ë¶„ë°° ì´ë ¥</h3>
        <p class="hint">ê¸°ê°„ì„ ì„ íƒí•´ ìƒë‹´ì‚¬ë³„ ë¶„ë°°Â·ì²˜ë¦¬ í˜„í™©ì„ ì¡°íšŒí•©ë‹ˆë‹¤. (ì ‘ìˆ˜ì¼ ê¸°ì¤€) ë¹„ì›Œë‘ë©´ ì „ì²´ ì¡°íšŒ. ìƒë‹´ì‚¬ë³„ ìš”ì•½ ë˜ëŠ” ë‚ ì§œë³„ ìƒì„¸ ë³´ê¸°ë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <div class="toolbar">
          <label><input type="checkbox" id="statsDateAll" checked> ì „ì²´</label>
          <label style="margin-left:8px;">ê¸°ê°„:</label>
          <input type="date" id="statsStartDate" value="" disabled>
          <span>~</span>
          <input type="date" id="statsEndDate" value="" disabled>
          <label style="margin-left: 12px;">ìƒë‹´ì‚¬:</label>
          <select id="historyAccountSelect">
            <option value="">ì „ì²´</option>
            <option value="cs1@ubase.co.kr">cs1</option>
            <option value="cs2@ubase.co.kr">cs2</option>
            <option value="cs3@ubase.co.kr">cs3</option>
            <option value="cs4@ubase.co.kr">cs4</option>
            <option value="cs5@ubase.co.kr">cs5</option>
            <option value="cs6@ubase.co.kr">cs6</option>
            <option value="cs7@ubase.co.kr">cs7</option>
            <option value="cs8@ubase.co.kr">cs8</option>
            <option value="cs9@ubase.co.kr">cs9</option>
            <option value="cs10@ubase.co.kr">cs10</option>
          </select>
          <label style="margin-left: 12px;">ë³´ê¸°:</label>
          <select id="statsViewMode">
            <option value="byAccount">ìƒë‹´ì‚¬ë³„ ìš”ì•½</option>
            <option value="byDate">ë‚ ì§œë³„ ìƒì„¸</option>
          </select>
          <button type="button" id="loadStatsBtn">ì¡°íšŒ</button>
          <button type="button" id="loadHistoryBtn" style="display: none;">ì´ë ¥ ì¡°íšŒ</button>
          <button type="button" id="downloadStatsBtn" style="background: #28a745; display: none;">CSV</button>
        </div>
        <div id="statsLoading" class="loading" style="display: none;">ì¡°íšŒ ì¤‘â€¦</div>
        <div id="statsResult"></div>
      </div>
    </div>
    </div>
  </div>

  <!-- ë¶„ë°° ëª¨ë‹¬ -->
  <div id="assignModal" class="modal-overlay" aria-hidden="true">
    <div class="modal-box">
      <div class="modal-header">
        <h3>ì ‘ìˆ˜ê±´ ë¶„ë°°</h3>
        <button type="button" class="modal-close" id="assignModalClose">ë‹«ê¸°</button>
      </div>
      <div class="modal-body">
        <div id="assignModalInfo"></div>
        <label>ìƒë‹´ì‚¬ ì„ íƒ:</label>
        <select id="assignAccountSelect">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="cs1@ubase.co.kr">cs1@ubase.co.kr</option>
          <option value="cs2@ubase.co.kr">cs2@ubase.co.kr</option>
          <option value="cs3@ubase.co.kr">cs3@ubase.co.kr</option>
          <option value="cs4@ubase.co.kr">cs4@ubase.co.kr</option>
          <option value="cs5@ubase.co.kr">cs5@ubase.co.kr</option>
          <option value="cs6@ubase.co.kr">cs6@ubase.co.kr</option>
          <option value="cs7@ubase.co.kr">cs7@ubase.co.kr</option>
          <option value="cs8@ubase.co.kr">cs8@ubase.co.kr</option>
          <option value="cs9@ubase.co.kr">cs9@ubase.co.kr</option>
          <option value="cs10@ubase.co.kr">cs10@ubase.co.kr</option>
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="toolbar button" id="assignModalCancelBtn" style="background: #777; color: #fff;">ì·¨ì†Œ</button>
        <button type="button" class="toolbar button" id="assignModalConfirmBtn" style="background: #28a745; color: #fff;">ë¶„ë°°</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getDatabase,
      ref as dbRef,
      get,
      set
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    // ì•„ì›ƒë°”ìš´ë“œ ëŒ€ì‹œë³´ë“œ ì ‘ê·¼ ê¶Œí•œ: ê´€ë¦¬ì ê³„ì •ë§Œ
    const ALLOWED_EMAILS = ['csadmin@ubase.co.kr'];
    
    // ìƒë‹´ì› ê³„ì • ëª©ë¡ (ë¶„ë°°ìš©)
    const CS_ACCOUNTS = [];
    for (let i = 1; i <= 10; i++) {
      CS_ACCOUNTS.push(`cs${i}@ubase.co.kr`);
    }

    const PREFIXES = ['nutricia-x9fQ2kM7-1', 'nutricia-aL4pZ8Tq-2', 'nutricia-nu7VnCwR3H-3', 'nutricia-MK2rP9dS-4'];
    const PROJECT_LABELS = ['ì•„ì´ë² ', 'ë¦¼ì¸í„°ë„¤ì…”ë„', 'í¬ë¦°ë©', 'ëª°í…Œì¼'];

    const firebaseConfig = {
      apiKey: "AIzaSyCxNwnAzMn0JUkHGDXgY4taTPJYeABDohg",
      authDomain: "eibe-nutricia.firebaseapp.com",
      databaseURL: "https://eibe-nutricia-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "eibe-nutricia",
      storageBucket: "eibe-nutricia.firebasestorage.app",
      messagingSenderId: "605906618980",
      appId: "1:605906618980:web:d947540696a573c4856d71"
    };

    let app, db, auth;
    try {
      app = initializeApp(firebaseConfig);
      db = getDatabase(app);
      auth = getAuth(app);
    } catch (err) {
      console.error('Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:', err);
    }

    const adminUserEmailEl = document.getElementById('adminUserEmail');
    const adminLogoutBtn = document.getElementById('adminLogoutBtn');
    const statsStartDate = document.getElementById('statsStartDate');
    const statsEndDate = document.getElementById('statsEndDate');
    const loadStatsBtn = document.getElementById('loadStatsBtn');
    const downloadStatsBtn = document.getElementById('downloadStatsBtn');
    const statsLoading = document.getElementById('statsLoading');
    const statsResult = document.getElementById('statsResult');
    const resetDistributionBtn = document.getElementById('resetDistributionBtn');
    const loadRemainingBtn = document.getElementById('loadRemainingBtn');
    const remainingLoading = document.getElementById('remainingLoading');
    const remainingResult = document.getElementById('remainingResult');
    const historyAccountSelect = document.getElementById('historyAccountSelect');
    const loadHistoryBtn = document.getElementById('loadHistoryBtn');
    const assignModal = document.getElementById('assignModal');
    const assignModalClose = document.getElementById('assignModalClose');
    const assignModalCancelBtn = document.getElementById('assignModalCancelBtn');
    const assignModalConfirmBtn = document.getElementById('assignModalConfirmBtn');
    const assignModalInfo = document.getElementById('assignModalInfo');
    const assignAccountSelect = document.getElementById('assignAccountSelect');
    const statsViewMode = document.getElementById('statsViewMode');
    const loginLock = document.getElementById('loginLock');
    const dashboardView = document.getElementById('dashboardView');
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');

    // ë¶„ë°° ëŒ€ìƒ ê³„ì • ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
    const distAccountCheckboxes = document.getElementById('distAccountCheckboxes');
    const distAccountAll = document.getElementById('distAccountAll');
    if (distAccountCheckboxes) {
      CS_ACCOUNTS.forEach((email) => {
        const label = document.createElement('label');
        label.style.cssText = 'font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; margin: 0;';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'dist-account-cb';
        cb.value = email;
        cb.checked = true;
        cb.style.marginRight = '4px';
        cb.addEventListener('change', () => {
          const allCbs = document.querySelectorAll('.dist-account-cb');
          const checkedCount = Array.from(allCbs).filter((c) => c.checked).length;
          if (distAccountAll) distAccountAll.checked = checkedCount === allCbs.length;
        });
        label.appendChild(cb);
        label.appendChild(document.createTextNode(email.replace('@ubase.co.kr', '')));
        distAccountCheckboxes.appendChild(label);
      });
    }
    if (distAccountAll) {
      distAccountAll.addEventListener('change', () => {
        document.querySelectorAll('.dist-account-cb').forEach((cb) => { cb.checked = distAccountAll.checked; });
      });
    }

    // í†µê³„ ê¸°ë³¸ê°’: ì „ì²´ (ë‚ ì§œ ë¹„ì›€)
    const statsDateAllCb = document.getElementById('statsDateAll');
    function syncStatsDateAll() {
      const all = statsDateAllCb && statsDateAllCb.checked;
      if (statsStartDate) statsStartDate.disabled = !!all;
      if (statsEndDate) statsEndDate.disabled = !!all;
      if (all) {
        statsStartDate.value = '';
        statsEndDate.value = '';
      } else if (statsStartDate && statsEndDate && !statsStartDate.value) {
        const today = new Date();
        const monthAgo = new Date(today);
        monthAgo.setDate(monthAgo.getDate() - 30);
        statsStartDate.value = monthAgo.toISOString().split('T')[0];
        statsEndDate.value = today.toISOString().split('T')[0];
      }
    }
    if (statsDateAllCb) statsDateAllCb.addEventListener('change', syncStatsDateAll);
    syncStatsDateAll();

    const DISTRIBUTION_PATH = 'outbound_distribution/assignments';
    // ë¶„ë°° ì´ë ¥: Firebase ì €ì¥ (ëŒ€ì‹œë³´ë“œê°€ ê´€ë¦¬, CSëŠ” ì½ê¸°ë§Œ)
    function ensureHistoryArray(val) {
      if (Array.isArray(val)) return val;
      if (val && typeof val === 'object') return Object.keys(val).sort((a, b) => Number(a) - Number(b)).map(k => val[k]);
      return [];
    }

    async function loadDistributionHistoryFromFirebase() {
      if (!db) return new Map();
      try {
        const snap = await get(dbRef(db, DISTRIBUTION_PATH));
        if (!snap.exists()) return new Map();
        const data = snap.val();
        if (!data || typeof data !== 'object') return new Map();
        const map = new Map();
        Object.entries(data).forEach(([k, v]) => map.set(k, ensureHistoryArray(v)));
        return map;
      } catch (e) {
        console.error('ë¶„ë°° ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨:', e);
        return new Map();
      }
    }

    async function saveDistributionHistoryToFirebase(map) {
      if (!db) return false;
      try {
        const obj = Object.fromEntries(map);
        await set(dbRef(db, DISTRIBUTION_PATH), obj);
        return true;
      } catch (e) {
        console.error('ë¶„ë°° ì´ë ¥ ì €ì¥ ì‹¤íŒ¨:', e);
        return false;
      }
    }

    // ê³„ì •ë³„ íšŒìˆ˜: í•´ë‹¹ ìƒë‹´ì‚¬ì—ê²Œ ë°°ì •ëœ ê±´ ì¤‘ ë¯¸ì²˜ë¦¬ ê±´ë§Œ íšŒìˆ˜ (ì²˜ë¦¬ì™„ë£Œ ê±´ì€ ê·¸ëŒ€ë¡œ ìœ ì§€)
    async function recallDistributionByAccount(account) {
      if (!account || !confirm(account + 'ì—ê²Œ ë°°ì •ëœ ë¯¸ì²˜ë¦¬ ê±´ì„ íšŒìˆ˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€» í•´ë‹¹ ìƒë‹´ì‚¬ê°€ ì´ë¯¸ ì²˜ë¦¬(ìœ ì„ ì•ˆë‚´ì™„ë£Œ)í•œ ê±´ì€ íšŒìˆ˜ë˜ì§€ ì•Šê³  ìœ ì§€ë©ë‹ˆë‹¤.')) {
        return;
      }
      distributionHistoryMap = await loadDistributionHistoryFromFirebase();
      await loadProcessingAndCounselingFromFirebase();
      let recallCount = 0;
      const keysToRemove = [];
      distributionHistoryMap.forEach((history, key) => {
        if (!Array.isArray(history) || history.length === 0) return;
        const latest = history[history.length - 1];
        if (latest && latest.account && latest.account.toLowerCase() === account.toLowerCase()) {
          const ph = processingHistoryMap.get(key) || [];
          const processedBy = getProcessedByAccount(ph);
          if (processedBy && processedBy.toLowerCase() === account.toLowerCase()) {
            return;
          }
          keysToRemove.push(key);
          recallCount++;
        }
      });
      keysToRemove.forEach((k) => distributionHistoryMap.delete(k));
      await saveDistributionHistoryToFirebase(distributionHistoryMap);
      alert(account + ' ë¯¸ì²˜ë¦¬ ë°°ì • ' + recallCount + 'ê±´ì„ íšŒìˆ˜í–ˆìŠµë‹ˆë‹¤. (ì²˜ë¦¬ì™„ë£Œ ê±´ì€ ìœ ì§€)');

      await loadDistribution('noCheck');
      await loadDistribution('proofError');
      loadRemaining();
      loadHistory();
      loadStats();
    }

    // ì „ì²´ ì´ˆê¸°í™”: ë¯¸ì²˜ë¦¬ ê±´ë§Œ íšŒìˆ˜ (ì²˜ë¦¬ì™„ë£Œ ê±´ì€ ì²˜ë¦¬í•œ ìƒë‹´ì‚¬ì—ê²Œ ìœ ì§€)
    async function resetDistribution() {
      if (!confirm('ë¯¸ì²˜ë¦¬ ê±´ë§Œ íšŒìˆ˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€» ê° ìƒë‹´ì‚¬ê°€ ì´ë¯¸ ì²˜ë¦¬(ìœ ì„ ì•ˆë‚´ì™„ë£Œ)í•œ ê±´ì€ í•´ë‹¹ ìƒë‹´ì‚¬ì—ê²Œ ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.')) {
        return;
      }
      distributionHistoryMap = await loadDistributionHistoryFromFirebase();
      await loadProcessingAndCounselingFromFirebase();
      const newMap = new Map();
      distributionHistoryMap.forEach((history, key) => {
        if (!Array.isArray(history) || history.length === 0) return;
        const latest = history[history.length - 1];
        const ph = processingHistoryMap.get(key) || [];
        const processedBy = getProcessedByAccount(ph);
        if (processedBy) {
          newMap.set(key, history);
        }
      });
      await saveDistributionHistoryToFirebase(newMap);
      const kept = newMap.size;
      const removed = distributionHistoryMap.size - kept;
      alert('ë¯¸ì²˜ë¦¬ ' + removed + 'ê±´ íšŒìˆ˜ ì™„ë£Œ. ì²˜ë¦¬ì™„ë£Œ ' + kept + 'ê±´ì€ ì²˜ë¦¬ìì—ê²Œ ìœ ì§€ë©ë‹ˆë‹¤.');

      await loadDistribution('noCheck');
      await loadDistribution('proofError');
      loadRemaining();
      loadHistory();
      loadStats();
    }

    // ì²˜ë¦¬ ë‚´ì—­Â·ìƒë‹´ ì´ë ¥: Firebaseì—ì„œ ë¡œë“œ (CS ê³„ì •ì´ outbound.htmlì—ì„œ ì €ì¥)
    async function loadProcessingAndCounselingFromFirebase() {
      if (!db) return;
      const procMap = new Map();
      const counselMap = new Map();
      try {
        for (const prefix of PREFIXES) {
          const procSnap = await get(dbRef(db, prefix + '/processing_history'));
          if (procSnap.exists()) {
            procSnap.forEach((dateSnap) => {
              const dateKey = dateSnap.key;
              if (!/^\d{8}$/.test(dateKey)) return;
              dateSnap.forEach((idSnap) => {
                const id = idSnap.key;
                const raw = [];
                idSnap.forEach((child) => raw.push(child.val()));
                const arr = raw.map(h => (h && typeof h === 'object') ? { account: h.account || '', timestamp: h.timestamp || 0, changes: String(h.changes || '') } : null).filter(Boolean);
                if (arr.length) procMap.set(`${prefix}_${dateKey}_${id}`, arr.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)));
              });
            });
          }
          const metaSnap = await get(dbRef(db, prefix + '/submissions_meta'));
          if (metaSnap.exists()) {
            metaSnap.forEach((dateSnap) => {
              const dateKey = dateSnap.key;
              if (!/^\d{8}$/.test(dateKey)) return;
              dateSnap.forEach((inner) => {
                const data = inner.val();
                const hist = data && data.counselingHistory;
                if (Array.isArray(hist) && hist.length) {
                  counselMap.set(`${prefix}_${dateKey}_${inner.key}`, hist.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)));
                }
              });
            });
          }
        }
        processingHistoryMap = procMap;
        counselingHistoryMap = counselMap;
      } catch (err) {
        console.error('Firebase ì²˜ë¦¬/ìƒë‹´ì´ë ¥ ë¡œë“œ ì˜¤ë¥˜:', err);
      }
    }

    let distributionHistoryMap = new Map();
    let processingHistoryMap = new Map();
    let counselingHistoryMap = new Map();
    let allSubmissions = [];
    let loadDistributionInProgress = false; // ë™ì‹œ ì‹¤í–‰ ë°©ì§€
    let isSigningOut = false; // ë¬´í•œ ë£¨í”„ ë°©ì§€ í”Œë˜ê·¸
    let lastCheckedEmail = ''; // ë§ˆì§€ë§‰ìœ¼ë¡œ í™•ì¸í•œ ì´ë©”ì¼ (ì¤‘ë³µ ì²´í¬ ë°©ì§€)

    function formatDate(t) {
      if (!t) return '-';
      const d = typeof t === 'number' ? new Date(t) : new Date(t);
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0') + ' ' +
        String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
    }

    function escapeHtml(s) {
      if (s == null) return '';
      return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // ìœ ì„ ì•ˆë‚´ì™„ë£Œ ì—¬ë¶€: processing historyì—ì„œ ìµœì‹  ë³€ê²½ ê¸°ì¤€ (ì²´í¬â†’í•´ì œ ì‹œ í˜„ì¬ ë¯¸ì™„ë£Œë¡œ íŒì •)
    function isCallCompleteForKey(processingHistory) {
      if (!Array.isArray(processingHistory) || processingHistory.length === 0) return false;
      const sorted = [...processingHistory].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      for (const h of sorted) {
        if (h.changes && typeof h.changes === 'string') {
          if (h.changes.includes('ìœ ì„ ì•ˆë‚´ì™„ë£Œ: ì²´í¬')) return true;
          if (h.changes.includes('ìœ ì„ ì•ˆë‚´ì™„ë£Œ: í•´ì œ')) return false;
        }
      }
      return false;
    }
    // ìœ ì„ ì•ˆë‚´ì™„ë£Œ ì²´í¬í•œ ìƒë‹´ì‚¬(ì²˜ë¦¬í•œ ì‚¬ëŒ) ë°˜í™˜. ì²´í¬ëœ ê²½ìš° í•´ë‹¹ account, ë¯¸ì²´í¬ë©´ null
    function getProcessedByAccount(processingHistory) {
      if (!Array.isArray(processingHistory) || processingHistory.length === 0) return null;
      const sorted = [...processingHistory].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      for (const h of sorted) {
        if (h.changes && typeof h.changes === 'string') {
          if (h.changes.includes('ìœ ì„ ì•ˆë‚´ì™„ë£Œ: ì²´í¬')) return (h.account || '').trim() || null;
          if (h.changes.includes('ìœ ì„ ì•ˆë‚´ì™„ë£Œ: í•´ì œ')) return null;
        }
      }
      return null;
    }
    function showAdminUI(user) {
      if (adminUserEmailEl) adminUserEmailEl.textContent = user.email || '';
      if (loginLock) loginLock.style.display = 'none';
      if (dashboardView) dashboardView.style.display = 'block';
    }

    function showLoginUI() {
      if (loginLock) loginLock.style.display = 'flex';
      if (dashboardView) dashboardView.style.display = 'none';
      if (loginError) loginError.textContent = '';
    }

    // ì´ˆê¸° ë¡œë“œ ì‹œ ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
    showLoginUI();

    onAuthStateChanged(auth, (user) => {
      if (!auth) {
        showLoginUI();
        return;
      }
      if (isSigningOut) return; // signOut ì§„í–‰ ì¤‘ì´ë©´ ë¬´ì‹œ
      
      if (!user) {
        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
        if (lastCheckedEmail) {
          lastCheckedEmail = '';
          showLoginUI();
        }
        return;
      }
      
      const email = (user.email || '').trim().toLowerCase();
      
      // ê°™ì€ ì´ë©”ì¼ë¡œ ì´ë¯¸ ì²´í¬í–ˆë‹¤ë©´ ë¬´ì‹œ (ì¤‘ë³µ ì²´í¬ ë°©ì§€)
      if (email === lastCheckedEmail) {
        return;
      }
      
      lastCheckedEmail = email;
      const allowed = ALLOWED_EMAILS.some((e) => e.toLowerCase() === email);
      
      if (allowed) {
        showAdminUI(user);
      } else {
        // ê¶Œí•œì´ ì—†ëŠ” ê³„ì •ì´ë©´ ë¡œê·¸ì•„ì›ƒ
        isSigningOut = true;
        signOut(auth).then(() => {
          isSigningOut = false;
          lastCheckedEmail = '';
          showLoginUI();
        }).catch(() => {
          isSigningOut = false;
        });
      }
    });

    if (adminLogoutBtn) {
      adminLogoutBtn.addEventListener('click', () => {
        isSigningOut = true;
        signOut(auth).then(() => {
          isSigningOut = false;
          showLoginUI();
        }).catch(() => {
          isSigningOut = false;
        });
      });
    }

    // ë¡œê·¸ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸
    if (loginBtn) {
      loginBtn.addEventListener('click', async () => {
        const email = loginEmail.value.trim();
        const password = loginPassword.value;
        
        if (!email || !password) {
          if (loginError) loginError.textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
          return;
        }

        if (!auth) {
          if (loginError) loginError.textContent = 'ì¸ì¦ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
          return;
        }

        if (loginError) loginError.textContent = '';
        loginBtn.disabled = true;
        loginBtn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';

        try {
          await signInWithEmailAndPassword(auth, email, password);
          // onAuthStateChangedì—ì„œ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë¨
        } catch (err) {
          const code = err.code || '';
          if (code === 'auth/invalid-credential' || code === 'auth/wrong-password' || code === 'auth/user-not-found') {
            if (loginError) loginError.textContent = 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
          } else {
            if (loginError) loginError.textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + (err.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
          }
        } finally {
          loginBtn.disabled = false;
          loginBtn.textContent = 'ë¡œê·¸ì¸';
        }
      });

      // Enter í‚¤ë¡œ ë¡œê·¸ì¸
      if (loginPassword) {
        loginPassword.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            loginBtn.click();
          }
        });
      }
    }

    // ìƒë‹´ì‚¬ë³„ ì‹¤ì  í†µê³„ ì¡°íšŒ (í†µí•©)
    async function loadStats() {
      if (!db) {
        statsResult.innerHTML = '<div class="msg error">Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      const useDateFilter = !(statsDateAllCb && statsDateAllCb.checked);
      const startDate = statsStartDate.value;
      const endDate = statsEndDate.value;

      if (useDateFilter && (!startDate || !endDate)) {
        statsResult.innerHTML = '<div class="msg error">ì „ì²´ê°€ ì•„ë‹ ê²½ìš° ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
        return;
      }

      statsLoading.style.display = 'block';
      statsResult.innerHTML = '';
      downloadStatsBtn.style.display = 'none';

      try {
        let startTime = 0, endTime = Number.MAX_SAFE_INTEGER;
        if (useDateFilter && startDate && endDate) {
          startTime = new Date(startDate + 'T00:00:00').getTime();
          endTime = new Date(endDate + 'T23:59:59').getTime();
        }

        distributionHistoryMap = await loadDistributionHistoryFromFirebase();
        await loadProcessingAndCounselingFromFirebase();

        // ìƒë‹´ì‚¬ë³„ í†µê³„: ì´/ë¯¸íŠ¹ì •/ì¦ë¹™ì˜¤ë¥˜ ê°ê° ë¶„ë°°ê±´Â·ì²˜ë¦¬ê±´
        const accountStats = {};
        CS_ACCOUNTS.forEach(email => {
          accountStats[email] = {
            account: email,
            totalDist: 0, totalComplete: 0,
            noCheckDist: 0, noCheckComplete: 0,
            proofErrorDist: 0, proofErrorComplete: 0
          };
        });

        const latestDistributionMap = new Map();
        distributionHistoryMap.forEach((history, key) => {
          if (Array.isArray(history) && history.length > 0) {
            const latest = history[history.length - 1];
            const category = latest.category === 'proofError' ? 'proofError' : 'noCheck';
            const parts = key.split('_');
            const dateKey = parts[1];
            if (dateKey && /^\d{8}$/.test(dateKey)) {
              const y = dateKey.substring(0, 4), m = dateKey.substring(4, 6), d = dateKey.substring(6, 8);
              const itemDate = new Date(y + '-' + m + '-' + d + 'T00:00:00').getTime();
              if (itemDate >= startTime && itemDate <= endTime) {
                latestDistributionMap.set(key, { ...latest, _category: category });
              }
            }
          }
        });

        latestDistributionMap.forEach((entry, key) => {
          const acc = accountStats[entry.account];
          if (!acc) return;
          acc.totalDist++;
          if (entry._category === 'noCheck') acc.noCheckDist++;
          else acc.proofErrorDist++;

          const ph = processingHistoryMap.get(key) || [];
          const processedBy = getProcessedByAccount(ph);
          if (processedBy && processedBy.toLowerCase() === entry.account.toLowerCase()) {
            acc.totalComplete++;
            if (entry._category === 'noCheck') acc.noCheckComplete++;
            else acc.proofErrorComplete++;
          }
        });

        const rangeLabel = useDateFilter && startDate && endDate ? (' (' + startDate + ' ~ ' + endDate + ')') : ' (ì „ì²´)';
        let html = '<table class="stats-table">';
        html += '<caption style="caption-side:top;text-align:left;font-weight:600;margin-bottom:8px;">ìƒë‹´ì‚¬ë³„ ìš”ì•½' + rangeLabel + ' (ì²˜ë¦¬ê±´ = í•´ë‹¹ ìƒë‹´ì‚¬ê°€ ìœ ì„ ì•ˆë‚´ì™„ë£Œ ì²´í¬í•œ ê±´)</caption>';
        html += '<thead><tr>';
        html += '<th>ìƒë‹´ì‚¬</th>';
        html += '<th>ì´ ë¶„ë°°</th><th>ì´ ì²˜ë¦¬ê±´</th>';
        html += '<th>ë¯¸íŠ¹ì • ë¶„ë°°ê±´</th><th>ë¯¸íŠ¹ì • ì²˜ë¦¬ê±´</th>';
        html += '<th>ì¦ë¹™ì˜¤ë¥˜ ì ‘ìˆ˜ê±´</th><th>ì¦ë¹™ì˜¤ë¥˜ ì²˜ë¦¬ê±´</th>';
        html += '</tr></thead><tbody>';

        Object.values(accountStats).forEach(stat => {
          html += '<tr>';
          html += '<td class="text-left">' + escapeHtml(stat.account) + '</td>';
          html += '<td class="number">' + stat.totalDist + '</td>';
          html += '<td class="number">' + stat.totalComplete + '</td>';
          html += '<td class="number">' + stat.noCheckDist + '</td>';
          html += '<td class="number">' + stat.noCheckComplete + '</td>';
          html += '<td class="number">' + stat.proofErrorDist + '</td>';
          html += '<td class="number">' + stat.proofErrorComplete + '</td>';
          html += '</tr>';
        });
        html += '</tbody></table>';
        statsResult.innerHTML = html;
        downloadStatsBtn.style.display = 'inline-block';
      } catch (err) {
        statsResult.innerHTML = '<div class="msg error">í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: ' + escapeHtml(err.message || err) + '</div>';
      } finally {
        statsLoading.style.display = 'none';
      }
    }

    // ì „ì²´ ì ‘ìˆ˜ê±´ ì¡°íšŒ (ìœ í˜•ë³„)
    async function loadDistribution(filterType) {
      if (!db) {
        const target = document.querySelector('.dist-result[data-type="' + filterType + '"]');
        if (target) target.innerHTML = '<div class="msg error">Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      while (loadDistributionInProgress) {
        await new Promise(r => setTimeout(r, 80));
      }
      loadDistributionInProgress = true;

      const targetResult = document.querySelector('.dist-result[data-type="' + filterType + '"]');
      const targetLoading = document.querySelector('.dist-loading[data-type="' + filterType + '"]');
      if (targetLoading) targetLoading.style.display = 'block';
      if (targetResult) targetResult.innerHTML = '';

      try {
        // ì „ì²´ ì ‘ìˆ˜ê±´ ì¡°íšŒ (ë‚ ì§œ ì œí•œ ì—†ìŒ) - idëŠ” inner.keyë¡œ ê³ ì • (item.id ë®ì–´ì“°ê¸° ë°©ì§€)
        allSubmissions = [];
        for (const prefix of PREFIXES) {
          const snap = await get(dbRef(db, prefix + '/submissions_meta'));
          if (snap.exists()) {
            snap.forEach((dateSnap) => {
              const dateKey = dateSnap.key;
              if (!/^\d{8}$/.test(dateKey)) return;
              dateSnap.forEach((inner) => {
                const item = inner.val();
                allSubmissions.push({
                  ...item,
                  _prefix: prefix,
                  id: inner.key,
                  _dateKey: dateKey
                });
              });
            });
          }
        }

        // ë¶„ë°° ìƒíƒœ í™•ì¸ (localStorageì—ì„œ ìµœì‹  ë¡œë“œ)
        distributionHistoryMap = await loadDistributionHistoryFromFirebase();
        await loadProcessingAndCounselingFromFirebase();
        
        const distributionMap = new Map();
        allSubmissions.forEach(item => {
          const key = `${item._prefix}_${item._dateKey}_${item.id}`;
          const history = distributionHistoryMap.get(key) || [];
          const latest = Array.isArray(history) && history.length > 0 ? history[history.length - 1] : null;
          if (latest && latest.category === filterType) {
            if (!distributionMap.has(latest.account)) {
              distributionMap.set(latest.account, []);
            }
            distributionMap.get(latest.account).push(item);
          }
        });

        // ë“œë¡­ë‹¤ìš´ í•„í„°ì— ë”°ë¼ ë¯¸ë¶„ë°° ì ‘ìˆ˜ê±´ í•„í„°ë§
        const unassigned = allSubmissions.filter(item => {
          const key = `${item._prefix}_${item._dateKey}_${item.id}`;
          const history = distributionHistoryMap.get(key) || [];
          const isAssigned = Array.isArray(history) && history.length > 0;
          
          // í•„í„° íƒ€ì…ì— ë”°ë¼ í•„í„°ë§
          if (filterType === 'noCheck') {
            // í™˜ë¶ˆ/êµí™˜ ì²´í¬ ì•ˆ ëœ ê±´ë§Œ (ì¦ë¹™ì˜¤ë¥˜ ì•„ë‹˜)
            const isNotChecked = !item.refundDone && !item.exchangeDone;
            const isNotProofError = !item.proofError;
            return !isAssigned && isNotChecked && isNotProofError;
          } else if (filterType === 'proofError') {
            // ì¦ë¹™ì˜¤ë¥˜(ë°˜ë ¤) ê±´ë§Œ
            return !isAssigned && !!item.proofError;
          }
          return false;
        });

        const filterLabel = filterType === 'noCheck' ? 'í™˜ë¶ˆ/êµí™˜ ë¯¸ì²´í¬' : 'ì¦ë¹™ì˜¤ë¥˜(ë°˜ë ¤)';
        let html = '<div class="msg info">ì „ì²´ ì ‘ìˆ˜ê±´: ' + allSubmissions.length + 'ê±´ | ' + filterLabel + ' ë¯¸ë¶„ë°°: ' + unassigned.length + 'ê±´</div>';

        // ë¶„ë°° í˜„í™© í‘œì‹œ (ê° ìƒë‹´ì›ë³„ ë¶„ë°° ê±´ìˆ˜ ë° ì¬ë¶„ë°° ë²„íŠ¼)
        if (distributionMap.size > 0) {
          html += '<h4 style="margin-top: 16px; margin-bottom: 8px;">í˜„ì¬ ë¶„ë°° í˜„í™©</h4>';
          html += '<table class="stats-table" style="margin-bottom: 16px;">';
          html += '<thead><tr>';
          html += '<th>ìƒë‹´ì‚¬</th>';
          html += '<th>ë¶„ë°° ê±´ìˆ˜</th>';
          html += '<th>ì²˜ë¦¬ì™„ë£Œ</th>';
          html += '<th>ë¯¸ì²˜ë¦¬</th>';
          html += '<th>ì¬ë¶„ë°°</th>';
          html += '<th>íšŒìˆ˜</th>';
          html += '</tr></thead><tbody>';
          
          distributionMap.forEach((items, account) => {
            const completedCount = items.filter(item => {
              const key = `${item._prefix}_${item._dateKey}_${item.id}`;
              const ph = processingHistoryMap.get(key) || [];
              const processedBy = getProcessedByAccount(ph);
              return processedBy && processedBy.toLowerCase() === account.toLowerCase();
            }).length;
            const remainingCount = items.length - completedCount;
            
            html += '<tr>';
            html += '<td class="text-left">' + escapeHtml(account) + '</td>';
            html += '<td class="number">' + items.length + '</td>';
            html += '<td class="number" style="color: #28a745;">' + completedCount + '</td>';
            html += '<td class="number" style="color: #dc3545;">' + remainingCount + '</td>';
            html += '<td>';
            if (remainingCount > 0) {
              html += '<button type="button" class="btn-reassign-bulk" data-account="' + escapeHtml(account) + '" data-count="' + remainingCount + '" style="padding: 4px 12px; font-size: 12px; background: #17a; color: #fff; border: none; border-radius: 4px; cursor: pointer;">ì¬ë¶„ë°°</button>';
            } else {
              html += '-';
            }
            html += '</td>';
            html += '<td>';
            html += '<button type="button" class="btn-recall-account" data-account="' + escapeHtml(account) + '" data-count="' + items.length + '" style="padding: 4px 12px; font-size: 12px; background: #dc3545; color: #fff; border: none; border-radius: 4px; cursor: pointer;">íšŒìˆ˜</button>';
            html += '</td>';
            html += '</tr>';
          });
          
          html += '</tbody></table>';

          // ê³„ì •ë³„ ì²˜ë¦¬ êµ¬ì—­ (ê° ìƒë‹´ì‚¬ê°€ ì²˜ë¦¬í•œ ê±´ ë³„ë„ í‘œì‹œ, í˜„ì¬ ìœ í˜• ê¸°ì¤€)
          const processedByAccountMap = new Map();
          allSubmissions.forEach(item => {
            const key = `${item._prefix}_${item._dateKey}_${item.id}`;
            const history = distributionHistoryMap.get(key) || [];
            if (!Array.isArray(history) || history.length === 0) return;
            const latest = history[history.length - 1];
            const itemCategory = latest.category === 'proofError' ? 'proofError' : 'noCheck';
            if (itemCategory !== filterType) return;
            const ph = processingHistoryMap.get(key) || [];
            const processedBy = getProcessedByAccount(ph);
            if (!processedBy) return;
            if (!processedByAccountMap.has(processedBy)) processedByAccountMap.set(processedBy, []);
            processedByAccountMap.get(processedBy).push(item);
          });
          if (processedByAccountMap.size > 0) {
            const zoneLabel = filterType === 'noCheck' ? 'í™˜ë¶ˆ/êµí™˜ ë¯¸ì²´í¬' : 'ì¦ë¹™ì˜¤ë¥˜(ë°˜ë ¤)';
            html += '<h4 style="margin-top: 20px; margin-bottom: 8px;">ğŸ“Œ ê³„ì •ë³„ ì²˜ë¦¬ êµ¬ì—­ (' + zoneLabel + ' ì¤‘ ê° ìƒë‹´ì‚¬ê°€ ìœ ì„ ì•ˆë‚´ì™„ë£Œ ì²´í¬í•œ ê±´)</h4>';
            const sortedAccounts = [...processedByAccountMap.keys()].sort();
            sortedAccounts.forEach(acc => {
              const items = processedByAccountMap.get(acc);
              const shortName = acc.replace('@ubase.co.kr', '');
              html += '<div class="distribution-card" style="margin-bottom: 12px; border-left: 4px solid #17a;">';
              html += '<h5 style="margin: 0 0 8px 0; font-size: 13px;">' + escapeHtml(shortName) + ' ì²˜ë¦¬ êµ¬ì—­ (' + items.length + 'ê±´)</h5>';
              html += '<div class="distribution-list" style="max-height: 180px;">';
              items.forEach(item => {
                html += '<div class="distribution-item" style="padding: 6px 10px;">';
                html += '<div class="distribution-item-info">';
                html += '<strong>' + escapeHtml(item.name || '-') + ' / ' + escapeHtml(item.contact || '-') + '</strong>';
                html += '<span>ì ‘ìˆ˜ID: ' + escapeHtml(item.id) + ' | ' + PROJECT_LABELS[PREFIXES.indexOf(item._prefix)] + '</span>';
                html += '</div></div>';
              });
              html += '</div></div>';
            });
          }
        }

        // ë¯¸ë¶„ë°° ì ‘ìˆ˜ê±´ í‘œì‹œ
        if (unassigned.length > 0) {
          html += '<h4 style="margin-top: 16px; margin-bottom: 8px;">' + filterLabel + ' ë¯¸ë¶„ë°° ê±´ (' + unassigned.length + 'ê±´)</h4>';
          html += '<div class="distribution-card">';
          html += '<div class="distribution-list">';
          unassigned.forEach(item => {
            const key = `${item._prefix}_${item._dateKey}_${item.id}`;
            const category = filterType;
            html += '<div class="distribution-item">';
            html += '<div class="distribution-item-info">';
            html += '<strong>' + escapeHtml(item.name || '-') + ' / ' + escapeHtml(item.contact || '-') + '</strong>';
            html += '<span>ì ‘ìˆ˜ID: ' + escapeHtml(item.id) + ' | ' + PROJECT_LABELS[PREFIXES.indexOf(item._prefix)] + ' | ' + filterLabel + '</span>';
            html += '</div>';
            html += '<div class="distribution-item-actions">';
            html += '<button type="button" class="btn-assign" data-key="' + escapeHtml(key) + '" data-category="' + category + '">ë¶„ë°°</button>';
            html += '</div>';
            html += '</div>';
          });
          html += '</div></div>';
        }

        if (targetResult) targetResult.innerHTML = html;

        // ë¶„ë°° ë²„íŠ¼ ì´ë²¤íŠ¸
        if (targetResult) targetResult.querySelectorAll('.btn-assign, .btn-reassign').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const key = btn.getAttribute('data-key');
            const category = btn.getAttribute('data-category') || '';
            const item = allSubmissions.find(s => `${s._prefix}_${s._dateKey}_${s.id}` === key);
            if (item) {
              openAssignModal(item, key, btn.classList.contains('btn-reassign'), category);
            }
          });
        });

        // ê³„ì •ë³„ íšŒìˆ˜ ë²„íŠ¼ ì´ë²¤íŠ¸
        if (targetResult) targetResult.querySelectorAll('.btn-recall-account').forEach(btn => {
          btn.addEventListener('click', () => {
            const account = btn.getAttribute('data-account');
            if (account) recallDistributionByAccount(account);
          });
        });

        // ëŒ€ëŸ‰ ì¬ë¶„ë°° ë²„íŠ¼ ì´ë²¤íŠ¸
        if (targetResult) targetResult.querySelectorAll('.btn-reassign-bulk').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const fromAccount = btn.getAttribute('data-account');
            
            // í•´ë‹¹ ìƒë‹´ì›ì˜ ë¯¸ì²˜ë¦¬ ê±´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const fromItems = distributionMap.get(fromAccount) || [];
            const uncompletedItems = fromItems.filter(item => {
              const key = `${item._prefix}_${item._dateKey}_${item.id}`;
              const ph = processingHistoryMap.get(key) || [];
              const processedBy = getProcessedByAccount(ph);
              return !(processedBy && processedBy.toLowerCase() === fromAccount.toLowerCase());
            });
            
            if (uncompletedItems.length === 0) {
              alert('ì¬ë¶„ë°°í•  ê±´ì´ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            
            openBulkReassignModal(fromAccount, uncompletedItems, filterType);
          });
        });
      } catch (err) {
        if (targetResult) targetResult.innerHTML = '<div class="msg error">ì ‘ìˆ˜ê±´ ì¡°íšŒ ì‹¤íŒ¨: ' + escapeHtml(err.message || err) + '</div>';
      } finally {
        if (targetLoading) targetLoading.style.display = 'none';
        loadDistributionInProgress = false;
      }
    }

    // ìë™ ê· ë“± ë¶„ë°°
    async function autoDistribute(filterType) {
      if (allSubmissions.length === 0) {
        alert('ë¨¼ì € í•´ë‹¹ ìœ í˜•ì˜ ì ‘ìˆ˜ê±´ì„ ì¡°íšŒí•´ì£¼ì„¸ìš”.');
        return;
      }

      distributionHistoryMap = await loadDistributionHistoryFromFirebase();

      // ë“œë¡­ë‹¤ìš´ í•„í„°ì— ë”°ë¼ ë¯¸ë¶„ë°° ì ‘ìˆ˜ê±´ í•„í„°ë§
      const unassigned = allSubmissions.filter(item => {
        const key = `${item._prefix}_${item._dateKey}_${item.id}`;
        const history = distributionHistoryMap.get(key) || [];
        const isAssigned = Array.isArray(history) && history.length > 0;
        
        // í•„í„° íƒ€ì…ì— ë”°ë¼ í•„í„°ë§
        if (filterType === 'noCheck') {
          const isNotChecked = !item.refundDone && !item.exchangeDone;
          const isNotProofError = !item.proofError;
          return !isAssigned && isNotChecked && isNotProofError;
        } else if (filterType === 'proofError') {
          return !isAssigned && !!item.proofError;
        }
        return false;
      });

      if (unassigned.length === 0) {
        const filterLabel = filterType === 'noCheck' ? 'í™˜ë¶ˆ/êµí™˜ ë¯¸ì²´í¬' : 'ì¦ë¹™ì˜¤ë¥˜(ë°˜ë ¤)';
        alert('ë¶„ë°°í•  ì ‘ìˆ˜ê±´ì´ ì—†ìŠµë‹ˆë‹¤. (' + filterLabel + ' ê±´ë§Œ ë¶„ë°° ëŒ€ìƒì…ë‹ˆë‹¤)');
        return;
      }

      const accounts = Array.from(document.querySelectorAll('.dist-account-cb'))
        .filter((cb) => cb.checked)
        .map((cb) => cb.value);

      if (accounts.length === 0) {
        alert('ë¶„ë°°í•  ìƒë‹´ì‚¬ë¥¼ 1ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”. (ìœ„ ê³„ì • ì²´í¬ë°•ìŠ¤ì—ì„œ ì„ íƒ)');
        return;
      }

      const filterLabel = filterType === 'noCheck' ? 'í™˜ë¶ˆ/êµí™˜ ë¯¸ì²´í¬' : 'ì¦ë¹™ì˜¤ë¥˜(ë°˜ë ¤)';
      const msg = filterLabel + ' ë¯¸ë¶„ë°° ì ‘ìˆ˜ê±´ ' + unassigned.length + 'ê±´ì„ ì„ íƒí•œ ìƒë‹´ì‚¬ ' + accounts.length + 'ëª…ì—ê²Œ ê· ë“± ë¶„ë°°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
      
      if (!confirm(msg)) {
        return;
      }

      const perAccount = Math.floor(unassigned.length / accounts.length);
      const remainder = unassigned.length % accounts.length;

      let accountIndex = 0;
      let assignedCount = 0;

      unassigned.forEach((item, idx) => {
        const key = `${item._prefix}_${item._dateKey}_${item.id}`;
        const account = accounts[accountIndex];
        const category = item.proofError ? 'proofError' : 'noCheck';
        
        if (!distributionHistoryMap.has(key)) {
          distributionHistoryMap.set(key, []);
        }
        
        distributionHistoryMap.get(key).push({
          account: account,
          timestamp: Date.now(),
          type: 'assign',
          category: category // ì¹´í…Œê³ ë¦¬ ì •ë³´ ì €ì¥
        });

        assignedCount++;
        if (assignedCount >= perAccount + (accountIndex < remainder ? 1 : 0)) {
          accountIndex++;
          assignedCount = 0;
        }
      });

      const saved = await saveDistributionHistoryToFirebase(distributionHistoryMap);
      if (!saved) {
        alert('ë¶„ë°° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ë° Firebase ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        return;
      }
      alert('ê· ë“± ë¶„ë°°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      await loadDistribution(filterType);
    }

    // ë¶„ë°° ëª¨ë‹¬ ì—´ê¸°
    function openAssignModal(item, key, isReassign, category) {
      const categoryLabel = category === 'proofError' ? 'ì¦ë¹™ì˜¤ë¥˜(ë°˜ë ¤)' : 'í™˜ë¶ˆ/êµí™˜ ë¯¸ì²´í¬';
      assignModalInfo.innerHTML = 
        '<div style="margin-bottom: 16px; padding: 12px; background: #f9f9f9; border-radius: 6px;">' +
        '<strong>ê³ ê°:</strong> ' + escapeHtml(item.name || '-') + ' / ' + escapeHtml(item.contact || '-') + '<br>' +
        '<strong>ì ‘ìˆ˜ID:</strong> ' + escapeHtml(item.id) + '<br>' +
        '<strong>í”„ë¡œì íŠ¸:</strong> ' + PROJECT_LABELS[PREFIXES.indexOf(item._prefix)] + '<br>' +
        '<strong>ì¹´í…Œê³ ë¦¬:</strong> ' + categoryLabel +
        '</div>';
      
      assignAccountSelect.value = '';
      assignModal.setAttribute('data-key', key);
      assignModal.setAttribute('data-reassign', isReassign ? 'true' : 'false');
      assignModal.setAttribute('data-category', category || '');
      assignModal.classList.add('show');
    }

    function closeAssignModal() {
      assignModal.classList.remove('show');
      assignModal.removeAttribute('data-key');
    }

    // ë¶„ë°° í™•ì¸
    assignModalConfirmBtn.addEventListener('click', async () => {
      const key = assignModal.getAttribute('data-key');
      const account = assignAccountSelect.value;
      const isReassign = assignModal.getAttribute('data-reassign') === 'true';
      const category = assignModal.getAttribute('data-category') || '';

      if (!key || !account) {
        alert('ìƒë‹´ì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      distributionHistoryMap = await loadDistributionHistoryFromFirebase();
      if (!distributionHistoryMap.has(key)) {
        distributionHistoryMap.set(key, []);
      }

      distributionHistoryMap.get(key).push({
        account: account,
        timestamp: Date.now(),
        type: isReassign ? 'reassign' : 'assign',
        category: category // ì¹´í…Œê³ ë¦¬ ì •ë³´ ì €ì¥
      });

      await saveDistributionHistoryToFirebase(distributionHistoryMap);
      closeAssignModal();
      const cat = assignModal.getAttribute('data-category') || 'noCheck';
      loadDistribution(cat);
    });

    assignModalClose.addEventListener('click', closeAssignModal);
    assignModalCancelBtn.addEventListener('click', closeAssignModal);
    assignModal.addEventListener('click', (e) => {
      if (e.target === assignModal) closeAssignModal();
    });


    // ì„ íƒ ë¶„ë°° (í•´ë‹¹ ìœ í˜•ì˜ ë¶„ë°° í˜„í™© ëª¨ë‹¬)
    async function selectiveDistribute(filterType) {
      if (allSubmissions.length === 0) {
        alert('ë¨¼ì € í•´ë‹¹ ìœ í˜•ì˜ ì ‘ìˆ˜ê±´ì„ ì¡°íšŒí•´ì£¼ì„¸ìš”.');
        return;
      }

      distributionHistoryMap = await loadDistributionHistoryFromFirebase();
      await loadProcessingAndCounselingFromFirebase();
      
      const distributionMap = new Map();
      allSubmissions.forEach(item => {
        const key = `${item._prefix}_${item._dateKey}_${item.id}`;
        const history = distributionHistoryMap.get(key) || [];
        const latest = Array.isArray(history) && history.length > 0 ? history[history.length - 1] : null;
        if (latest && latest.category === filterType) {
          if (!distributionMap.has(latest.account)) {
            distributionMap.set(latest.account, []);
          }
          distributionMap.get(latest.account).push(item);
        }
      });

      if (distributionMap.size === 0) {
        const label = filterType === 'noCheck' ? 'í™˜ë¶ˆ/êµí™˜ ë¯¸ì²´í¬' : 'ì¦ë¹™ì˜¤ë¥˜(ë°˜ë ¤)';
        alert(label + ' ìœ í˜•ìœ¼ë¡œ ë¶„ë°°ëœ ì ‘ìˆ˜ê±´ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const filterLabel = filterType === 'noCheck' ? 'í™˜ë¶ˆ/êµí™˜ ë¯¸ì²´í¬' : 'ì¦ë¹™ì˜¤ë¥˜(ë°˜ë ¤)';
      // ë¶„ë°° í˜„í™© ëª¨ë‹¬ í‘œì‹œ
      let modalHtml = '<div style="max-height: 60vh; overflow-y: auto;">';
      modalHtml += '<table class="stats-table" style="width: 100%;">';
      modalHtml += '<thead><tr>';
        modalHtml += '<th>ìƒë‹´ì‚¬</th>';
        modalHtml += '<th>ë¶„ë°° ê±´ìˆ˜</th>';
        modalHtml += '<th>ì²˜ë¦¬ì™„ë£Œ</th>';
        modalHtml += '<th>ë¯¸ì²˜ë¦¬</th>';
        modalHtml += '<th>ì¬ë¶„ë°°</th>';
        modalHtml += '<th>íšŒìˆ˜</th>';
        modalHtml += '</tr></thead><tbody>';

      distributionMap.forEach((items, account) => {
        const completedCount = items.filter(item => {
          const key = `${item._prefix}_${item._dateKey}_${item.id}`;
          const ph = processingHistoryMap.get(key) || [];
          const processedBy = getProcessedByAccount(ph);
          return processedBy && processedBy.toLowerCase() === account.toLowerCase();
        }).length;
        const remainingCount = items.length - completedCount;

        modalHtml += '<tr>';
        modalHtml += '<td class="text-left">' + escapeHtml(account) + '</td>';
        modalHtml += '<td class="number">' + items.length + '</td>';
        modalHtml += '<td class="number" style="color: #28a745;">' + completedCount + '</td>';
        modalHtml += '<td class="number" style="color: #dc3545;">' + remainingCount + '</td>';
        modalHtml += '<td>';
        if (remainingCount > 0) {
          modalHtml += '<button type="button" class="btn-reassign-bulk-modal" data-account="' + escapeHtml(account) + '" data-count="' + remainingCount + '" style="padding: 4px 12px; font-size: 12px; background: #17a; color: #fff; border: none; border-radius: 4px; cursor: pointer;">ì¬ë¶„ë°°</button>';
        } else {
          modalHtml += '-';
        }
        modalHtml += '</td>';
        modalHtml += '<td>';
        modalHtml += '<button type="button" class="btn-recall-modal" data-account="' + escapeHtml(account) + '" style="padding: 4px 12px; font-size: 12px; background: #dc3545; color: #fff; border: none; border-radius: 4px; cursor: pointer;">íšŒìˆ˜</button>';
        modalHtml += '</td>';
        modalHtml += '</tr>';
      });

      modalHtml += '</tbody></table>';
      modalHtml += '</div>';

      // ëª¨ë‹¬ í‘œì‹œ
      const modal = document.createElement('div');
      modal.className = 'modal-overlay show';
      modal.setAttribute('data-filter-type', filterType);
      modal.innerHTML = `
        <div class="modal-box">
          <div class="modal-header">
            <h3>${filterLabel} â€” í˜„ì¬ ë¶„ë°° í˜„í™©</h3>
            <button type="button" class="modal-close" id="selectiveModalClose">ë‹«ê¸°</button>
          </div>
          <div class="modal-body">
            ${modalHtml}
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // ëª¨ë‹¬ ë‹«ê¸°
      const closeBtn = modal.querySelector('#selectiveModalClose');
      const closeModal = () => {
        document.body.removeChild(modal);
      };
      closeBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      // ì¬ë¶„ë°° ë²„íŠ¼ ì´ë²¤íŠ¸
      modal.querySelectorAll('.btn-reassign-bulk-modal').forEach(btn => {
        btn.addEventListener('click', () => {
          const fromAccount = btn.getAttribute('data-account');
          const fromItems = distributionMap.get(fromAccount) || [];
          const uncompletedItems = fromItems.filter(item => {
            const key = `${item._prefix}_${item._dateKey}_${item.id}`;
            const ph = processingHistoryMap.get(key) || [];
            const processedBy = getProcessedByAccount(ph);
            return !(processedBy && processedBy.toLowerCase() === fromAccount.toLowerCase());
          });
          closeModal();
          openBulkReassignModal(fromAccount, uncompletedItems, filterType);
        });
      });

      // íšŒìˆ˜ ë²„íŠ¼ ì´ë²¤íŠ¸ (í•´ë‹¹ ìœ í˜•ë§Œ íšŒìˆ˜í•˜ë ¤ë©´ ë³„ë„ ë¡œì§ í•„ìš” - í˜„ì¬ëŠ” ì „ì²´ íšŒìˆ˜)
      modal.querySelectorAll('.btn-recall-modal').forEach(btn => {
        btn.addEventListener('click', () => {
          const account = btn.getAttribute('data-account');
          closeModal();
          if (account) recallDistributionByAccount(account);
        });
      });
    }

    // ëŒ€ëŸ‰ ì¬ë¶„ë°° ëª¨ë‹¬ (filterType: 'noCheck' | 'proofError' â€” ì™„ë£Œ í›„ í•´ë‹¹ ìœ í˜•ë§Œ ì¬ì¡°íšŒ)
    async function openBulkReassignModal(fromAccount, items, filterType) {
      const count = prompt(fromAccount + 'ì˜ ë¯¸ì²˜ë¦¬ ê±´ ' + items.length + 'ê±´ ì¤‘ ëª‡ ê±´ì„ ì¬ë¶„ë°°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
      const transferCount = parseInt(count) || 0;
      
      if (transferCount <= 0 || transferCount > items.length) {
        alert('ì˜¬ë°”ë¥¸ ê±´ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const toAccount = prompt('ì¬ë¶„ë°°í•  ìƒë‹´ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”:\n\n' +
        CS_ACCOUNTS.filter(e => e !== fromAccount).map((e, i) => (i + 1) + '. ' + e).join('\n') + '\n\nìƒë‹´ì‚¬ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”:');
      
      if (!toAccount || !CS_ACCOUNTS.includes(toAccount.trim()) || toAccount.trim() === fromAccount) {
        alert('ì˜¬ë°”ë¥¸ ìƒë‹´ì‚¬ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!confirm(fromAccount + 'ì˜ ë¯¸ì²˜ë¦¬ ê±´ ' + transferCount + 'ê±´ì„ ' + toAccount.trim() + 'ì—ê²Œ ì¬ë¶„ë°°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      // ì¬ë¶„ë°° ì²˜ë¦¬
      distributionHistoryMap = await loadDistributionHistoryFromFirebase();
      const itemsToTransfer = items.slice(0, transferCount);
      
      itemsToTransfer.forEach(item => {
        const key = `${item._prefix}_${item._dateKey}_${item.id}`;
        if (!distributionHistoryMap.has(key)) {
          distributionHistoryMap.set(key, []);
        }
        
        const category = item.proofError ? 'proofError' : 'noCheck';
        distributionHistoryMap.get(key).push({
          account: toAccount.trim(),
          timestamp: Date.now(),
          type: 'reassign',
          fromAccount: fromAccount,
          category: category
        });
      });

      await saveDistributionHistoryToFirebase(distributionHistoryMap);
      alert('ì¬ë¶„ë°°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      if (filterType) {
        await loadDistribution(filterType);
      } else {
        await loadDistribution('noCheck');
        await loadDistribution('proofError');
      }
    }

    // ìƒë‹´ì‚¬ë³„ ì”ì—¬ê±´ ì¡°íšŒ ë° ì´ê´€
    async function loadRemaining() {
      if (!db) {
        remainingResult.innerHTML = '<div class="msg error">Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      remainingLoading.style.display = 'block';
      remainingResult.innerHTML = '';

      try {
        distributionHistoryMap = await loadDistributionHistoryFromFirebase();
        await loadProcessingAndCounselingFromFirebase();

        // ì”ì—¬ê±´: í†µê³„ì™€ ë™ì¼í•œ ê¸°ì¤€ â€” ë¶„ë°° ì´ë ¥ ì „ì²´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ (ë‚ ì§œ ì œí•œ ì—†ìŒ)
        const allItems = [];
        for (const prefix of PREFIXES) {
          const snap = await get(dbRef(db, prefix + '/submissions_meta'));
          if (snap.exists()) {
            snap.forEach((dateSnap) => {
              const dateKey = dateSnap.key;
              if (!/^\d{8}$/.test(dateKey)) return;
              dateSnap.forEach((inner) => {
                const item = inner.val();
                allItems.push({
                  ...item,
                  _prefix: prefix,
                  id: inner.key,
                  _dateKey: dateKey
                });
              });
            });
          }
        }

        // ìƒë‹´ì‚¬ë³„ ì”ì—¬ê±´ ê³„ì‚° (í†µê³„ì™€ ë™ì¼: ë¶„ë°° ì´ë ¥ ì „ì²´, ì´/ë¯¸íŠ¹ì •/ì¦ë¹™ì˜¤ë¥˜)
        const accountRemaining = {};
        CS_ACCOUNTS.forEach(email => {
          accountRemaining[email] = {
            account: email,
            totalDist: 0, totalComplete: 0,
            noCheckDist: 0, noCheckComplete: 0,
            proofErrorDist: 0, proofErrorComplete: 0,
            remaining: 0,
            items: []
          };
        });

        allItems.forEach(item => {
          const key = `${item._prefix}_${item._dateKey}_${item.id}`;
          const history = distributionHistoryMap.get(key) || [];
          if (Array.isArray(history) && history.length > 0) {
            const latest = history[history.length - 1];
            const category = latest.category === 'proofError' ? 'proofError' : 'noCheck';
            const account = latest.account;
            if (accountRemaining[account]) {
              const acc = accountRemaining[account];
              acc.totalDist++;
              if (category === 'noCheck') acc.noCheckDist++; else acc.proofErrorDist++;
              acc.items.push({ ...item, _category: category });

              const ph = processingHistoryMap.get(key) || [];
              const processedBy = getProcessedByAccount(ph);
              const isCompleted = processedBy && processedBy.toLowerCase() === account.toLowerCase();
              if (isCompleted) {
                acc.totalComplete++;
                if (category === 'noCheck') acc.noCheckComplete++; else acc.proofErrorComplete++;
              } else {
                acc.remaining++;
              }
            }
          }
        });

        // ì”ì—¬ê±´ í‘œì‹œ (í†µê³„ì™€ ë™ì¼í•œ ì»¬ëŸ¼)
        let html = '<table class="stats-table">';
        html += '<thead><tr>';
        html += '<th>ìƒë‹´ì‚¬</th>';
        html += '<th>ì´ ë¶„ë°°</th><th>ì´ ì²˜ë¦¬ê±´</th>';
        html += '<th>ë¯¸íŠ¹ì • ë¶„ë°°ê±´</th><th>ë¯¸íŠ¹ì • ì²˜ë¦¬ê±´</th>';
        html += '<th>ì¦ë¹™ì˜¤ë¥˜ ì ‘ìˆ˜ê±´</th><th>ì¦ë¹™ì˜¤ë¥˜ ì²˜ë¦¬ê±´</th>';
        html += '<th>ì”ì—¬ê±´</th><th>ì²˜ë¦¬ìœ¨</th>';
        html += '<th>ì´ê´€</th><th>íšŒìˆ˜</th>';
        html += '</tr></thead><tbody>';

        Object.values(accountRemaining).forEach(stat => {
          const rate = stat.totalDist > 0 ? ((stat.totalComplete / stat.totalDist) * 100).toFixed(1) : '0.0';
          html += '<tr>';
          html += '<td class="text-left">' + escapeHtml(stat.account) + '</td>';
          html += '<td class="number">' + stat.totalDist + '</td>';
          html += '<td class="number">' + stat.totalComplete + '</td>';
          html += '<td class="number">' + stat.noCheckDist + '</td>';
          html += '<td class="number">' + stat.noCheckComplete + '</td>';
          html += '<td class="number">' + stat.proofErrorDist + '</td>';
          html += '<td class="number">' + stat.proofErrorComplete + '</td>';
          html += '<td class="number">' + stat.remaining + '</td>';
          html += '<td class="number">' + rate + '%</td>';
          html += '<td>';
          if (stat.remaining > 0) {
            html += '<button type="button" class="btn-transfer-remaining" data-account="' + escapeHtml(stat.account) + '">ì´ê´€</button>';
          } else {
            html += '-';
          }
          html += '</td>';
          html += '<td>';
          if (stat.totalDist > 0) {
            html += '<button type="button" class="btn-recall-remaining" data-account="' + escapeHtml(stat.account) + '" style="padding: 4px 12px; font-size: 12px; background: #dc3545; color: #fff; border: none; border-radius: 4px; cursor: pointer;">íšŒìˆ˜</button>';
          } else {
            html += '-';
          }
          html += '</td>';
          html += '</tr>';
        });

        html += '</tbody></table>';
        remainingResult.innerHTML = html;

        // íšŒìˆ˜Â·ì´ê´€ ë²„íŠ¼ ì´ë²¤íŠ¸
        remainingResult.querySelectorAll('.btn-recall-remaining').forEach(btn => {
          btn.addEventListener('click', () => {
            const account = btn.getAttribute('data-account');
            if (account) recallDistributionByAccount(account);
          });
        });
        remainingResult.querySelectorAll('.btn-transfer-remaining').forEach(btn => {
          btn.addEventListener('click', () => {
            const fromAccount = btn.getAttribute('data-account');
            const remainingItems = accountRemaining[fromAccount].items.filter(item => {
              const key = `${item._prefix}_${item._dateKey}_${item.id}`;
              const ph = processingHistoryMap.get(key) || [];
              const processedBy = getProcessedByAccount(ph);
              return !(processedBy && processedBy.toLowerCase() === fromAccount.toLowerCase());
            });
            openTransferModal(fromAccount, remainingItems);
          });
        });
      } catch (err) {
        remainingResult.innerHTML = '<div class="msg error">ì”ì—¬ê±´ ì¡°íšŒ ì‹¤íŒ¨: ' + escapeHtml(err.message || err) + '</div>';
      } finally {
        remainingLoading.style.display = 'none';
      }
    }

    // ë¶„ë°° ì´ë ¥ ì¡°íšŒ (ë‚ ì§œë³„ ìƒì„¸)
    async function loadHistory() {
      if (!db) {
        statsResult.innerHTML = '<div class="msg error">Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      const useDateFilter = !(statsDateAllCb && statsDateAllCb.checked);
      const startDate = statsStartDate.value;
      const endDate = statsEndDate.value;
      const selectedAccount = historyAccountSelect ? historyAccountSelect.value : '';

      if (useDateFilter && (!startDate || !endDate)) {
        statsResult.innerHTML = '<div class="msg error">ì „ì²´ê°€ ì•„ë‹ ê²½ìš° ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
        return;
      }

      statsLoading.style.display = 'block';
      statsResult.innerHTML = '';
      if (downloadStatsBtn) downloadStatsBtn.style.display = 'none';

      try {
        let startTime = 0, endTime = Number.MAX_SAFE_INTEGER;
        if (useDateFilter && startDate && endDate) {
          startTime = new Date(startDate + 'T00:00:00').getTime();
          endTime = new Date(endDate + 'T23:59:59').getTime();
        }

        distributionHistoryMap = await loadDistributionHistoryFromFirebase();
        await loadProcessingAndCounselingFromFirebase();

        // ë‚ ì§œë³„Â·ìƒë‹´ì‚¬ë³„: ì´/ë¯¸íŠ¹ì •/ì¦ë¹™ì˜¤ë¥˜ ê°ê° ë¶„ë°°ê±´Â·ì²˜ë¦¬ê±´
        const historyByDate = {}; // dateKey -> account -> { totalDist, totalComplete, noCheckDist, noCheckComplete, proofErrorDist, proofErrorComplete }

        distributionHistoryMap.forEach((history, key) => {
          if (Array.isArray(history) && history.length > 0) {
            const latest = history[history.length - 1];
            const category = latest.category === 'proofError' ? 'proofError' : 'noCheck';
            const parts = key.split('_');
            const dateKey = parts[1];
            if (dateKey && /^\d{8}$/.test(dateKey)) {
              const y = dateKey.substring(0, 4), m = dateKey.substring(4, 6), d = dateKey.substring(6, 8);
              const itemDate = new Date(y + '-' + m + '-' + d + 'T00:00:00').getTime();
              if (itemDate >= startTime && itemDate <= endTime) {
                const account = latest.account;
                if (selectedAccount && account !== selectedAccount) return;

                if (!historyByDate[dateKey]) historyByDate[dateKey] = {};
                const acc = historyByDate[dateKey][account];
                const def = { totalDist: 0, totalComplete: 0, noCheckDist: 0, noCheckComplete: 0, proofErrorDist: 0, proofErrorComplete: 0 };
                const s = acc ? { ...acc } : { ...def };
                s.totalDist++;
                if (category === 'noCheck') s.noCheckDist++; else s.proofErrorDist++;

                const ph = processingHistoryMap.get(key) || [];
                const processedBy = getProcessedByAccount(ph);
                if (processedBy && processedBy.toLowerCase() === account.toLowerCase()) {
                  s.totalComplete++;
                  if (category === 'noCheck') s.noCheckComplete++; else s.proofErrorComplete++;
                }
                historyByDate[dateKey][account] = s;
              }
            }
          }
        });

        const rangeLabel = useDateFilter && startDate && endDate ? (' (' + startDate + ' ~ ' + endDate + ')') : ' (ì „ì²´)';
        const accountLabel = selectedAccount ? (' â€” ' + selectedAccount) : '';
        let html = '<table class="stats-table stats-history">';
        html += '<caption style="caption-side:top;text-align:left;font-weight:600;margin-bottom:8px;">ë‚ ì§œë³„ ìƒì„¸' + rangeLabel + accountLabel + '</caption>';
        html += '<thead><tr>';
        html += '<th>ë‚ ì§œ</th><th>ìƒë‹´ì‚¬</th>';
        html += '<th>ì´ ë¶„ë°°</th><th>ì´ ì²˜ë¦¬ê±´</th>';
        html += '<th>ë¯¸íŠ¹ì • ë¶„ë°°ê±´</th><th>ë¯¸íŠ¹ì • ì²˜ë¦¬ê±´</th>';
        html += '<th>ì¦ë¹™ì˜¤ë¥˜ ì ‘ìˆ˜ê±´</th><th>ì¦ë¹™ì˜¤ë¥˜ ì²˜ë¦¬ê±´</th>';
        html += '</tr></thead><tbody>';

        const sortedDates = Object.keys(historyByDate).sort().reverse();
        sortedDates.forEach(dateKey => {
          const y = dateKey.substring(0, 4), m = dateKey.substring(4, 6), d = dateKey.substring(6, 8);
          const dateStr = y + '-' + m + '-' + d;
          Object.keys(historyByDate[dateKey]).sort().forEach(account => {
            const s = historyByDate[dateKey][account];
            html += '<tr>';
            html += '<td>' + dateStr + '</td>';
            html += '<td class="text-left">' + escapeHtml(account) + '</td>';
            html += '<td class="number">' + s.totalDist + '</td>';
            html += '<td class="number">' + s.totalComplete + '</td>';
            html += '<td class="number">' + s.noCheckDist + '</td>';
            html += '<td class="number">' + s.noCheckComplete + '</td>';
            html += '<td class="number">' + s.proofErrorDist + '</td>';
            html += '<td class="number">' + s.proofErrorComplete + '</td>';
            html += '</tr>';
          });
        });
        html += '</tbody></table>';

        if (sortedDates.length === 0) {
          html = '<div class="msg info">ì¡°íšŒëœ ë¶„ë°° ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        }

        statsResult.innerHTML = html;
        if (downloadStatsBtn && sortedDates.length > 0) downloadStatsBtn.style.display = 'inline-block';
      } catch (err) {
        statsResult.innerHTML = '<div class="msg error">ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨: ' + escapeHtml(err.message || err) + '</div>';
      } finally {
        statsLoading.style.display = 'none';
      }
    }

    // ì´ê´€ ëª¨ë‹¬: ìœ í˜•ë³„ ê±´ìˆ˜ í‘œì‹œ í›„ í™•ì¸
    async function openTransferModal(fromAccount, items) {
      if (!items || items.length === 0) {
        alert('ì´ê´€í•  ì”ì—¬ê±´ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const noCheckCount = items.filter(i => i._category === 'noCheck').length;
      const proofErrorCount = items.filter(i => i._category === 'proofError').length;
      let breakdownMsg = '';
      if (noCheckCount > 0 && proofErrorCount > 0) {
        breakdownMsg = 'ë¯¸íŠ¹ì • ' + noCheckCount + 'ê±´, ì¦ë¹™ì˜¤ë¥˜(ë°˜ë ¤) ' + proofErrorCount + 'ê±´';
      } else if (noCheckCount > 0) {
        breakdownMsg = 'ë¯¸íŠ¹ì • ' + noCheckCount + 'ê±´';
      } else {
        breakdownMsg = 'ì¦ë¹™ì˜¤ë¥˜(ë°˜ë ¤) ' + proofErrorCount + 'ê±´';
      }

      if (!confirm(fromAccount + 'ì˜ ì”ì—¬ê±´ ì´ê´€\n\n' + breakdownMsg + ' (ì´ ' + items.length + 'ê±´)\n\nì´ê´€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      const account = prompt('ì´ê´€í•  ìƒë‹´ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”:\n\n' +
        CS_ACCOUNTS.filter(e => e !== fromAccount).map((e, i) => (i + 1) + '. ' + e).join('\n') + '\n\nìƒë‹´ì‚¬ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”:');
      
      if (!account || !CS_ACCOUNTS.includes(account.trim()) || account.trim() === fromAccount) {
        alert('ì˜¬ë°”ë¥¸ ìƒë‹´ì‚¬ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const toAccount = account.trim();
      if (!confirm(breakdownMsg + ' ì´ ' + items.length + 'ê±´ì„ ' + toAccount + 'ì—ê²Œ ì´ê´€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      distributionHistoryMap = await loadDistributionHistoryFromFirebase();
      items.forEach(item => {
        const key = `${item._prefix}_${item._dateKey}_${item.id}`;
        if (!distributionHistoryMap.has(key)) distributionHistoryMap.set(key, []);
        const category = item._category || (item.proofError ? 'proofError' : 'noCheck');
        distributionHistoryMap.get(key).push({
          account: toAccount,
          timestamp: Date.now(),
          type: 'reassign',
          fromAccount: fromAccount,
          category: category
        });
      });

      await saveDistributionHistoryToFirebase(distributionHistoryMap);
      alert('ì´ê´€ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      loadRemaining();
      await loadDistribution('noCheck');
      await loadDistribution('proofError');
    }


    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    // íƒ­ ì „í™˜
    document.querySelectorAll('.dashboard-tab').forEach((tab) => {
      tab.addEventListener('click', () => {
        const targetId = 'tab-' + tab.getAttribute('data-tab');
        document.querySelectorAll('.dashboard-tab').forEach((t) => t.classList.remove('active'));
        document.querySelectorAll('.dashboard-tab-content').forEach((c) => c.classList.remove('active'));
        tab.classList.add('active');
        const target = document.getElementById(targetId);
        if (target) target.classList.add('active');
      });
    });

    // í†µê³„ íƒ­: ë³´ê¸° ëª¨ë“œì— ë”°ë¼ loadStats ë˜ëŠ” loadHistory í˜¸ì¶œ
    if (loadStatsBtn) {
      loadStatsBtn.addEventListener('click', () => {
        const mode = statsViewMode ? statsViewMode.value : 'byAccount';
        if (mode === 'byDate') {
          loadHistory();
        } else {
          loadStats();
        }
      });
    }
    // ìœ í˜•ë³„ ë¶„ë°° ë²„íŠ¼ ì´ë²¤íŠ¸ (data-typeìœ¼ë¡œ noCheck / proofError êµ¬ë¶„)
    document.addEventListener('click', (e) => {
      const type = e.target.closest('.load-dist-btn')?.getAttribute('data-type');
      if (type) { loadDistribution(type); return; }
      const autoType = e.target.closest('.auto-dist-btn')?.getAttribute('data-type');
      if (autoType) { autoDistribute(autoType); return; }
      const selType = e.target.closest('.select-dist-btn')?.getAttribute('data-type');
      if (selType) { selectiveDistribute(selType); return; }
    });
    if (resetDistributionBtn) resetDistributionBtn.addEventListener('click', resetDistribution);
    if (loadRemainingBtn) loadRemainingBtn.addEventListener('click', loadRemaining);

    // CSV ë‹¤ìš´ë¡œë“œ
    if (downloadStatsBtn) {
      downloadStatsBtn.addEventListener('click', () => {
        const table = statsResult.querySelector('.stats-table');
        if (!table) {
          alert('ë¨¼ì € í†µê³„ë¥¼ ì¡°íšŒí•´ì£¼ì„¸ìš”.');
          return;
        }

        const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.replace(/\s/g, '').trim());
        let csv = headers.map(h => `"${h}"`).join(',') + '\n';

        table.querySelectorAll('tbody tr').forEach(row => {
          const cells = Array.from(row.querySelectorAll('td')).map(c => c.textContent.trim());
          if (cells.length > 0) csv += cells.map(v => `"${v}"`).join(',') + '\n';
        });

        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        const startDate = statsStartDate.value || 'ì „ì²´';
        const endDate = statsEndDate.value || 'ì „ì²´';
        link.setAttribute('download', `ì•„ì›ƒë°”ìš´ë“œ_ì‹¤ì í†µê³„_${startDate}_${endDate}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    }
  </script>
</body>
</html>
