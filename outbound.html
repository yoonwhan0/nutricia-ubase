<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì••íƒ€ë°€ ì•„ì›ƒë°”ìš´ë“œ ìƒë‹´ì› ì „ìš© í˜ì´ì§€</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .admin-wrap { max-width: 100%; margin: 0 auto; }
    .admin-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 12px; }
    .admin-header h1 { margin: 0; font-size: 18px; }
    .admin-table-wrapper { overflow-x: auto; margin-top: 12px; }
    .admin-table { width: 100%; border-collapse: collapse; font-size: 11px; }
    .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 2px 4px; text-align: left; vertical-align: middle; white-space: nowrap; }
    .admin-table th { background: #f0f0f0; position: sticky; top: 0; z-index: 1; }
    .admin-table .cell-text { display: inline-block; max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .admin-table .cell-seq { text-align: center; font-weight: 600; }
    .admin-table .cell-project { text-align: center; }
    .admin-pagination { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 8px; }
    .admin-page-info { font-size: 12px; color: #555; }
    .status-indicator { display: flex; align-items: center; gap: 6px; font-size: 12px; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; display: inline-block; }
    .status-dot.ok { background: #28a745; }
    .status-dot.off { background: #dc3545; }
    .btn-load { margin-bottom: 8px; }
    .cell-tooltip-bubble {
      position: fixed;
      z-index: 99999;
      max-width: 320px;
      padding: 10px 14px;
      background: #2d2d2d;
      color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      font-size: 12px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-break: break-word;
      pointer-events: none;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s ease, visibility 0.15s ease;
    }
    .cell-tooltip-bubble.show {
      opacity: 1;
      visibility: visible;
    }
    .admin-table .cell-text, .admin-table td[data-fulltext] { cursor: default; }
    .admin-search .btn,
    .admin-search a.btn {
      padding: 8px 14px;
      font-size: 13px;
      min-height: 36px;
      box-sizing: border-box;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      white-space: nowrap;
      border-radius: 6px;
      font-weight: 600;
    }
    .admin-search { align-items: center; }
    /* ì „ì²´í™”ë©´ ìƒì„¸ ëª¨ë‹¬ (ì‚¬ì§„ + ê³ ê°ì •ë³´/ì²´í¬) */
    .detail-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: rgba(0,0,0,0.6);
      overflow: auto;
      padding: 16px;
      box-sizing: border-box;
    }
    .detail-modal-overlay.show { display: block; }
    .detail-modal-box {
      max-width: 1100px;
      margin: 0 auto 24px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      overflow: hidden;
      min-height: 80vh;
      display: flex;
      flex-direction: column;
    }
    .detail-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 20px;
      background: #1a1a1a;
      color: #fff;
      font-size: 16px;
    }
    .detail-modal-close {
      padding: 8px 16px;
      background: #444;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .detail-modal-close:hover { background: #555; }
    .detail-modal-body {
      display: flex;
      flex: 1;
      flex-wrap: wrap;
      gap: 0;
    }
    .detail-modal-photos {
      flex: 1 1 420px;
      min-width: 280px;
      padding: 20px;
      border-right: 1px solid #e0e0e0;
      overflow: auto;
    }
    .detail-modal-photos h3 { margin: 0 0 12px 0; font-size: 14px; color: #333; }
    .detail-modal-photo-box { margin-bottom: 20px; }
    .detail-modal-photo-box .caption { font-size: 12px; color: #666; margin-bottom: 8px; }
    .detail-modal-photo-box img {
      max-width: 100%;
      max-height: 220px;
      cursor: pointer;
      display: block;
      border: 1px solid #eee;
      border-radius: 4px;
    }
    .detail-modal-photo-box .no-image { color: #999; font-size: 13px; }
    .detail-modal-info {
      flex: 1 1 380px;
      min-width: 280px;
      padding: 20px;
      overflow: auto;
    }
    .detail-modal-info h3 { margin: 0 0 12px 0; font-size: 14px; color: #333; border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; }
    .detail-modal-info .info-section { margin-bottom: 20px; }
    .detail-modal-info .info-row { margin-bottom: 8px; font-size: 13px; }
    .detail-modal-info .info-row strong { display: inline-block; width: 110px; color: #555; flex-shrink: 0; }
    .detail-modal-info .info-grid { display: grid; gap: 8px; }
    .detail-modal-info .product-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 8px; }
    .detail-modal-info .product-table th, .detail-modal-info .product-table td { border: 1px solid #e0e0e0; padding: 6px 8px; text-align: left; }
    .detail-modal-info .product-table th { background: #f5f5f5; font-weight: 600; }
    .detail-modal-info .product-table tr:nth-child(even) { background: #fafafa; }
    .detail-modal-flags { margin-top: 16px; }
    .detail-modal-flags .checkbox-group { display: flex; flex-wrap: wrap; gap: 16px 24px; margin: 12px 0; }
    .detail-modal-flags .checkbox-group label { display: inline-flex; align-items: center; font-size: 13px; cursor: pointer; margin: 0; }
    .detail-modal-flags .checkbox-group input[type="checkbox"] { margin-right: 6px; }
    .detail-modal-flags .status-readonly { font-size: 12px; color: #666; margin-top: 8px; padding: 8px 12px; background: #f9f9f9; border-radius: 4px; }
    .detail-modal-flags textarea {
      width: 100%;
      min-height: 80px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      margin-top: 8px;
      resize: vertical;
    }
    .processing-history { margin-top: 16px; padding-top: 16px; border-top: 1px solid #eee; }
    .processing-history h4 { margin: 0 0 8px 0; font-size: 13px; color: #333; }
    .processing-history-item { font-size: 12px; color: #666; margin-bottom: 6px; padding: 8px; background: #f9f9f9; border-radius: 4px; }
    .processing-history-item strong { color: #333; }
    .counseling-history-list { max-height: 120px; overflow-y: auto; margin-bottom: 12px; }
    .counseling-history-item { font-size: 12px; padding: 8px; background: #f0f7ff; border-radius: 4px; margin-bottom: 6px; border-left: 3px solid #17a; }
    /* ìƒë‹´ì´ë ¥ ì „ìš© ê°„ë‹¨í•œ ëª¨ë‹¬ */
    .counseling-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 10001;
      background: rgba(0,0,0,0.6);
      overflow: auto;
      padding: 20px;
      box-sizing: border-box;
      align-items: center;
      justify-content: center;
    }
    .counseling-modal-overlay.show { display: flex; }
    .counseling-modal-box {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      max-width: 600px;
      width: 100%;
      padding: 0;
      overflow: hidden;
    }
    .counseling-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: #1a1a1a;
      color: #fff;
      font-size: 16px;
    }
    .counseling-modal-close {
      padding: 6px 12px;
      background: #444;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .counseling-modal-close:hover { background: #555; }
    .counseling-modal-body {
      padding: 20px;
    }
    .counseling-modal-body h3 {
      margin: 0 0 12px 0;
      font-size: 15px;
      color: #333;
    }
    .counseling-modal-body textarea {
      width: 100%;
      min-height: 150px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      resize: vertical;
      font-family: inherit;
      box-sizing: border-box;
    }
    .counseling-modal-body .customer-info {
      font-size: 13px;
      color: #666;
      margin-bottom: 16px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 6px;
    }
    .counseling-modal-body .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      justify-content: flex-end;
    }
    .counseling-modal-body .btn {
      width: auto;
      margin: 0;
      padding: 10px 20px;
    }
  </style>
</head>
<body>
  <div id="cellTooltip" class="cell-tooltip-bubble" aria-hidden="true"></div>
  <div class="admin-lock-backdrop" id="adminLock">
    <div class="admin-lock-modal">
      <h2>ì•„ì›ƒë°”ìš´ë“œ ìƒë‹´ì› ì „ìš© í˜ì´ì§€</h2>
      <input type="email" class="admin-lock-input" id="adminEmail" placeholder="ì´ë©”ì¼" autocomplete="username">
      <input type="password" class="admin-lock-input" id="adminPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password">
      <div class="admin-lock-error" id="adminLockError"></div>
      <button type="button" class="btn btn-primary" id="adminUnlockBtn" style="width:100%;">ë¡œê·¸ì¸</button>
    </div>
  </div>

  <div class="admin-wrap">
    <div id="listView" style="display:none;">
      <div class="admin-header">
        <h1>ì••íƒ€ë°€ ì•„ì›ƒë°”ìš´ë“œ ìƒë‹´ì› ì „ìš© í˜ì´ì§€</h1>
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
          <span id="adminUserEmail" style="font-size: 12px; color: #666;"></span>
          <button type="button" class="btn" id="adminLogoutBtn" style="background: #666; color: #fff; font-size: 12px;">ë¡œê·¸ì•„ì›ƒ</button>
          <div class="status-indicator">
            <span class="status-dot" id="statusDotAdmin"></span>
            <span id="statusTextAdmin">ì„œë²„ ì—°ê²° í™•ì¸ ì¤‘â€¦</span>
          </div>
        </div>
      </div>
      <div class="detail-section" style="margin-bottom: 12px;">
        <h2 style="font-size: 14px; margin: 0 0 8px 0;">ì¡°íšŒ êµ¬ë¶„</h2>
        <div class="admin-search" style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 10px;">
          <label style="font-size: 12px;">êµ¬ë¶„:</label>
          <select id="viewFilterSelect" style="padding: 6px 8px; font-size: 12px;">
            <option value="noCallComplete">ìœ ì„ ì•ˆë‚´ ë¯¸ì™„ë£Œ (í•´ì•¼ í•  ì¼)</option>
            <option value="callComplete">ë‚´ê°€ ì²˜ë¦¬í•œ ê±´</option>
            <option value="finalUnreached">ìµœì¢…ë¯¸ì—°ê²°</option>
            <option value="all">ì „ì²´ (ë°°ì •ëœ ê±´)</option>
            <option value="proofError">ì¦ë¹™ì˜¤ë¥˜(ë°˜ë ¤)</option>
            <option value="noRefundExchange">í™˜ë¶ˆÂ·êµí™˜ ëª¨ë‘ ë¯¸ì²´í¬ (ì ‘ìˆ˜ì‹œ)</option>
          </select>
          <span id="csSectionSummary" style="font-size: 12px; font-weight: 600; color: #17a; margin-left: 12px;"></span>
        </div>
        <h2 style="font-size: 14px; margin: 0 0 8px 0;">ê³ ê° ì¡°íšŒ</h2>
        <div class="admin-search" style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
          <input type="text" id="searchName" placeholder="ì´ë¦„" style="padding: 6px 8px; font-size: 12px;">
          <input type="text" id="searchContact" placeholder="ì „í™”ë²ˆí˜¸" style="padding: 6px 8px; font-size: 12px;">
          <input type="text" id="searchCustoms" placeholder="í†µê´€ë²ˆí˜¸(ê°œì¸í†µê´€ë¶€í˜¸)" style="padding: 6px 8px; font-size: 12px;">
          <input type="text" id="searchUniqueCode" placeholder="ê³ ìœ ë²ˆí˜¸" style="padding: 6px 8px; font-size: 12px;">
          <button type="button" class="btn btn-primary" id="searchBtn" style="width: auto; margin-top: -1px;">ê²€ìƒ‰</button>
          <button type="button" class="btn" id="searchResetBtn" style="width: auto; background: #777; color: #fff;">ì´ˆê¸°í™”</button>
          <button type="button" class="btn" id="listRefreshBtn" style="width: auto; background: #0a5; color: #fff;">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>
      <div style="margin-bottom: 12px;">
        <p class="msg ubase-notice" style="background:#fff3cd; color:#856404; border-left:4px solid #ffc107;"><strong>ê³µì§€:</strong> ì•„ì›ƒë°”ìš´ë“œ ìƒë‹´ì› ì „ìš© í˜ì´ì§€ì…ë‹ˆë‹¤. ìœ ì„ ì•ˆë‚´ ì™„ë£Œ ì²´í¬ ë° ìƒë‹´ì´ë ¥ ê¸°ì¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
      </div>
      <div id="listMessage"></div>
      <div id="submissionList"></div>
    </div>
  </div>

  <!-- ì „ì²´í™”ë©´ ìƒì„¸ ëª¨ë‹¬: ì‚¬ì§„ + ê³ ê°ì •ë³´/ì²´í¬ -->
  <div id="detailModal" class="detail-modal-overlay" aria-hidden="true">
    <div class="detail-modal-box">
      <div class="detail-modal-header">
        <span id="detailModalTitle">ê³ ê° ìƒì„¸ Â· ì‚¬ì§„ ë³´ê¸°</span>
        <button type="button" class="detail-modal-close" id="detailModalClose">ë‹«ê¸°</button>
      </div>
      <div class="detail-modal-body">
        <div class="detail-modal-photos" id="detailModalPhotos">ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
        <div class="detail-modal-info" id="detailModalInfo">
          <div id="detailModalInfoRows"></div>
          <div class="detail-modal-flags" id="detailModalFlags"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ìƒë‹´ì´ë ¥ ì „ìš© ê°„ë‹¨í•œ ëª¨ë‹¬ -->
  <div id="counselingModal" class="counseling-modal-overlay" aria-hidden="true">
    <div class="counseling-modal-box">
      <div class="counseling-modal-header">
        <span id="counselingModalTitle">ìƒë‹´ì´ë ¥ ì…ë ¥</span>
        <button type="button" class="counseling-modal-close" id="counselingModalClose">ë‹«ê¸°</button>
      </div>
      <div class="counseling-modal-body">
        <div id="counselingModalCustomerInfo" class="customer-info"></div>
        <div id="counselingModalHistoryList" style="margin-bottom: 16px;"></div>
        <h3>ìƒˆ ìƒë‹´ì´ë ¥ ì…ë ¥</h3>
        <textarea id="counselingModalTextarea" placeholder="ìƒë‹´ì´ë ¥ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
        <div class="btn-group">
          <button type="button" class="btn" id="counselingModalCancelBtn" style="background: #777; color: #fff;">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" id="counselingModalSaveBtn">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getDatabase,
      ref as dbRef,
      get,
      child,
      onValue,
      update,
      push,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    // ì•„ì›ƒë°”ìš´ë“œ ìƒë‹´ì› ê³„ì • (cs1@ubase.co.kr ~ cs10@ubase.co.kr)
    const ALLOWED_EMAILS = [];
    for (let i = 1; i <= 10; i++) {
      ALLOWED_EMAILS.push(`cs${i}@ubase.co.kr`);
    }

    const PREFIXES = ['nutricia-x9fQ2kM7-1', 'nutricia-aL4pZ8Tq-2', 'nutricia-nu7VnCwR3H-3', 'nutricia-MK2rP9dS-4'];
    const PROJECT_LABELS = ['ì•„ì´ë² ', 'ë¦¼ì¸í„°ë„¤ì…”ë„', 'í¬ë¦°ë©', 'ëª°í…Œì¼'];
    const PHOTO_VIEW_URL = 'photo_view.html';

    const firebaseConfig = {
      apiKey: "AIzaSyCxNwnAzMn0JUkHGDXgY4taTPJYeABDohg",
      authDomain: "eibe-nutricia.firebaseapp.com",
      databaseURL: "https://eibe-nutricia-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "eibe-nutricia",
      storageBucket: "eibe-nutricia.firebasestorage.app",
      messagingSenderId: "605906618980",
      appId: "1:605906618980:web:d947540696a573c4856d71"
    };

    let app, db, auth;
    try {
      app = initializeApp(firebaseConfig);
      db = getDatabase(app);
      auth = getAuth(app);
    } catch (err) {
      console.error('Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:', err);
    }

    const adminLock = document.getElementById('adminLock');
    const adminEmailInput = document.getElementById('adminEmail');
    const adminKeyInput = document.getElementById('adminPassword');
    const adminLockError = document.getElementById('adminLockError');
    const adminUnlockBtn = document.getElementById('adminUnlockBtn');
    const adminLogoutBtn = document.getElementById('adminLogoutBtn');
    const adminUserEmailEl = document.getElementById('adminUserEmail');
    const listEl = document.getElementById('submissionList');
    const listView = document.getElementById('listView');
    const statusDotAdmin = document.getElementById('statusDotAdmin');
    const statusTextAdmin = document.getElementById('statusTextAdmin');
    const searchNameInput = document.getElementById('searchName');
    const searchContactInput = document.getElementById('searchContact');
    const searchCustomsInput = document.getElementById('searchCustoms');
    const searchBtn = document.getElementById('searchBtn');
    const searchResetBtn = document.getElementById('searchResetBtn');

    const PAGE_SIZE = 30;
    let allItems = [];
    let paginationPage = 1;
    let searchFilters = { name: '', contact: '', customsCode: '', uniqueCode: '' };
    let viewFilter = 'noCallComplete'; // ê¸°ë³¸: ìœ ì„ ì•ˆë‚´ ë¯¸ì™„ë£Œ (í•´ì•¼ í•  ì¼ ë¨¼ì €)
    let metaSnaps = {};
    let currentDetailData = null;
    let currentUserEmail = '';
    let isSigningOut = false; // ë¬´í•œ ë£¨í”„ ë°©ì§€ í”Œë˜ê·¸
    let lastCheckedEmail = ''; // ë§ˆì§€ë§‰ìœ¼ë¡œ í™•ì¸í•œ ì´ë©”ì¼ (ì¤‘ë³µ ì²´í¬ ë°©ì§€)
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€: ì²˜ë¦¬ë‚´ì—­ ë° ìƒë‹´ì´ë ¥ ì €ì¥ (ëª©ì—…ìš© - CS ê³„ì •ì´ ì‘ì„±)
    // key: `${prefix}_${dateKey}_${id}`
    // ì²˜ë¦¬ ë‚´ì—­ê³¼ ìƒë‹´ ì´ë ¥ì€ CS ê³„ì •ì´ ì‘ì„±í•˜ê³ , ëŒ€ì‹œë³´ë“œëŠ” ì½ê¸°ë§Œ í•¨
    async function loadProcessingHistoryFromFirebase() {
      if (!db) return;
      const procMap = new Map();
      try {
        for (const prefix of PREFIXES) {
          const procSnap = await get(dbRef(db, prefix + '/processing_history'));
          if (procSnap.exists()) {
            procSnap.forEach((dateSnap) => {
              const dateKey = dateSnap.key;
              if (!/^\d{8}$/.test(dateKey)) return;
              dateSnap.forEach((idSnap) => {
                const id = idSnap.key;
                const arr = [];
                idSnap.forEach((child) => arr.push(child.val()));
                if (arr.length) procMap.set(`${prefix}_${dateKey}_${id}`, arr.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)));
              });
            });
          }
        }
        processingHistoryMap = procMap;
      } catch (err) {
        console.error('ì²˜ë¦¬ë‚´ì—­ ë¡œë“œ ì˜¤ë¥˜:', err);
      }
    }

    const DISTRIBUTION_PATH = 'outbound_distribution/assignments';
    function ensureHistoryArray(val) {
      if (Array.isArray(val)) return val;
      if (val && typeof val === 'object') return Object.keys(val).sort((a, b) => Number(a) - Number(b)).map(k => val[k]);
      return [];
    }
    // ë¶„ë°° ì´ë ¥: Firebaseì—ì„œ ë¡œë“œ (ëŒ€ì‹œë³´ë“œê°€ ê´€ë¦¬, CSëŠ” ì½ê¸°ë§Œ)
    async function loadDistributionHistoryFromFirebase() {
      if (!db) return new Map();
      try {
        const snap = await get(dbRef(db, DISTRIBUTION_PATH));
        if (!snap.exists()) return new Map();
        const data = snap.val();
        if (!data || typeof data !== 'object') return new Map();
        const map = new Map();
        Object.entries(data).forEach(([k, v]) => map.set(k, ensureHistoryArray(v)));
        return map;
      } catch (e) {
        console.error('ë¶„ë°° ì´ë ¥ ë¡œë“œ ì˜¤ë¥˜:', e);
        return new Map();
      }
    }

    let processingHistoryMap = new Map();
    let distributionHistoryMap = new Map();

    // ìœ ì„ ì•ˆë‚´ì™„ë£Œ ì—¬ë¶€: processing historyì—ì„œ ìµœì‹  ë³€ê²½ ê¸°ì¤€ (ì²´í¬â†’í•´ì œ ì‹œ í˜„ì¬ ë¯¸ì™„ë£Œë¡œ íŒì •)
    function isCallCompleteForKey(processingHistory) {
      if (!Array.isArray(processingHistory) || processingHistory.length === 0) return false;
      const sorted = [...processingHistory].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      for (const h of sorted) {
        if (h.changes && typeof h.changes === 'string') {
          if (h.changes.includes('ìœ ì„ ì•ˆë‚´ì™„ë£Œ: ì²´í¬')) return true;
          if (h.changes.includes('ìœ ì„ ì•ˆë‚´ì™„ë£Œ: í•´ì œ')) return false;
        }
      }
      return false;
    }
    // ìµœì¢…ë¯¸ì—°ê²° ì—¬ë¶€: processing historyì—ì„œ ìµœì‹  ë³€ê²½ ê¸°ì¤€
    function isFinalUnreachedForKey(processingHistory) {
      if (!Array.isArray(processingHistory) || processingHistory.length === 0) return false;
      const sorted = [...processingHistory].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      for (const h of sorted) {
        if (h.changes && typeof h.changes === 'string') {
          if (h.changes.includes('ìµœì¢…ë¯¸ì—°ê²°: ì²´í¬')) return true;
          if (h.changes.includes('ìµœì¢…ë¯¸ì—°ê²°: í•´ì œ')) return false;
        }
      }
      return false;
    }
    // ìœ ì„ ì•ˆë‚´ì™„ë£Œ ì²´í¬í•œ ìƒë‹´ì‚¬(ì²˜ë¦¬í•œ ì‚¬ëŒ) ë°˜í™˜. ì²´í¬ëœ ê²½ìš° í•´ë‹¹ account, ë¯¸ì²´í¬ë©´ null
    function getProcessedByAccount(processingHistory) {
      if (!Array.isArray(processingHistory) || processingHistory.length === 0) return null;
      const sorted = [...processingHistory].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      for (const h of sorted) {
        if (h.changes && typeof h.changes === 'string') {
          if (h.changes.includes('ìœ ì„ ì•ˆë‚´ì™„ë£Œ: ì²´í¬')) return (h.account || '').trim() || null;
          if (h.changes.includes('ìœ ì„ ì•ˆë‚´ì™„ë£Œ: í•´ì œ')) return null;
        }
      }
      return null;
    }

    function normalizePhone(v) {
      return (v || '').replace(/\D/g, '');
    }
    function contactMatches(storedContact, searchContact) {
      const s = normalizePhone(storedContact);
      const q = normalizePhone(searchContact);
      if (!q) return true;
      if (!s) return false;
      return s === q || s === '82' + q || s.replace(/^82/, '') === q;
    }

    let statusTimeout = null;
    let lastConnectedState = true;
    
    function setStatus(connected) {
      if (!statusDotAdmin || !statusTextAdmin) return;
      if (connected === lastConnectedState) return;
      lastConnectedState = connected;
      if (statusTimeout) {
        clearTimeout(statusTimeout);
        statusTimeout = null;
      }
      if (connected) {
        statusDotAdmin.classList.remove('ok', 'off');
        statusDotAdmin.classList.add('ok');
        statusTextAdmin.textContent = 'ì„œë²„ ì—°ê²° ì •ìƒ';
      } else {
        statusTimeout = setTimeout(() => {
          statusDotAdmin.classList.remove('ok', 'off');
          statusDotAdmin.classList.add('off');
          statusTextAdmin.textContent = 'ì„œë²„ ì—°ê²° ì•ˆ ë¨';
        }, 1000);
      }
    }

    if (db) {
      onValue(dbRef(db, '.info/connected'), (snap) => setStatus(snap.val() === true), () => setStatus(false));
    }

    function doLoad() {
      if (!db) {
        listEl.innerHTML = '<div class="msg error">Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      loadMetaOnce();
    }

    function showAdminUI(user) {
      if (adminLock) adminLock.style.display = 'none';
      listView.style.display = 'block';
      currentUserEmail = user.email || '';
      if (adminUserEmailEl) adminUserEmailEl.textContent = currentUserEmail;
      subscribeDistributionHistory();
      doLoad();
    }
    function showLoginUI() {
      if (adminLock) adminLock.style.display = 'flex';
      listView.style.display = 'none';
      if (adminLockError) adminLockError.textContent = '';
      if (distributionUnsubscribe) {
        distributionUnsubscribe();
        distributionUnsubscribe = null;
      }
    }

    onAuthStateChanged(auth, (user) => {
      if (!auth) return;
      if (isSigningOut) return; // signOut ì§„í–‰ ì¤‘ì´ë©´ ë¬´ì‹œ
      
      if (!user) {
        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
        if (currentUserEmail) {
          currentUserEmail = '';
          lastCheckedEmail = '';
          showLoginUI();
        }
        return;
      }
      
      const email = (user.email || '').trim().toLowerCase();
      
      // ê°™ì€ ì´ë©”ì¼ë¡œ ì´ë¯¸ ì²´í¬í–ˆë‹¤ë©´ ë¬´ì‹œ (ì¤‘ë³µ ì²´í¬ ë°©ì§€)
      if (email === lastCheckedEmail && currentUserEmail === email) {
        return;
      }
      
      lastCheckedEmail = email;
      const allowed = ALLOWED_EMAILS.some((e) => e.toLowerCase() === email);
      
      if (allowed) {
        showAdminUI(user);
      } else {
        // ê¶Œí•œì´ ì—†ëŠ” ê³„ì •ì´ë©´ ë¡œê·¸ì•„ì›ƒ
        isSigningOut = true;
        signOut(auth).then(() => {
          isSigningOut = false;
          currentUserEmail = '';
          lastCheckedEmail = '';
          showLoginUI();
          if (adminLockError) adminLockError.textContent = 'ì´ í˜ì´ì§€ì— ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ” ê³„ì •ì´ ì•„ë‹™ë‹ˆë‹¤.';
        }).catch(() => {
          isSigningOut = false;
        });
      }
    });

    function handleLogin() {
      const email = (adminEmailInput && adminEmailInput.value) ? adminEmailInput.value.trim() : '';
      const password = adminKeyInput ? adminKeyInput.value : '';
      if (!email || !password) {
        adminLockError.textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
        return;
      }
      adminLockError.textContent = '';
      adminUnlockBtn.disabled = true;
      signInWithEmailAndPassword(auth, email, password)
        .then(() => { adminUnlockBtn.disabled = false; })
        .catch((err) => {
          adminUnlockBtn.disabled = false;
          if (err.code === 'auth/invalid-credential' || err.code === 'auth/wrong-password' || err.code === 'auth/user-not-found') {
            adminLockError.textContent = 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
          } else {
            adminLockError.textContent = err.message || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
          }
        });
    }
    adminUnlockBtn.addEventListener('click', handleLogin);
    adminKeyInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleLogin(); });
    if (adminEmailInput) adminEmailInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleLogin(); });
    if (adminLogoutBtn) adminLogoutBtn.addEventListener('click', () => {
      isSigningOut = true;
      signOut(auth).then(() => {
        isSigningOut = false;
        currentUserEmail = '';
        showLoginUI();
      }).catch(() => {
        isSigningOut = false;
      });
    });

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && listView && listView.style.display !== 'none') {
        if (Object.keys(metaSnaps).length === 0) {
          loadMetaOnce();
        } else {
          renderTable();
        }
      }
    });

    // ëŒ€ì‹œë³´ë“œì—ì„œ ë¶„ë°° ì‹œ Firebase ì‹¤ì‹œê°„ ë°˜ì˜
    let distributionUnsubscribe = null;
    function subscribeDistributionHistory() {
      if (!db) return;
      if (distributionUnsubscribe) distributionUnsubscribe();
      distributionUnsubscribe = onValue(dbRef(db, DISTRIBUTION_PATH), (snap) => {
        if (!snap.exists()) {
          distributionHistoryMap = new Map();
        } else {
          const data = snap.val();
          distributionHistoryMap = new Map(Object.entries(data || {}));
        }
        if (listView && listView.style.display !== 'none' && Object.keys(metaSnaps).length === PREFIXES.length) {
          renderTable();
        }
      });
    }

    function formatDate(t) {
      if (!t) return '-';
      const d = typeof t === 'number' ? new Date(t) : new Date(t);
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0') + ' ' +
        String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
    }

    function escapeAttr(s) {
      if (s == null) return '';
      return String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function escapeHtml(s) {
      if (s == null) return '';
      return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function buildItemsFromMetaSnaps() {
      const items = [];
      PREFIXES.forEach((prefix, idx) => {
        const snap = metaSnaps[prefix];
        if (!snap || !snap.exists()) return;
        snap.forEach((dateSnap) => {
          const dateKey = dateSnap.key;
          if (!/^\d{8}$/.test(dateKey)) return;
          dateSnap.forEach((inner) => {
            items.push({
              _prefix: prefix,
              _projectIndex: idx + 1,
              id: inner.key,
              _dateKey: dateKey,
              _isLegacy: false,
              ...inner.val()
            });
          });
        });
      });
      items.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      const total = items.length;
      items.forEach((it, i) => { it._globalSeq = total - i; });
      return items;
    }

    function applyMetaAndRender() {
      if (Object.keys(metaSnaps).length !== PREFIXES.length) return;
      allItems = buildItemsFromMetaSnaps();
      paginationPage = 1;
      renderTable();
    }

    async function loadMetaOnce() {
      if (!db || !listEl) return;
      const refreshBtn = document.getElementById('listRefreshBtn');
      listEl.innerHTML = '<p class="msg info">4ê°œ í”„ë¡œì íŠ¸ ë°ì´í„° ë¡œë“œ ì¤‘â€¦</p>';
      if (refreshBtn) refreshBtn.disabled = true;
      metaSnaps = {};
      try {
        for (const prefix of PREFIXES) {
          const snap = await get(dbRef(db, prefix + '/submissions_meta'));
          metaSnaps[prefix] = snap;
        }
        distributionHistoryMap = await loadDistributionHistoryFromFirebase();
        await loadProcessingHistoryFromFirebase();
        applyMetaAndRender();
      } catch (err) {
        listEl.innerHTML = '<p class="msg error">ë¡œë“œ ì‹¤íŒ¨: ' + (err.message || err) + '</p>';
      }
      if (refreshBtn) refreshBtn.disabled = false;
    }

    function isCsAccount() {
      return !!(currentUserEmail && ALLOWED_EMAILS.some(e => e.toLowerCase() === currentUserEmail.toLowerCase()));
    }
    function getMyAssignedItems() {
      return allItems.filter((d) => {
        const key = `${d._prefix}_${d._dateKey || ''}_${d.id}`;
        const history = distributionHistoryMap.get(key) || [];
        if (!Array.isArray(history) || history.length === 0) return false;
        const latest = history[history.length - 1];
        return latest && latest.account && latest.account.toLowerCase() === currentUserEmail.toLowerCase();
      });
    }
    function getMyUnprocessedItems() {
      return getMyAssignedItems().filter((d) => {
        const key = `${d._prefix}_${d._dateKey || ''}_${d.id}`;
        const ph = processingHistoryMap.get(key) || [];
        return !(ph.length > 0 ? isCallCompleteForKey(ph) : !!d.callComplete);
      });
    }
    function getMyProcessedItems() {
      const email = (currentUserEmail || '').toLowerCase();
      if (!email) return [];
      return getMyAssignedItems().filter((d) => {
        const key = `${d._prefix}_${d._dateKey || ''}_${d.id}`;
        const ph = processingHistoryMap.get(key) || [];
        const processedBy = getProcessedByAccount(ph);
        return processedBy && processedBy.toLowerCase() === email;
      });
    }

    function getFilteredItems() {
      let base = allItems;
      
      // ì•„ì›ƒë°”ìš´ë“œ ìƒë‹´ì›ì€ ë³¸ì¸ì—ê²Œ ë¶„ë°°ëœ ê±´ë§Œ ë³´ì—¬ì•¼ í•¨ (distributionHistoryMapì€ Firebaseì—ì„œ ë¡œë“œ/ì‹¤ì‹œê°„ ê°±ì‹ )
      if (isCsAccount()) {
        base = getMyAssignedItems();
      }

      // processing history ê¸°ë°˜ íŒì • (Firebaseì—ì„œ ë¡œë“œ)
      if (viewFilter !== 'all') {
        if (viewFilter === 'proofError') {
          base = base.filter((d) => !!d.proofError);
        } else if (viewFilter === 'noRefundExchange') {
          base = base.filter((d) => !d.refundDone && !d.exchangeDone);
        } else if (viewFilter === 'noCallComplete') {
          if (isCsAccount()) {
            base = getMyUnprocessedItems();
          } else {
            base = base.filter((d) => {
              const key = `${d._prefix}_${d._dateKey || ''}_${d.id}`;
              const ph = processingHistoryMap.get(key) || [];
              const complete = ph.length > 0 ? isCallCompleteForKey(ph) : (!!d.callComplete);
              return !complete;
            });
          }
        } else if (viewFilter === 'callComplete') {
          if (isCsAccount()) {
            base = getMyProcessedItems();
          } else {
            base = base.filter((d) => {
              const key = `${d._prefix}_${d._dateKey || ''}_${d.id}`;
              const ph = processingHistoryMap.get(key) || [];
              const complete = ph.length > 0 ? isCallCompleteForKey(ph) : (!!d.callComplete);
              return complete;
            });
          }
        } else if (viewFilter === 'finalUnreached') {
          base = base.filter((d) => {
            const key = `${d._prefix}_${d._dateKey || ''}_${d.id}`;
            const ph = processingHistoryMap.get(key) || [];
            const unreached = ph.length > 0 ? isFinalUnreachedForKey(ph) : (!!d.finalUnreached);
            return unreached;
          });
        }
      }
      if (!searchFilters.name && !searchFilters.contact && !searchFilters.customsCode && !searchFilters.uniqueCode) return base;
      const nameKeyword = (searchFilters.name || '').trim().toLowerCase();
      const contactKeyword = (searchFilters.contact || '').trim();
      const customsKeyword = (searchFilters.customsCode || '').trim().toUpperCase();
      const uniqueCodeKeyword = (searchFilters.uniqueCode || '').trim();
      return base.filter((d) => {
        let ok = true;
        if (nameKeyword) ok = ok && (d.name || '').toLowerCase().includes(nameKeyword);
        if (contactKeyword) ok = ok && contactMatches(d.contact, searchFilters.contact);
        if (customsKeyword) ok = ok && (d.customsCode || '').toUpperCase().includes(customsKeyword);
        if (uniqueCodeKeyword) {
          const u = getUniqueCodesArray(d);
          const hasMatchingCode = u.some((uc) => {
            const code = (uc.uniqueCode || '').trim();
            return code && code.includes(uniqueCodeKeyword);
          });
          ok = ok && hasMatchingCode;
        }
        return ok;
      });
    }

    const searchUniqueCodeInput = document.getElementById('searchUniqueCode');
    
    if (searchBtn) searchBtn.addEventListener('click', () => {
      searchFilters = {
        name: (searchNameInput && searchNameInput.value) ? searchNameInput.value.trim() : '',
        contact: (searchContactInput && searchContactInput.value) ? searchContactInput.value.trim() : '',
        customsCode: (searchCustomsInput && searchCustomsInput.value) ? searchCustomsInput.value.trim() : '',
        uniqueCode: (searchUniqueCodeInput && searchUniqueCodeInput.value) ? searchUniqueCodeInput.value.trim() : ''
      };
      paginationPage = 1;
      renderTable();
    });
    if (searchResetBtn) searchResetBtn.addEventListener('click', () => {
      if (searchNameInput) searchNameInput.value = '';
      if (searchContactInput) searchContactInput.value = '';
      if (searchCustomsInput) searchCustomsInput.value = '';
      if (searchUniqueCodeInput) searchUniqueCodeInput.value = '';
      searchFilters = { name: '', contact: '', customsCode: '', uniqueCode: '' };
      paginationPage = 1;
      renderTable();
    });
    const listRefreshBtn = document.getElementById('listRefreshBtn');
    if (listRefreshBtn) listRefreshBtn.addEventListener('click', () => loadMetaOnce());
    
    const viewFilterSelect = document.getElementById('viewFilterSelect');
    if (viewFilterSelect) {
      viewFilter = viewFilterSelect.value || 'noCallComplete';
      viewFilterSelect.addEventListener('change', () => {
        viewFilter = viewFilterSelect.value || 'noCallComplete';
        paginationPage = 1;
        renderTable();
      });
    }

    function getUniqueCodesArray(d) {
      let arr = d.uniqueCodesData;
      if (Array.isArray(arr)) return arr;
      const codes = Array.isArray(d.uniqueCodes) ? d.uniqueCodes : (d.uniqueCode ? [d.uniqueCode] : []);
      return codes.map(code => ({ productName: '', batchNumber: '', uniqueCode: code || '' }));
    }

    // ì²˜ë¦¬ë‚´ì—­ ê¸°ë¡ í•¨ìˆ˜ (Firebase ì €ì¥)
    async function addProcessingHistory(id, dateKey, prefix, changes) {
      if (!db || !currentUserEmail) return;
      const historyPath = prefix + '/processing_history/' + dateKey + '/' + id;
      const historyRef = dbRef(db, historyPath);
      const historyItem = {
        account: currentUserEmail,
        timestamp: Date.now(),
        changes: changes
      };
      try {
        await push(historyRef, historyItem);
      } catch (err) {
        console.error('ì²˜ë¦¬ë‚´ì—­ ê¸°ë¡ ì˜¤ë¥˜:', err);
      }
    }

    // ì²˜ë¦¬ë‚´ì—­ ë¡œë“œ í•¨ìˆ˜ (Firebaseì—ì„œ ë¡œë“œ)
    async function loadProcessingHistory(id, dateKey, prefix) {
      if (!db) return [];
      const historyPath = prefix + '/processing_history/' + dateKey + '/' + id;
      try {
        const snap = await get(dbRef(db, historyPath));
        if (!snap.exists()) return [];
        const history = [];
        snap.forEach((child) => {
          history.push(child.val());
        });
        return history.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      } catch (err) {
        console.error('ì²˜ë¦¬ë‚´ì—­ ë¡œë“œ ì˜¤ë¥˜:', err);
        return [];
      }
    }

    // ìƒë‹´ì´ë ¥ ì¶”ê°€ (Firebase submissions/submissions_metaì— ì €ì¥)
    async function addCounselingHistoryToFirebase(id, dateKey, prefix, content, isLegacy) {
      if (!db || !currentUserEmail || !content || !content.trim()) return;
      const subPath = isLegacy ? prefix + '/submissions/' + id : prefix + '/submissions/' + dateKey + '/' + id;
      const metaPath = dateKey ? prefix + '/submissions_meta/' + dateKey + '/' + id : '';
      try {
        const existingHistory = await loadCounselingHistory(id, dateKey, prefix);
        const newHistoryItem = { account: currentUserEmail, timestamp: Date.now(), content: content.trim() };
        const updatedHistory = [...existingHistory, newHistoryItem].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        await update(dbRef(db, subPath), { counselingHistory: updatedHistory });
        if (metaPath) await update(dbRef(db, metaPath), { counselingHistory: updatedHistory });
      } catch (err) {
        console.error('ìƒë‹´ì´ë ¥ ì €ì¥ ì˜¤ë¥˜:', err);
        throw err;
      }
    }

    // ìƒë‹´ì´ë ¥ ë¡œë“œ í•¨ìˆ˜ (Firebase submissions_metaì—ì„œ ë¡œë“œ)
    async function loadCounselingHistory(id, dateKey, prefix) {
      if (!db) return [];
      const metaPath = prefix + '/submissions_meta/' + dateKey + '/' + id;
      try {
        const snap = await get(dbRef(db, metaPath));
        if (!snap.exists()) return [];
        const data = snap.val();
        const hist = data.counselingHistory;
        return Array.isArray(hist) ? hist.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)) : [];
      } catch (err) {
        console.error('ìƒë‹´ì´ë ¥ ë¡œë“œ ì˜¤ë¥˜:', err);
        return [];
      }
    }

    function renderTable() {
      const filteredItems = getFilteredItems();
      if (!filteredItems.length) {
        listEl.innerHTML = '<p class="msg info">' + (allItems.length ? 'ì¡°ê±´ì— ë§ëŠ” ì ‘ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ì ‘ìˆ˜ëœ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.') + '</p>';
        return;
      }
      const total = filteredItems.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if (paginationPage < 1) paginationPage = 1;
      if (paginationPage > totalPages) paginationPage = totalPages;
      const start = (paginationPage - 1) * PAGE_SIZE;
      const pageItems = filteredItems.slice(start, start + PAGE_SIZE);

      const headerRow =
        '<th class="cell-seq">ìˆœë²ˆ</th>' +
        '<th class="cell-project">ì ‘ìˆ˜ê²½ë¡œ</th>' +
        '<th>ì´ë¦„</th><th>ì—°ë½ì²˜</th><th>ì ‘ìˆ˜ì¼ì‹œ</th>' +
        '<th>ìƒì„¸</th>';

      let rowsHtml = '';
      pageItems.forEach((d) => {
        const seq = d._globalSeq;
        const proj = PROJECT_LABELS[d._projectIndex - 1] || '';
        const prefix = d._prefix;
        const dateKey = d._dateKey || '';
        const isLegacy = !!d._isLegacy;

        rowsHtml += '<tr data-id="' + escapeAttr(d.id) + '" data-date-key="' + escapeAttr(dateKey) + '" data-legacy="' + (isLegacy ? '1' : '0') + '" data-prefix="' + escapeAttr(prefix) + '" data-project-index="' + d._projectIndex + '">';
        rowsHtml += '<td class="cell-seq">' + seq + '</td>';
        rowsHtml += '<td class="cell-project">' + proj + '</td>';
        rowsHtml += '<td><span class="cell-text">' + escapeHtml(d.name || '-') + '</span></td>';
        rowsHtml += '<td><span class="cell-text">' + escapeHtml(d.contact || '-') + '</span></td>';
        rowsHtml += '<td>' + formatDate(d.createdAt) + '</td>';
        rowsHtml += '<td><button type="button" class="btn btn-primary detail-modal-btn" style="font-size:11px;padding:2px 6px;">ìƒì„¸</button></td>';
        rowsHtml += '</tr>';
      });

      const tableHtml =
        '<div class="admin-table-wrapper">' +
          '<table class="admin-table">' +
            '<thead><tr>' + headerRow + '</tr></thead>' +
            '<tbody>' + rowsHtml + '</tbody>' +
          '</table>' +
        '</div>';
      const paginationHtml =
        '<div class="admin-pagination">' +
          '<button type="button" class="btn btn-primary admin-page-btn" data-page="' + (paginationPage - 1) + '" ' + (paginationPage <= 1 ? 'disabled' : '') + '>ì´ì „</button>' +
          '<span class="admin-page-info">í˜ì´ì§€ ' + paginationPage + ' / ' + totalPages + ' (ì´ ' + total + 'ê±´)</span>' +
          '<button type="button" class="btn btn-primary admin-page-btn" data-page="' + (paginationPage + 1) + '" ' + (paginationPage >= totalPages ? 'disabled' : '') + '>ë‹¤ìŒ</button>' +
          '<button type="button" class="btn btn-primary admin-page-btn" data-page="' + totalPages + '" ' + (paginationPage >= totalPages ? 'disabled' : '') + '>ë§ˆì§€ë§‰</button>' +
        '</div>';

      listEl.innerHTML = tableHtml + paginationHtml;
      const infoP = document.createElement('p');
      infoP.className = 'msg info';
      const filterLabels = { all: '', proofError: 'ì¦ë¹™ì˜¤ë¥˜(ë°˜ë ¤)', noRefundExchange: 'í™˜ë¶ˆÂ·êµí™˜ ë¯¸ì²´í¬', callComplete: 'ë‚´ê°€ ì²˜ë¦¬í•œ ê±´', noCallComplete: 'ìœ ì„ ì•ˆë‚´ ë¯¸ì™„ë£Œ', finalUnreached: 'ìµœì¢…ë¯¸ì—°ê²°' };
      const filterLabel = filterLabels[viewFilter] || '';
      const baseMsg = (searchFilters.name || searchFilters.contact || searchFilters.customsCode || searchFilters.uniqueCode) ? ('ê²€ìƒ‰ ê²°ê³¼ ' + total + 'ê±´ (ì „ì²´ ' + allItems.length + 'ê±´ ì¤‘)') : (filterLabel ? '[' + filterLabel + '] ' + total + 'ê±´' : 'ì „ì²´ ' + total + 'ê±´');
      infoP.textContent = baseMsg + ', í˜ì´ì§€ë‹¹ 30ê±´. ìƒì„¸ì—ì„œ ê³ ê°ì •ë³´Â·ì œí’ˆÂ·ì²´í¬ë°•ìŠ¤Â·ìƒë‹´ì´ë ¥Â·ì²˜ë¦¬ë‚´ì—­ í™•ì¸Â·ìˆ˜ì •.';
      listEl.insertBefore(infoP, listEl.firstChild);

      if (isCsAccount()) {
        const unproc = getMyUnprocessedItems();
        const proc = getMyProcessedItems();
        const csSummary = document.getElementById('csSectionSummary');
        if (csSummary) csSummary.textContent = 'ğŸ“‹ ë¯¸ì²˜ë¦¬ ' + unproc.length + 'ê±´ | âœ… ë‚´ê°€ ì²˜ë¦¬í•œ ê±´ ' + proc.length + 'ê±´';
      }

      listEl.querySelectorAll('.admin-page-btn').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const targetPage = Number(btn.getAttribute('data-page'));
          if (!targetPage || targetPage === paginationPage) return;
          paginationPage = targetPage;
          renderTable();
        });
      });

      attachDetailModalButtons();
    }

    function attachDetailModalButtons() {
      listEl.querySelectorAll('.detail-modal-btn').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const row = btn.closest('tr');
          if (!row) return;
          const id = row.getAttribute('data-id');
          const dateKey = row.getAttribute('data-date-key') || '';
          const prefix = row.getAttribute('data-prefix') || '';
          const d = allItems.find((it) => String(it.id) === String(id) && (it._dateKey || '') === dateKey && it._prefix === prefix);
          if (d) openDetailModal(d);
        });
      });
    }

    async function openCounselingModal(d) {
      if (!d) return;
      const modal = document.getElementById('counselingModal');
      const titleEl = document.getElementById('counselingModalTitle');
      const customerInfoEl = document.getElementById('counselingModalCustomerInfo');
      const historyListEl = document.getElementById('counselingModalHistoryList');
      const textareaEl = document.getElementById('counselingModalTextarea');
      
      titleEl.textContent = 'ìƒë‹´ì´ë ¥ ì…ë ¥ â€” ' + (d.name || d.contact || d.id || '');
      customerInfoEl.innerHTML = 
        '<strong>ì´ë¦„:</strong> ' + escapeHtml(d.name || '-') + ' | ' +
        '<strong>ì—°ë½ì²˜:</strong> ' + escapeHtml(d.contact || '-') + ' | ' +
        '<strong>ì ‘ìˆ˜ID:</strong> ' + escapeHtml(d.id || '-');
      
      // ê¸°ì¡´ ìƒë‹´ì´ë ¥ ë¡œë“œ ë° í‘œì‹œ
      await refreshCounselingHistoryList(d.id, d._dateKey || '', d._prefix || '');
      
      // ìƒˆ ì…ë ¥ì€ ë¹ˆ í…ìŠ¤íŠ¸ ì˜ì—­
      textareaEl.value = '';
      
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
      textareaEl.focus();
      
      attachCounselingModalListeners(d);
    }

    async function refreshCounselingHistoryList(id, dateKey, prefix) {
      const historyListEl = document.getElementById('counselingModalHistoryList');
      const history = await loadCounselingHistory(id, dateKey, prefix);
      
      if (history.length === 0) {
        historyListEl.innerHTML = '';
        return;
      }
      
      let historyHtml = '<div style="padding: 12px; background: #f9f9f9; border-radius: 6px; max-height: 200px; overflow-y: auto;">';
      historyHtml += '<h4 style="margin: 0 0 8px 0; font-size: 13px; color: #333;">ê¸°ì¡´ ìƒë‹´ì´ë ¥ (' + history.length + 'ê±´)</h4>';
      history.forEach((h, idx) => {
        historyHtml += '<div style="margin-bottom: 8px; padding: 8px; background: #fff; border-radius: 4px; border-left: 3px solid #2b3c90;">';
        historyHtml += '<div style="font-size: 11px; color: #666; margin-bottom: 4px;">';
        historyHtml += '<strong>' + formatDate(h.timestamp) + '</strong> - ' + escapeHtml(h.account);
        historyHtml += '</div>';
        historyHtml += '<div style="font-size: 13px; color: #333; white-space: pre-wrap;">' + escapeHtml(h.content) + '</div>';
        historyHtml += '</div>';
      });
      historyHtml += '</div>';
      historyListEl.innerHTML = historyHtml;
    }

    function closeCounselingModal() {
      const modal = document.getElementById('counselingModal');
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
    }

    function attachCounselingModalListeners(d) {
      const closeBtn = document.getElementById('counselingModalClose');
      const cancelBtn = document.getElementById('counselingModalCancelBtn');
      const saveBtn = document.getElementById('counselingModalSaveBtn');
      const modal = document.getElementById('counselingModal');
      const textareaEl = document.getElementById('counselingModalTextarea');
      
      // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
      const newCloseBtn = closeBtn.cloneNode(true);
      closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
      const newCancelBtn = cancelBtn.cloneNode(true);
      cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
      const newSaveBtn = saveBtn.cloneNode(true);
      saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
      
      document.getElementById('counselingModalClose').addEventListener('click', closeCounselingModal);
      document.getElementById('counselingModalCancelBtn').addEventListener('click', closeCounselingModal);
      document.getElementById('counselingModalSaveBtn').addEventListener('click', async () => {
        const counselingContent = textareaEl.value || '';
        if (!counselingContent.trim()) {
          alert('ìƒë‹´ì´ë ¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        const id = d.id;
        const dateKey = (d._dateKey || '').trim();
        const isLegacy = !!d._isLegacy;
        const prefix = (d._prefix || '').trim();
        if (!id || !prefix) return;
        if (!isLegacy && !dateKey) return;
        
        try {
          await addCounselingHistoryToFirebase(id, dateKey, prefix, counselingContent, isLegacy);
          await addProcessingHistory(id, dateKey, prefix, 'ìƒë‹´ì´ë ¥ ê¸°ì¬');
          await loadProcessingHistoryFromFirebase();
          alert('ìƒë‹´ì´ë ¥ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeCounselingModal();
          renderTable();
          textareaEl.value = '';
          await refreshCounselingHistoryList(id, dateKey, prefix);
          textareaEl.focus();
        } catch (err) {
          console.error('ì €ì¥ ì˜¤ë¥˜:', err);
          alert('ì €ì¥ ì‹¤íŒ¨: ' + (err.message || err));
        }
      });
      
      // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
      if (modal) {
        const handleBackgroundClick = (e) => {
          if (e.target === modal) {
            closeCounselingModal();
          }
        };
        modal.removeEventListener('click', handleBackgroundClick);
        modal.addEventListener('click', handleBackgroundClick);
      }
    }

    function getPhotoListFromData(d, singleKey, listKey) {
      if (!d) return [];
      if (Array.isArray(d[listKey])) return d[listKey];
      const single = d[singleKey];
      return single ? [single] : [];
    }

    async function openDetailModal(d) {
      if (!d || !db) return;
      currentDetailData = d;
      const modal = document.getElementById('detailModal');
      const titleEl = document.getElementById('detailModalTitle');
      const infoRowsEl = document.getElementById('detailModalInfoRows');
      const flagsEl = document.getElementById('detailModalFlags');
      titleEl.textContent = 'ê³ ê° ìƒì„¸ Â· ì‚¬ì§„ ë³´ê¸° â€” ' + (d.name || d.contact || d.id || '');

      // 1. ê³ ê° ì •ë³´
      let infoHtml = '<div class="info-section"><h3>ê³ ê° ì •ë³´</h3><div class="info-grid">';
      infoHtml += '<div class="info-row"><strong>ì´ë¦„</strong> ' + escapeHtml(d.name || '-') + '</div>';
      infoHtml += '<div class="info-row"><strong>ì—°ë½ì²˜</strong> ' + escapeHtml(d.contact || '-') + '</div>';
      infoHtml += '<div class="info-row"><strong>ì£¼ì†Œ</strong> ' + escapeHtml((d.address || '-') + ' ' + (d.addressDetail || '')) + '</div>';
      infoHtml += '<div class="info-row"><strong>ê°œì¸í†µê´€ë¶€í˜¸</strong> ' + escapeHtml(d.customsCode || '-') + '</div>';
      infoHtml += '<div class="info-row"><strong>ì€í–‰</strong> ' + escapeHtml(d.bankName || '-') + '</div>';
      infoHtml += '<div class="info-row"><strong>ê³„ì¢Œë²ˆí˜¸</strong> ' + escapeHtml(d.bankAccountNumber || '-') + '</div>';
      infoHtml += '<div class="info-row"><strong>ê³„ì¢Œëª…</strong> ' + escapeHtml(d.bankAccountName || '-') + '</div>';
      infoHtml += '<div class="info-row"><strong>ì ‘ìˆ˜ID</strong> ' + escapeHtml(d.id || '-') + '</div>';
      infoHtml += '<div class="info-row"><strong>ì ‘ìˆ˜ì¼ì‹œ</strong> ' + formatDate(d.createdAt) + '</div>';
      infoHtml += '</div></div>';

      const dmLocked = !!(d.refundComplete || d.exchangeComplete);
      // 2. ì œí’ˆ ë“±ë¡ (ì˜ëª»ëœì •ë³´ ì²´í¬ ì‹œ ê³ ìœ ë²ˆí˜¸/ì œì¡°ë²ˆí˜¸ ì¬ë“±ë¡ ê°€ëŠ¥, ë‹¤ë¥¸ ì–´ë“œë¯¼ê³¼ ë™ì¼)
      const products = getUniqueCodesArray(d);
      const canEditProducts = !!(d.invalidInfo && !dmLocked);
      if (products && products.length > 0) {
        infoHtml += '<div class="info-section"><h3>ì œí’ˆ ë“±ë¡</h3>';
        if (canEditProducts) {
          infoHtml += '<p style="font-size:12px;color:#666;margin-bottom:8px;">ì˜ëª»ëœì •ë³´ ê±´ â€” ê³ ìœ ë²ˆí˜¸Â·ì œì¡°ë²ˆí˜¸ ìˆ˜ì • í›„ ì €ì¥</p>';
        }
        infoHtml += '<table class="product-table"><thead><tr><th>ìˆœë²ˆ</th><th>ì œí’ˆëª…</th><th>ì œì¡°ë²ˆí˜¸</th><th>ê³ ìœ ë²ˆí˜¸</th></tr></thead><tbody>';
        products.forEach((p, idx) => {
          if (canEditProducts) {
            infoHtml += '<tr><td>' + (idx + 1) + '</td><td>' + escapeHtml(p.productName || '-') + '</td>' +
              '<td><input type="text" class="dm-product-batch" data-idx="' + idx + '" value="' + escapeAttr(p.batchNumber || '') + '" placeholder="ì œì¡°ë²ˆí˜¸" style="width:100%;padding:4px;"></td>' +
              '<td><input type="text" class="dm-product-unique" data-idx="' + idx + '" value="' + escapeAttr(p.uniqueCode || '') + '" placeholder="ê³ ìœ ë²ˆí˜¸" style="width:100%;padding:4px;"></td></tr>';
          } else {
            infoHtml += '<tr><td>' + (idx + 1) + '</td><td>' + escapeHtml(p.productName || '-') + '</td><td>' + escapeHtml(p.batchNumber || '-') + '</td><td>' + escapeHtml(p.uniqueCode || '-') + '</td></tr>';
          }
        });
        infoHtml += '</tbody></table>';
        if (canEditProducts) {
          infoHtml += '<button type="button" id="dm-save-products-btn" class="btn btn-primary" style="margin-top:8px;">ê³ ìœ ë²ˆí˜¸Â·ì œì¡°ë²ˆí˜¸ ì €ì¥</button>';
        }
        infoHtml += '</div>';
      }

      infoRowsEl.innerHTML = infoHtml;

      // 3. ì²´í¬ë°•ìŠ¤ + ìƒë‹´ì´ë ¥ + ì²˜ë¦¬ë‚´ì—­
      const rC = d.refundDone ? ' checked' : '';
      const eC = d.exchangeDone ? ' checked' : '';
      const iC = d.invalidInfo ? ' checked' : '';
      const dmLockedAttr = dmLocked ? ' disabled title="ì²˜ë¦¬ ì™„ë£Œ ê±´ â€” ìˆ˜ì • ë¶ˆê°€"' : '';

      const processingHistory = await loadProcessingHistory(d.id, d._dateKey || '', d._prefix || '');
      // ìœ ì„ ì•ˆë‚´ì™„ë£ŒÂ·ìµœì¢…ë¯¸ì—°ê²°: processing history ê¸°ì¤€ (ëª©ì—… ì‹œ ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ ìœ ì§€)
      const effectiveCallComplete = processingHistory.length > 0 ? isCallCompleteForKey(processingHistory) : (!!d.callComplete);
      const effectiveFinalUnreached = processingHistory.length > 0 ? isFinalUnreachedForKey(processingHistory) : (!!d.finalUnreached);
      const callC = effectiveCallComplete ? ' checked' : '';
      const finalUC = effectiveFinalUnreached ? ' checked' : '';
      d._effectiveCallComplete = effectiveCallComplete;
      d._effectiveFinalUnreached = effectiveFinalUnreached;
      const counselingHistory = await loadCounselingHistory(d.id, d._dateKey || '', d._prefix || '');

      let statusReadonly = [];
      if (d.refundComplete) statusReadonly.push('í™˜ë¶ˆì™„ë£Œ');
      if (d.exchangeComplete) statusReadonly.push('êµí™˜ì™„ë£Œ');
      if (d.evidenceError) statusReadonly.push('ì¦ë¹™ì˜¤ë¥˜');
      const statusReadonlyHtml = statusReadonly.length ? '<div class="status-readonly">' + statusReadonly.join(' Â· ') + '</div>' : '';

      let counselingHtml = '<div class="counseling-history-list" id="dm-counseling-history-list">';
      if (counselingHistory.length > 0) {
        counselingHistory.forEach((h) => {
          counselingHtml += '<div class="counseling-history-item"><strong>' + formatDate(h.timestamp) + '</strong> ' + escapeHtml(h.account) + '<br>' + escapeHtml(h.content) + '</div>';
        });
      } else {
        counselingHtml += '<div style="font-size:12px;color:#999;">ë“±ë¡ëœ ìƒë‹´ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      }
      counselingHtml += '</div>';

      let processingHtml = '';
      if (processingHistory.length > 0) {
        processingHtml = '<div class="processing-history"><h4>ì²˜ë¦¬ë‚´ì—­</h4>';
        processingHistory.forEach((h) => {
          processingHtml += '<div class="processing-history-item"><strong>' + formatDate(h.timestamp) + '</strong> - ' + escapeHtml(h.account) + '<br>' + escapeHtml(h.changes) + '</div>';
        });
        processingHtml += '</div>';
      }

      flagsEl.innerHTML =
        '<h3>ìƒíƒœ ì²´í¬</h3>' +
        (dmLocked ? '<p style="font-size:12px;color:#856404;margin-bottom:8px;">â€» í™˜ë¶ˆì™„ë£Œ/êµí™˜ì™„ë£Œ ê±´ â€” í™˜ë¶ˆÂ·êµí™˜Â·ì˜ëª»ëœì •ë³´ëŠ” ìˆ˜ì • ë¶ˆê°€</p>' : '') +
        '<p style="font-size:12px;color:#666;margin-bottom:8px;">ì—¬ëŸ¬ ê°œ ì²´í¬í•œ ë’¤ <strong>ì ìš©</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì €ì¥í•˜ì„¸ìš”.</p>' +
        '<div class="checkbox-group">' +
        '<label><input type="checkbox" id="dm-cb-refund" data-field="refundDone"' + rC + dmLockedAttr + '> í™˜ë¶ˆ</label>' +
        '<label><input type="checkbox" id="dm-cb-exchange" data-field="exchangeDone"' + eC + dmLockedAttr + '> êµí™˜</label>' +
        '<label><input type="checkbox" id="dm-cb-invalid" data-field="invalidInfo"' + iC + dmLockedAttr + '> ì˜ëª»ëœì •ë³´</label>' +
        '<label><input type="checkbox" id="dm-cb-callComplete" data-field="callComplete"' + callC + '> ìœ ì„ ì•ˆë‚´ì™„ë£Œ</label>' +
        '<label><input type="checkbox" id="dm-cb-finalUnreached" data-field="finalUnreached"' + finalUC + '> ìµœì¢…ë¯¸ì—°ê²°</label>' +
        '</div>' +
        '<button type="button" id="dm-apply-flags-btn" class="btn btn-primary" style="margin-top:12px;">ì ìš©</button>' +
        statusReadonlyHtml +
        '<h3 style="margin-top: 16px;">ìƒë‹´ì´ë ¥</h3>' +
        counselingHtml +
        '<textarea id="dm-counseling-history" placeholder="ìƒˆ ìƒë‹´ì´ë ¥ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>' +
        '<button type="button" class="btn btn-primary" id="dm-save-history-btn" style="width: auto; margin-top: 8px;">ìƒë‹´ì´ë ¥ ì €ì¥</button>' +
        processingHtml;

      document.getElementById('detailModalPhotos').textContent = 'ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
      loadDetailModalPhotos(d);
      attachDetailModalCheckboxListeners();
    }

    function closeDetailModal() {
      const modal = document.getElementById('detailModal');
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
      currentDetailData = null;
    }

    function loadDetailModalPhotos(d) {
      const prefix = d._prefix || '';
      const dateKey = d._dateKey || '';
      const id = d.id;
      const isLegacy = !!d._isLegacy;
      const subPath = isLegacy ? prefix + '/submissions/' + id : prefix + '/submissions/' + dateKey + '/' + id;
      const container = document.getElementById('detailModalPhotos');
      get(child(dbRef(db), subPath)).then(snap => {
        if (!snap.exists()) {
          container.innerHTML = '<p class="no-image">í•´ë‹¹ ì ‘ìˆ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        const data = snap.val();
        const p1List = getPhotoListFromData(data, 'photo1', 'photo1List');
        const p2List = getPhotoListFromData(data, 'photo2', 'photo2List');
        const p3List = getPhotoListFromData(data, 'photo3', 'photo3List');
        let html = '<div class="detail-modal-photo-box"><h3>1. êµ¬ë§¤ ì‹œ ì˜ìˆ˜ì¦</h3><div class="caption">ì—…ë¡œë“œëœ ì‚¬ì§„</div>';
        if (p1List.length) p1List.forEach((url) => { html += '<img src="' + url.replace(/"/g, '&quot;') + '" alt="ì˜ìˆ˜ì¦">'; });
        else html += '<div class="no-image">ì—†ìŒ</div>';
        html += '</div><div class="detail-modal-photo-box"><h3>2. ì œí’ˆ ì•ë©´</h3><div class="caption">ì—…ë¡œë“œëœ ì‚¬ì§„</div>';
        if (p2List.length) p2List.forEach((url) => { html += '<img src="' + url.replace(/"/g, '&quot;') + '" alt="ì œí’ˆ ì•ë©´">'; });
        else html += '<div class="no-image">ì—†ìŒ</div>';
        html += '</div><div class="detail-modal-photo-box"><h3>3. ì œí’ˆ ë’·ë©´/ë°”ë‹¥ë©´</h3><div class="caption">ì—…ë¡œë“œëœ ì‚¬ì§„</div>';
        if (p3List.length) p3List.forEach((url) => { html += '<img src="' + url.replace(/"/g, '&quot;') + '" alt="ì œí’ˆ ë’·ë©´">'; });
        else html += '<div class="no-image">ì—†ìŒ</div>';
        html += '</div>';
        container.innerHTML = html;
      }).catch(() => { container.innerHTML = '<p class="no-image">ì‚¬ì§„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>'; });
    }

    function attachDetailModalCheckboxListeners() {
      const flagsEl = document.getElementById('detailModalFlags');
      if (!flagsEl) return;
      const cbRefund = document.getElementById('dm-cb-refund');
      const cbExchange = document.getElementById('dm-cb-exchange');
      const cbInvalid = document.getElementById('dm-cb-invalid');
      const cbCallComplete = document.getElementById('dm-cb-callComplete');
      const cbFinalUnreached = document.getElementById('dm-cb-finalUnreached');
      const saveHistoryBtn = document.getElementById('dm-save-history-btn');
      
      const saveFromModal = async () => {
        const refundDone = !!cbRefund?.checked;
        const exchangeDone = !!cbExchange?.checked;
        const invalidInfo = !!cbInvalid?.checked;
        const callComplete = !!cbCallComplete?.checked;
        const finalUnreached = !!cbFinalUnreached?.checked;
        
        const d = currentDetailData;
        if (!d || !db) return;
        const id = d.id;
        const dateKey = (d._dateKey || '').trim();
        const isLegacy = !!d._isLegacy;
        const prefix = (d._prefix || '').trim();
        if (!id || !prefix) return;
        if (!isLegacy && !dateKey) return;
        
        const oldValues = {
          refundDone: d.refundDone || false,
          exchangeDone: d.exchangeDone || false,
          invalidInfo: d.invalidInfo || false,
          callComplete: (d._effectiveCallComplete !== undefined ? d._effectiveCallComplete : d.callComplete) || false,
          finalUnreached: (d._effectiveFinalUnreached !== undefined ? d._effectiveFinalUnreached : d.finalUnreached) || false
        };
        
        const newValues = { refundDone, exchangeDone, invalidInfo, callComplete, finalUnreached };
        const changes = [];
        if (oldValues.refundDone !== newValues.refundDone) changes.push('í™˜ë¶ˆ: ' + (newValues.refundDone ? 'ì²´í¬' : 'í•´ì œ'));
        if (oldValues.exchangeDone !== newValues.exchangeDone) changes.push('êµí™˜: ' + (newValues.exchangeDone ? 'ì²´í¬' : 'í•´ì œ'));
        if (oldValues.invalidInfo !== newValues.invalidInfo) changes.push('ì˜ëª»ëœì •ë³´: ' + (newValues.invalidInfo ? 'ì²´í¬' : 'í•´ì œ'));
        if (oldValues.callComplete !== newValues.callComplete) changes.push('ìœ ì„ ì•ˆë‚´ì™„ë£Œ: ' + (newValues.callComplete ? 'ì²´í¬' : 'í•´ì œ'));
        if (oldValues.finalUnreached !== newValues.finalUnreached) changes.push('ìµœì¢…ë¯¸ì—°ê²°: ' + (newValues.finalUnreached ? 'ì²´í¬' : 'í•´ì œ'));
        
        const subPath = isLegacy ? prefix + '/submissions/' + id : prefix + '/submissions/' + dateKey + '/' + id;
        const metaPath = dateKey ? (prefix + '/submissions_meta/' + dateKey + '/' + id) : '';
        
        const locked = !!(d.refundComplete || d.exchangeComplete);
        if (locked) {
          newValues.refundDone = oldValues.refundDone;
          newValues.exchangeDone = oldValues.exchangeDone;
          newValues.invalidInfo = oldValues.invalidInfo;
        }
        
        try {
          await update(dbRef(db, subPath), newValues);
          if (metaPath) await update(dbRef(db, metaPath), newValues);
          
          if (changes.length > 0) {
            await addProcessingHistory(id, dateKey, prefix, changes.join(', '));
          }
          
          const it = allItems.find((i) => String(i.id) === String(id) && (i._dateKey || '') === dateKey && i._prefix === prefix);
          if (it) {
            it.refundDone = newValues.refundDone;
            it.exchangeDone = newValues.exchangeDone;
            it.invalidInfo = newValues.invalidInfo;
            it.sixCansOrMore = newValues.sixCansOrMore;
            it.callComplete = newValues.callComplete;
            it.finalUnreached = newValues.finalUnreached;
          }
          
          await loadProcessingHistoryFromFirebase();
          alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeDetailModal();
          renderTable();
        } catch (err) {
          console.error('ì €ì¥ ì˜¤ë¥˜:', err);
          alert('ì €ì¥ ì‹¤íŒ¨: ' + (err.message || err));
        }
      };
      
      const applyBtn = document.getElementById('dm-apply-flags-btn');
      if (applyBtn) applyBtn.addEventListener('click', saveFromModal);

      const saveProductsBtn = document.getElementById('dm-save-products-btn');
      if (saveProductsBtn) {
        saveProductsBtn.addEventListener('click', async () => {
          const d = currentDetailData;
          if (!d || !db) return;
          const products = getUniqueCodesArray(d);
          const updated = products.map((p, idx) => {
            const batchIn = document.querySelector('.dm-product-batch[data-idx="' + idx + '"]');
            const uniqueIn = document.querySelector('.dm-product-unique[data-idx="' + idx + '"]');
            return {
              productName: p.productName || '',
              batchNumber: (batchIn && batchIn.value) ? batchIn.value.trim() : (p.batchNumber || ''),
              uniqueCode: (uniqueIn && uniqueIn.value) ? uniqueIn.value.trim() : (p.uniqueCode || '')
            };
          });
          const id = d.id;
          const dateKey = (d._dateKey || '').trim();
          const isLegacy = !!d._isLegacy;
          const prefix = (d._prefix || '').trim();
          if (!id || !prefix || (!isLegacy && !dateKey)) return;
          const subPath = isLegacy ? prefix + '/submissions/' + id : prefix + '/submissions/' + dateKey + '/' + id;
          const metaPath = dateKey ? (prefix + '/submissions_meta/' + dateKey + '/' + id) : '';
          try {
            await update(dbRef(db, subPath), { uniqueCodesData: updated });
            if (metaPath) await update(dbRef(db, metaPath), { uniqueCodesData: updated });
            const it = allItems.find((i) => String(i.id) === String(id) && (i._dateKey || '') === dateKey && i._prefix === prefix);
            if (it) it.uniqueCodesData = updated;
            await addProcessingHistory(id, dateKey, prefix, 'ê³ ìœ ë²ˆí˜¸Â·ì œì¡°ë²ˆí˜¸ ì¬ë“±ë¡');
            alert('ê³ ìœ ë²ˆí˜¸Â·ì œì¡°ë²ˆí˜¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeDetailModal();
            renderTable();
          } catch (err) {
            console.error('ì €ì¥ ì˜¤ë¥˜:', err);
            alert('ì €ì¥ ì‹¤íŒ¨: ' + (err.message || err));
          }
        });
      }
      
      if (saveHistoryBtn) {
        saveHistoryBtn.addEventListener('click', async () => {
          const content = (document.getElementById('dm-counseling-history')?.value || '').trim();
          const d = currentDetailData;
          if (!d || !db) return;
          if (!content) {
            alert('ìƒë‹´ì´ë ¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
          }
          const id = d.id;
          const dateKey = (d._dateKey || '').trim();
          const prefix = (d._prefix || '').trim();
          if (!id || !prefix) return;
          if (!d._isLegacy && !dateKey) return;

          await addCounselingHistoryToFirebase(id, dateKey, prefix, content, !!d._isLegacy);
          await addProcessingHistory(id, dateKey, prefix, 'ìƒë‹´ì´ë ¥ ê¸°ì¬');

          const listEl = document.getElementById('dm-counseling-history-list');
          if (listEl) {
            const history = await loadCounselingHistory(id, dateKey, prefix);
            let html = '';
            if (history.length > 0) {
              history.forEach((h) => {
                html += '<div class="counseling-history-item"><strong>' + formatDate(h.timestamp) + '</strong> ' + escapeHtml(h.account) + '<br>' + escapeHtml(h.content) + '</div>';
              });
            } else {
              html = '<div style="font-size:12px;color:#999;">ë“±ë¡ëœ ìƒë‹´ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
            listEl.innerHTML = html;
          }
          document.getElementById('dm-counseling-history').value = '';
          alert('ìƒë‹´ì´ë ¥ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
      }
    }

    (function initDetailModalClose() {
      const modal = document.getElementById('detailModal');
      const closeBtn = document.getElementById('detailModalClose');
      if (closeBtn) closeBtn.addEventListener('click', closeDetailModal);
      if (modal) modal.addEventListener('click', (e) => { if (e.target === modal) closeDetailModal(); });
    })();
  </script>
</body>
</html>
