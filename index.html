<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>압타밀 통합 접수 조회 (4개 사이트)</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .admin-wrap { max-width: 100%; margin: 0 auto; }
    .admin-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 12px; }
    .admin-header h1 { margin: 0; font-size: 18px; }
    .admin-table-wrapper { overflow-x: auto; margin-top: 12px; }
    .admin-table { width: 100%; border-collapse: collapse; font-size: 11px; }
    .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 2px 4px; text-align: left; vertical-align: middle; white-space: nowrap; }
    .admin-table th { background: #f0f0f0; position: sticky; top: 0; z-index: 1; }
    .admin-table .cell-text { display: inline-block; max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .admin-table .cell-seq { text-align: center; font-weight: 600; }
    .admin-table .cell-project { text-align: center; }
    .admin-pagination { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 8px; }
    .admin-page-info { font-size: 12px; color: #555; }
    .status-indicator { display: flex; align-items: center; gap: 6px; font-size: 12px; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; display: inline-block; }
    .status-dot.ok { background: #28a745; }
    .status-dot.off { background: #dc3545; }
    .btn-load { margin-bottom: 8px; }
    .cell-tooltip-bubble {
      position: fixed;
      z-index: 99999;
      max-width: 320px;
      padding: 10px 14px;
      background: #2d2d2d;
      color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      font-size: 12px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-break: break-word;
      pointer-events: none;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s ease, visibility 0.15s ease;
    }
    .cell-tooltip-bubble.show {
      opacity: 1;
      visibility: visible;
    }
    .cell-tooltip-bubble::after {
      content: '';
      position: absolute;
    }
    .admin-table .cell-text, .admin-table td[data-fulltext] { cursor: default; }

    /* 제조번호+고유번호 중복 강조 */
    .admin-table tr.row-has-duplicate { background-color: #ffe8e8 !important; }
    .admin-table tr.row-has-duplicate td.cell-duplicate-highlight {
      background-color: #ffcccc !important;
      background: #ffcccc !important;
    }

    /* 고객 조회 툴바 버튼 통일 (크기·정렬) */
    .admin-search .btn,
    .admin-search a.btn {
      padding: 8px 14px;
      font-size: 13px;
      min-height: 36px;
      box-sizing: border-box;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      white-space: nowrap;
      border-radius: 6px;
      font-weight: 600;
    }
    .admin-search { align-items: center; }

    /* 소비기한 확인 모달 */
    .expiry-modal {
      display: none;
      position: fixed;
      z-index: 10001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      overflow: auto;
    }
    .expiry-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .expiry-modal-content {
      background-color: #fff;
      border-radius: 8px;
      max-width: 90%;
      max-height: 90vh;
      position: relative;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    .expiry-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .expiry-modal-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    .expiry-modal-close {
      background: none;
      border: none;
      font-size: 28px;
      font-weight: 300;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .expiry-modal-close:hover {
      color: #333;
    }
    .expiry-modal-body {
      padding: 20px;
      text-align: center;
      overflow: auto;
      max-height: calc(90vh - 80px);
    }
    .expiry-modal-body img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
    }

    /* 전체화면 상세 모달 (사진 + 고객정보/체크) */
    .detail-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: rgba(0,0,0,0.6);
      overflow: auto;
      padding: 16px;
      box-sizing: border-box;
    }
    .detail-modal-overlay.show { display: block; }
    .detail-modal-box {
      max-width: 1100px;
      margin: 0 auto 24px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      overflow: hidden;
      min-height: 80vh;
      display: flex;
      flex-direction: column;
    }
    .detail-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 20px;
      background: #1a1a1a;
      color: #fff;
      font-size: 16px;
    }
    .detail-modal-close {
      padding: 8px 16px;
      background: #444;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .detail-modal-close:hover { background: #555; }
    .detail-modal-body {
      display: flex;
      flex: 1;
      flex-wrap: wrap;
      gap: 0;
    }
    .detail-modal-photos {
      flex: 1 1 420px;
      min-width: 280px;
      padding: 20px;
      border-right: 1px solid #e0e0e0;
      overflow: auto;
    }
    .detail-modal-photos h3 { margin: 0 0 12px 0; font-size: 14px; color: #333; }
    .detail-modal-photo-box { margin-bottom: 20px; }
    .detail-modal-photo-box .caption { font-size: 12px; color: #666; margin-bottom: 8px; }
    .detail-modal-photo-box img {
      max-width: 100%;
      max-height: 220px;
      cursor: pointer;
      display: block;
      border: 1px solid #eee;
      border-radius: 4px;
    }
    .detail-modal-photo-box .no-image { color: #999; font-size: 13px; }
    .detail-modal-info {
      flex: 1 1 380px;
      min-width: 280px;
      padding: 20px;
      overflow: auto;
    }
    .detail-modal-info h3 { margin: 0 0 12px 0; font-size: 14px; color: #333; }
    .detail-modal-info .info-row { margin-bottom: 10px; font-size: 13px; }
    .detail-modal-info .info-row strong { display: inline-block; width: 100px; color: #555; }
    .detail-modal-flags { margin-top: 20px; padding-top: 16px; border-top: 1px solid #eee; }
    .detail-modal-flags label { display: block; margin-bottom: 10px; font-size: 14px; cursor: pointer; }
    .detail-modal-flags input[type="checkbox"] { margin-right: 8px; }

    /* 사진 확대 라이트박스 */
    .photo-lightbox {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 11000;
      background: rgba(0,0,0,0.9);
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
      cursor: pointer;
    }
    .photo-lightbox.show { display: flex; }
    .photo-lightbox img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      pointer-events: none;
    }
    .photo-lightbox-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      line-height: 1;
      cursor: pointer;
      z-index: 1;
    }
    .photo-lightbox-close:hover { background: rgba(255,255,255,0.35); }
    .photo-lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 50px;
      height: 50px;
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      line-height: 1;
      cursor: pointer;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .photo-lightbox-nav:hover { background: rgba(255,255,255,0.35); }
    .photo-lightbox-nav.prev { left: 20px; }
    .photo-lightbox-nav.next { right: 20px; }
    .photo-lightbox-nav:disabled { opacity: 0.3; cursor: not-allowed; }
    .photo-lightbox-counter {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 1;
    }
  </style>
</head>
<body>
  <div id="cellTooltip" class="cell-tooltip-bubble" aria-hidden="true"></div>
  <div class="admin-lock-backdrop" id="adminLock">
    <div class="admin-lock-modal">
      <h2>통합 접수 조회 (관리자 전용)</h2>
      <input type="email" class="admin-lock-input" id="adminEmail" placeholder="이메일" autocomplete="username">
      <input type="password" class="admin-lock-input" id="adminPassword" placeholder="비밀번호" autocomplete="current-password">
      <div class="admin-lock-error" id="adminLockError"></div>
      <button type="button" class="btn btn-primary" id="adminUnlockBtn" style="width:100%;">로그인</button>
    </div>
  </div>

  <div class="admin-wrap">
    <div id="listView" style="display:none;">
      <div class="admin-header">
        <h1>압타밀 통합 접수 조회 (4개 사이트 · 조회 + 상태 체크만)</h1>
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
          <span id="adminUserEmail" style="font-size: 12px; color: #666;"></span>
          <button type="button" class="btn" id="adminLogoutBtn" style="background: #666; color: #fff; font-size: 12px;">로그아웃</button>
          <div class="status-indicator">
            <span class="status-dot" id="statusDotAdmin"></span>
            <span id="statusTextAdmin">서버 연결 확인 중…</span>
          </div>
        </div>
      </div>
      <div class="detail-section" style="margin-bottom: 12px;">
        <h2 style="font-size: 14px; margin: 0 0 8px 0;">조회 구분</h2>
        <div class="admin-search" style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 10px;">
          <label style="font-size: 12px;">구분:</label>
          <select id="viewFilterSelect" style="padding: 6px 8px; font-size: 12px;">
            <option value="all">전체</option>
            <option value="proofError">증빙오류(반려)</option>
            <option value="noRefundExchange">환불·교환 모두 미체크 (접수시)</option>
          </select>
          <span style="font-size: 11px; color: #666;">선택한 구분만 목록에 표시됩니다.</span>
        </div>
        <h2 style="font-size: 14px; margin: 0 0 8px 0;">고객 조회</h2>
        <div class="admin-search" style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
          <input type="text" id="searchName" placeholder="이름" style="padding: 6px 8px; font-size: 12px;">
          <input type="text" id="searchContact" placeholder="전화번호" style="padding: 6px 8px; font-size: 12px;">
          <input type="text" id="searchCustoms" placeholder="통관번호(개인통관부호)" style="padding: 6px 8px; font-size: 12px;">
          <input type="text" id="searchUniqueCode" placeholder="고유번호" style="padding: 6px 8px; font-size: 12px;">
          <button type="button" class="btn btn-primary" id="searchBtn" style="width: auto; margin-top: -1px;">검색</button>
          <button type="button" class="btn" id="searchResetBtn" style="width: auto; background: #777; color: #fff;">초기화</button>
          <button type="button" class="btn" id="listRefreshBtn" style="width: auto; background: #0a5; color: #fff;">목록 새로고침</button>
          <a href="dashboard.html" target="_blank" rel="noopener" class="btn" style="width: auto; background: #17a; color: #fff;">현황확인하기(대시보드)</a>
        </div>
      </div>
      <div class="detail-section" style="margin-bottom: 12px; padding: 12px; background: #f9f9f9; border-radius: 8px; border: 1px solid #ddd;">
        <h2 style="font-size: 14px; margin: 0 0 8px 0;">각 몰별 대상제품 소비기한 확인</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
          <button type="button" class="btn" data-expiry-site="0" style="background: #1a1a1a; color: #fff; font-size: 12px; padding: 8px 16px;">아이베 (1번) 소비기한 확인</button>
          <button type="button" class="btn" data-expiry-site="1" style="background: #1a1a1a; color: #fff; font-size: 12px; padding: 8px 16px;">림인터네셔널 (2번) 소비기한 확인</button>
          <button type="button" class="btn" data-expiry-site="2" style="background: #1a1a1a; color: #fff; font-size: 12px; padding: 8px 16px;">크린랩 (3번) 소비기한 확인</button>
          <button type="button" class="btn" data-expiry-site="3" style="background: #1a1a1a; color: #fff; font-size: 12px; padding: 8px 16px;">몰테일 (4번) 소비기한 확인</button>
        </div>
      </div>
      <div style="margin-bottom: 12px;">
        <p class="msg ubase-notice" style="background:#ffe0e0; color:#721c24; border-left:4px solid #dc3545; margin-bottom: 8px;"><strong>공지:</strong> 붉은음영 처리된 고객은 고유번호를 중복으로 업로드한 고객입니다. 업무에 참고 부탁드립니다.</p>
      </div>
      <div id="listMessage"></div>
      <p id="duplicateCountNotice" style="display:none; margin:8px 0; padding:8px 12px; background:#ffe0e0; color:#721c24; border-radius:6px; font-size:13px;"></p>
      <div id="submissionList"></div>
    </div>
  </div>

  <!-- 전체화면 상세 모달: 사진 + 고객정보/체크 -->
  <div id="detailModal" class="detail-modal-overlay" aria-hidden="true">
    <div class="detail-modal-box">
      <div class="detail-modal-header">
        <span id="detailModalTitle">고객 상세 · 사진 보기</span>
        <button type="button" class="detail-modal-close" id="detailModalClose">닫기</button>
      </div>
      <div class="detail-modal-body">
        <div class="detail-modal-photos" id="detailModalPhotos">사진 불러오는 중…</div>
        <div class="detail-modal-info" id="detailModalInfo">
          <h3>고객 정보</h3>
          <div id="detailModalInfoRows"></div>
          <div class="detail-modal-flags" id="detailModalFlags"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 사진 확대 라이트박스 (상세사진 클릭 시) -->
  <div id="photoLightbox" class="photo-lightbox" aria-hidden="true">
    <button type="button" class="photo-lightbox-close" id="photoLightboxClose" aria-label="닫기">&times;</button>
    <button type="button" class="photo-lightbox-nav prev" id="photoLightboxPrev" aria-label="이전 사진">‹</button>
    <button type="button" class="photo-lightbox-nav next" id="photoLightboxNext" aria-label="다음 사진">›</button>
    <img id="photoLightboxImg" src="" alt="확대 사진">
    <div class="photo-lightbox-counter" id="photoLightboxCounter" style="display: none;"></div>
  </div>

  <!-- 상담이력/처리내역 조회 모달 (읽기 전용) -->
  <div id="historyViewModal" class="detail-modal-overlay" aria-hidden="true">
    <div class="detail-modal-box" style="max-width: 560px;">
      <div class="detail-modal-header">
        <span id="historyViewModalTitle">상담이력 / 처리내역</span>
        <button type="button" class="detail-modal-close" id="historyViewModalClose">닫기</button>
      </div>
      <div class="detail-modal-body">
        <div id="historyViewModalContent" style="padding: 16px; max-height: 400px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>

  <!-- 소비기한 확인 모달 -->
  <div id="expiryModal" class="expiry-modal">
    <div class="expiry-modal-content">
      <div class="expiry-modal-header">
        <h2 id="expiryModalTitle">대상제품 소비기한 확인</h2>
        <button type="button" class="expiry-modal-close" id="expiryModalClose">&times;</button>
      </div>
      <div class="expiry-modal-body">
        <img id="expiryModalImg" src="" alt="회수제품 리스트">
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getDatabase,
      ref as dbRef,
      get,
      child,
      onValue,
      update
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    const ALLOWED_EMAILS = ['ubase@ubase.co.kr'];

    const PREFIXES = ['nutricia-x9fQ2kM7-1', 'nutricia-aL4pZ8Tq-2', 'nutricia-nu7VnCwR3H-3', 'nutricia-MK2rP9dS-4'];
    const PROJECT_LABELS = ['아이베', '림인터네셔널', '크린랩', '몰테일'];
    const PHOTO_VIEW_URL = 'photo_view.html';

    const firebaseConfig = {
      apiKey: "AIzaSyCxNwnAzMn0JUkHGDXgY4taTPJYeABDohg",
      authDomain: "eibe-nutricia.firebaseapp.com",
      databaseURL: "https://eibe-nutricia-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "eibe-nutricia",
      storageBucket: "eibe-nutricia.firebasestorage.app",
      messagingSenderId: "605906618980",
      appId: "1:605906618980:web:d947540696a573c4856d71"
    };

    let app, db, auth;
    try {
      app = initializeApp(firebaseConfig);
      db = getDatabase(app);
      auth = getAuth(app);
    } catch (err) {
      console.error('Firebase 초기화 오류:', err);
    }

    const adminLock = document.getElementById('adminLock');
    const adminEmailInput = document.getElementById('adminEmail');
    const adminKeyInput = document.getElementById('adminPassword');
    const adminLockError = document.getElementById('adminLockError');
    const adminUnlockBtn = document.getElementById('adminUnlockBtn');
    const adminLogoutBtn = document.getElementById('adminLogoutBtn');
    const adminUserEmailEl = document.getElementById('adminUserEmail');
    const listEl = document.getElementById('submissionList');
    const listView = document.getElementById('listView');
    const statusDotAdmin = document.getElementById('statusDotAdmin');
    const statusTextAdmin = document.getElementById('statusTextAdmin');
    const searchNameInput = document.getElementById('searchName');
    const searchContactInput = document.getElementById('searchContact');
    const searchCustomsInput = document.getElementById('searchCustoms');
    const searchBtn = document.getElementById('searchBtn');
    const searchResetBtn = document.getElementById('searchResetBtn');

    const PAGE_SIZE = 30;
    let allItems = [];
    let duplicateSubmissionIds = new Set(); // 중복된 고유번호를 가진 접수 ID Set
    let duplicateUniqueCodes = new Set(); // 다른 고객이 사용한 고유번호 Set
    let paginationPage = 1;
    let searchFilters = { name: '', contact: '', customsCode: '', uniqueCode: '' };
    let viewFilter = 'all'; // all | proofError | noRefundExchange
    let metaSnaps = {};
    let realtimeUnsub = [];
    let currentDetailData = null; // 모달에 열린 고객 데이터

    function normalizePhone(v) {
      return (v || '').replace(/\D/g, '');
    }
    function contactMatches(storedContact, searchContact) {
      const s = normalizePhone(storedContact);
      const q = normalizePhone(searchContact);
      if (!q) return true;
      if (!s) return false;
      return s === q || s === '82' + q || s.replace(/^82/, '') === q;
    }

    // 연결 상태 디바운싱: 짧은 연결 끊김은 무시 (1초 이상 끊겨야 비정상 표시)
    let statusTimeout = null;
    let lastConnectedState = true;
    
    function setStatus(connected) {
      if (!statusDotAdmin || !statusTextAdmin) return;
      
      // 연결 상태가 변경되었을 때만 처리
      if (connected === lastConnectedState) return;
      lastConnectedState = connected;
      
      // 기존 타이머 클리어
      if (statusTimeout) {
        clearTimeout(statusTimeout);
        statusTimeout = null;
      }
      
      if (connected) {
        // 연결됨: 즉시 정상 표시
        statusDotAdmin.classList.remove('ok', 'off');
        statusDotAdmin.classList.add('ok');
        statusTextAdmin.textContent = '서버 연결 정상';
      } else {
        // 연결 끊김: 1초 후에도 끊겨있으면 비정상 표시 (일시적 끊김 무시)
        statusTimeout = setTimeout(() => {
          statusDotAdmin.classList.remove('ok', 'off');
          statusDotAdmin.classList.add('off');
          statusTextAdmin.textContent = '서버 연결 안 됨';
        }, 1000);
      }
    }

    if (db) {
      onValue(dbRef(db, '.info/connected'), (snap) => setStatus(snap.val() === true), () => setStatus(false));
    }

    function doLoad() {
      if (!db) {
        listEl.innerHTML = '<div class="msg error">Firebase가 초기화되지 않았습니다.</div>';
        return;
      }
      loadMetaOnce();
    }

    function showAdminUI(user) {
      if (adminLock) adminLock.style.display = 'none';
      listView.style.display = 'block';
      if (adminUserEmailEl) adminUserEmailEl.textContent = user.email || '';
      doLoad();
    }
    function showLoginUI() {
      if (adminLock) adminLock.style.display = 'flex';
      listView.style.display = 'none';
      if (adminLockError) adminLockError.textContent = '';
    }

    onAuthStateChanged(auth, (user) => {
      if (!auth) return;
      if (!user) {
        showLoginUI();
        return;
      }
      const email = (user.email || '').trim().toLowerCase();
      const allowed = ALLOWED_EMAILS.some((e) => e.toLowerCase() === email);
      if (allowed) {
        showAdminUI(user);
      } else {
        signOut(auth).then(() => {
          showLoginUI();
          if (adminLockError) adminLockError.textContent = '이 페이지에 접근 권한이 있는 계정이 아닙니다.';
        });
      }
    });

    function handleLogin() {
      const email = (adminEmailInput && adminEmailInput.value) ? adminEmailInput.value.trim() : '';
      const password = adminKeyInput ? adminKeyInput.value : '';
      if (!email || !password) {
        adminLockError.textContent = '이메일과 비밀번호를 입력해 주세요.';
        return;
      }
      adminLockError.textContent = '';
      adminUnlockBtn.disabled = true;
      signInWithEmailAndPassword(auth, email, password)
        .then(() => { adminUnlockBtn.disabled = false; })
        .catch((err) => {
          adminUnlockBtn.disabled = false;
          if (err.code === 'auth/invalid-credential' || err.code === 'auth/wrong-password' || err.code === 'auth/user-not-found') {
            adminLockError.textContent = '이메일 또는 비밀번호가 올바르지 않습니다.';
          } else {
            adminLockError.textContent = err.message || '로그인에 실패했습니다.';
          }
        });
    }
    adminUnlockBtn.addEventListener('click', handleLogin);
    adminKeyInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleLogin(); });
    if (adminEmailInput) adminEmailInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleLogin(); });
    if (adminLogoutBtn) adminLogoutBtn.addEventListener('click', () => { signOut(auth).then(() => showLoginUI()); });

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && listView && listView.style.display !== 'none') {
        if (Object.keys(metaSnaps).length === 0) loadMetaOnce();
      }
    });

    function formatDate(t) {
      if (!t) return '-';
      const d = typeof t === 'number' ? new Date(t) : new Date(t);
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0') + ' ' +
        String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
    }

    function escapeAttr(s) {
      if (s == null) return '';
      return String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function escapeHtml(s) {
      if (s == null) return '';
      return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    /** metaSnaps(prefix->snap)에서 목록 배열 생성 → 실시간 반영용 */
    function buildItemsFromMetaSnaps() {
      const items = [];
      PREFIXES.forEach((prefix, idx) => {
        const snap = metaSnaps[prefix];
        if (!snap || !snap.exists()) return;
        snap.forEach((dateSnap) => {
          const dateKey = dateSnap.key;
          if (!/^\d{8}$/.test(dateKey)) return;
          dateSnap.forEach((inner) => {
            items.push({
              _prefix: prefix,
              _projectIndex: idx + 1,
              id: inner.key,
              _dateKey: dateKey,
              _isLegacy: false,
              ...inner.val()
            });
          });
        });
      });
      items.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      const total = items.length;
      items.forEach((it, i) => { it._globalSeq = total - i; });
      return items;
    }

    // 고유번호 정규화: 모든 공백 제거, 대문자 변환 (공백 포함 고유번호 처리)
    function normalizeUniqueCode(code) {
      if (!code) return '';
      return String(code).trim().replace(/\s+/g, '').toUpperCase();
    }

    // 제조번호 + 고유번호 조합 정규화 함수
    function normalizeBatchUniqueCombination(batchNumber, uniqueCode) {
      const batch = String(batchNumber || '').trim().replace(/\s+/g, '').toUpperCase();
      const code = String(uniqueCode || '').trim().replace(/\s+/g, '').toUpperCase();
      return (batch + code).trim();
    }

    function applyMetaAndRender() {
      if (Object.keys(metaSnaps).length !== PREFIXES.length) return;
      allItems = buildItemsFromMetaSnaps();
      
      // 제조번호 + 고유번호 조합 중복 검사 (자동) - 다른 고객이 사용한 경우만
      duplicateSubmissionIds.clear();
      duplicateUniqueCodes.clear();
      const combinationMap = new Map(); // 정규화된 제조번호+고유번호 조합 -> [{ submissionId, dateKey, prefix, contact, key, originalCode, originalBatch }]
      
      function normalizeContactForDup(c) {
        return (c || '').replace(/\D/g, '').trim();
      }
      
      allItems.forEach((item) => {
        // 잘못된정보 체크된 건만 중복 검사에서 제외 (재접수 허용)
        if (item.invalidInfo === true) return;
        const u = getUniqueCodesArray(item);
        const contact = normalizeContactForDup(item.contact);
        u.forEach((uc) => {
          const originalCode = (uc.uniqueCode || '').trim();
          const originalBatch = (uc.batchNumber || '').trim();
          if (!originalCode) return;
          
          // 제조번호 + 고유번호 조합으로 정규화
          const normalizedCombination = normalizeBatchUniqueCombination(originalBatch, originalCode);
          if (!normalizedCombination) return;
          
          const key = item.id + '|' + (item._dateKey || '') + '|' + (item._prefix || '');
          if (!combinationMap.has(normalizedCombination)) {
            combinationMap.set(normalizedCombination, []);
          }
          combinationMap.get(normalizedCombination).push({
            submissionId: item.id,
            dateKey: item._dateKey || '',
            prefix: item._prefix || '',
            contact: contact,
            key: key,
            originalCode: originalCode, // 원본 고유번호도 저장
            originalBatch: originalBatch // 원본 제조번호도 저장
          });
        });
      });
      
      // 디버깅: 정규화 확인 (공백 포함 제조번호+고유번호 조합 샘플)
      const sampleCombinations = [];
      combinationMap.forEach((submissions, normalizedCombination) => {
        if (submissions.length > 0 && submissions[0].originalCode && submissions[0].originalCode.includes(' ')) {
          sampleCombinations.push({
            원본제조번호: submissions[0].originalBatch,
            원본고유번호: submissions[0].originalCode,
            정규화조합: normalizedCombination,
            개수: submissions.length
          });
        }
      });
      if (sampleCombinations.length > 0) {
        console.log('공백 포함 제조번호+고유번호 조합 샘플:', sampleCombinations.slice(0, 5));
      }
      
      // 중복된 제조번호+고유번호 조합을 가진 접수 ID 수집 (2개 이상 사용된 모든 조합)
      // 중요: 같은 접수 내에서 여러 번 사용된 경우는 제외 (다른 접수에서 사용된 경우만 중복으로 간주)
      combinationMap.forEach((submissions, normalizedCombination) => {
        if (submissions.length >= 2) {
          // 같은 접수 내에서 여러 번 사용된 경우를 제외하기 위해 접수별로 그룹화
          const submissionKeys = new Set();
          submissions.forEach((sub) => {
            submissionKeys.add(sub.key);
          });
          
          // 실제로 2개 이상의 다른 접수에서 사용된 경우만 중복으로 간주
          if (submissionKeys.size >= 2) {
            // 정규화된 조합을 중복 목록에 추가 (2개 이상의 다른 접수에서 사용된 경우만)
            duplicateUniqueCodes.add(normalizedCombination);
            // 모든 중복 접수를 중복 목록에 추가
            submissions.forEach((sub) => {
              duplicateSubmissionIds.add(sub.key);
            });
          }
        }
      });
      
      paginationPage = 1;
      renderTable();
      
      // 중복 건수 안내 (강조 확인용)
      const dupCountEl = document.getElementById('duplicateCountNotice');
      if (dupCountEl) {
        const cnt = duplicateSubmissionIds.size;
        dupCountEl.textContent = cnt > 0 ? '제조번호+고유번호 중복 ' + cnt + '건 — 붉은색 강조' : '';
        dupCountEl.style.display = cnt > 0 ? 'block' : 'none';
      }
    }

    /** 4개 프로젝트 submissions_meta 한 번만 읽기 (실시간 구독 없음 → 다운로드 비용 절감) */
    async function loadMetaOnce() {
      if (!db || !listEl) return;
      const refreshBtn = document.getElementById('listRefreshBtn');
      listEl.innerHTML = '<p class="msg info">4개 프로젝트 데이터 로드 중…</p>';
      if (refreshBtn) refreshBtn.disabled = true;
      metaSnaps = {};
      try {
        for (const prefix of PREFIXES) {
          const snap = await get(dbRef(db, prefix + '/submissions_meta'));
          metaSnaps[prefix] = snap;
        }
        applyMetaAndRender();
      } catch (err) {
        listEl.innerHTML = '<p class="msg error">로드 실패: ' + (err.message || err) + '</p>';
      }
      if (refreshBtn) refreshBtn.disabled = false;
    }

    function getFilteredItems() {
      let base = allItems;
      // 조회 구분 필터 적용
      if (viewFilter !== 'all') {
        if (viewFilter === 'proofError') {
          base = base.filter((d) => !!d.proofError);
        } else if (viewFilter === 'noRefundExchange') {
          // 환불과 교환이 모두 체크되지 않은 접수만 (접수시 체크 여부)
          base = base.filter((d) => !d.refundDone && !d.exchangeDone);
        }
      }
      // 검색 필터 적용
      if (!searchFilters.name && !searchFilters.contact && !searchFilters.customsCode && !searchFilters.uniqueCode) return base;
      const nameKeyword = (searchFilters.name || '').trim().toLowerCase();
      const contactKeyword = (searchFilters.contact || '').trim();
      const customsKeyword = (searchFilters.customsCode || '').trim().toUpperCase();
      const uniqueCodeKeyword = (searchFilters.uniqueCode || '').trim();
      return base.filter((d) => {
        let ok = true;
        if (nameKeyword) ok = ok && (d.name || '').toLowerCase().includes(nameKeyword);
        if (contactKeyword) ok = ok && contactMatches(d.contact, searchFilters.contact);
        if (customsKeyword) ok = ok && (d.customsCode || '').toUpperCase().includes(customsKeyword);
        if (uniqueCodeKeyword) {
          const u = getUniqueCodesArray(d);
          const hasMatchingCode = u.some((uc) => {
            const code = (uc.uniqueCode || '').trim();
            return code && code.includes(uniqueCodeKeyword);
          });
          ok = ok && hasMatchingCode;
        }
        return ok;
      });
    }

    const searchUniqueCodeInput = document.getElementById('searchUniqueCode');
    
    if (searchBtn) searchBtn.addEventListener('click', () => {
      searchFilters = {
        name: (searchNameInput && searchNameInput.value) ? searchNameInput.value.trim() : '',
        contact: (searchContactInput && searchContactInput.value) ? searchContactInput.value.trim() : '',
        customsCode: (searchCustomsInput && searchCustomsInput.value) ? searchCustomsInput.value.trim() : '',
        uniqueCode: (searchUniqueCodeInput && searchUniqueCodeInput.value) ? searchUniqueCodeInput.value.trim() : ''
      };
      paginationPage = 1;
      renderTable();
    });
    if (searchResetBtn) searchResetBtn.addEventListener('click', () => {
      if (searchNameInput) searchNameInput.value = '';
      if (searchContactInput) searchContactInput.value = '';
      if (searchCustomsInput) searchCustomsInput.value = '';
      if (searchUniqueCodeInput) searchUniqueCodeInput.value = '';
      searchFilters = { name: '', contact: '', customsCode: '', uniqueCode: '' };
      paginationPage = 1;
      renderTable();
    });
    const listRefreshBtn = document.getElementById('listRefreshBtn');
    if (listRefreshBtn) listRefreshBtn.addEventListener('click', () => loadMetaOnce());
    
    const viewFilterSelect = document.getElementById('viewFilterSelect');
    if (viewFilterSelect) {
      viewFilter = viewFilterSelect.value || 'all';
      viewFilterSelect.addEventListener('change', () => {
        viewFilter = viewFilterSelect.value || 'all';
        paginationPage = 1;
        renderTable();
      });
    }

    function getUniqueCodesArray(d) {
      let arr = d.uniqueCodesData;
      if (Array.isArray(arr)) return arr;
      const codes = Array.isArray(d.uniqueCodes) ? d.uniqueCodes : (d.uniqueCode ? [d.uniqueCode] : []);
      return codes.map(code => ({ productName: '', batchNumber: '', uniqueCode: code || '' }));
    }

    function renderTable() {
      const filteredItems = getFilteredItems();
      if (!filteredItems.length) {
        listEl.innerHTML = '<p class="msg info">' + (allItems.length ? '조건에 맞는 접수가 없습니다.' : '접수된 건이 없습니다.') + '</p>';
        return;
      }
      const total = filteredItems.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if (paginationPage < 1) paginationPage = 1;
      if (paginationPage > totalPages) paginationPage = totalPages;
      const start = (paginationPage - 1) * PAGE_SIZE;
      const pageItems = filteredItems.slice(start, start + PAGE_SIZE);

      const headerRow =
        '<th class="cell-seq">순번</th>' +
        '<th class="cell-project">접수경로</th>' +
        '<th>사진 보기</th>' +
        '<th>이름</th><th>연락처</th><th>주소</th><th>상세 주소</th><th>개인통관부호</th>' +
        '<th>접수ID</th><th>접수일시</th>' +
        '<th>환불</th><th>교환</th><th>잘못된정보</th><th>6캔이상</th><th>환불완료</th><th>교환완료</th><th>증빙오류(반려)</th><th>사유</th>' +
        '<th>은행</th><th>계좌번호</th><th>계좌명</th><th>환불금액</th><th>환불(교환)캔수</th>' +
        '<th>제품명(1)</th><th>제조번호(1)</th><th>고유번호(1)</th>' +
        '<th>제품명(2)</th><th>제조번호(2)</th><th>고유번호(2)</th>' +
        '<th>제품명(3)</th><th>제조번호(3)</th><th>고유번호(3)</th>' +
        '<th>제품명(4)</th><th>제조번호(4)</th><th>고유번호(4)</th>' +
        '<th>제품명(5)</th><th>제조번호(5)</th><th>고유번호(5)</th>' +
        '<th>제품명(6)</th><th>제조번호(6)</th><th>고유번호(6)</th>' +
        '<th>제품명(7)</th><th>제조번호(7)</th><th>고유번호(7)</th>' +
        '<th>제품명(8)</th><th>제조번호(8)</th><th>고유번호(8)</th>' +
        '<th>제품명(9)</th><th>제조번호(9)</th><th>고유번호(9)</th>' +
        '<th>제품명(10)</th><th>제조번호(10)</th><th>고유번호(10)</th>' +
        '<th>제품명(11)</th><th>제조번호(11)</th><th>고유번호(11)</th>' +
        '<th>제품명(12)</th><th>제조번호(12)</th><th>고유번호(12)</th>' +
        '<th>유선안내완료</th><th>상담이력</th><th>처리내역</th>';

      let rowsHtml = '';
      pageItems.forEach((d) => {
        const seq = d._globalSeq;
        const proj = PROJECT_LABELS[d._projectIndex - 1] || '';
        const prefix = d._prefix;
        const dateKey = d._dateKey || '';
        const isLegacy = !!d._isLegacy;
        const detailUrl = PHOTO_VIEW_URL + '?id=' + encodeURIComponent(d.id) + '&dateKey=' + encodeURIComponent(dateKey) + '&legacy=' + (isLegacy ? '1' : '0') + '&prefix=' + encodeURIComponent(prefix);

        const u = getUniqueCodesArray(d);
        const u12 = [];
        for (let i = 0; i < 12; i++) u12.push(u[i] || { productName: '', batchNumber: '', uniqueCode: '' });

        const refundC = d.refundDone ? ' checked' : '';
        const exchangeC = d.exchangeDone ? ' checked' : '';
        const invalidC = d.invalidInfo ? ' checked' : '';
        const sixCansC = d.sixCansOrMore ? ' checked' : '';
        const locked = !!(d.refundComplete || d.exchangeComplete);
        const lockedAttr = locked ? ' disabled title="처리 완료 건 — 수정 불가"' : '';

        const rowKey = d.id + '|' + dateKey + '|' + prefix;
        const isDuplicate = duplicateSubmissionIds.has(rowKey);
        const rowClass = isDuplicate ? ' row-has-duplicate' : '';
        const duplicateCellAttr = isDuplicate ? ' class="cell-duplicate-highlight"' : '';
        rowsHtml += '<tr class="' + rowClass.trim() + '" data-id="' + escapeAttr(d.id) + '" data-date-key="' + escapeAttr(dateKey) + '" data-legacy="' + (isLegacy ? '1' : '0') + '" data-prefix="' + escapeAttr(prefix) + '" data-project-index="' + d._projectIndex + '" data-locked="' + (locked ? '1' : '0') + '">';
        rowsHtml += '<td class="cell-seq">' + seq + '</td>';
        rowsHtml += '<td class="cell-project">' + proj + '</td>';
        rowsHtml += '<td><button type="button" class="btn btn-primary photo-view-btn" style="font-size:11px;padding:2px 6px;">사진 보기</button></td>';
        rowsHtml += '<td' + duplicateCellAttr + '><span class="cell-text">' + escapeHtml(d.name || '-') + '</span></td>';
        rowsHtml += '<td><span class="cell-text">' + escapeHtml(d.contact || '-') + '</span></td>';
        rowsHtml += '<td><span class="cell-text">' + escapeHtml(d.address || '-') + '</span></td>';
        rowsHtml += '<td><span class="cell-text">' + escapeHtml(d.addressDetail || '-') + '</span></td>';
        rowsHtml += '<td><span class="cell-text">' + escapeHtml(d.customsCode || '-') + '</span></td>';
        rowsHtml += '<td>' + escapeHtml(d.id || '-') + '</td>';
        rowsHtml += '<td>' + formatDate(d.createdAt) + '</td>';
        rowsHtml += '<td><label><input type="checkbox" class="list-cb-refund" data-field="refundDone"' + refundC + lockedAttr + '> 환불</label></td>';
        rowsHtml += '<td><label><input type="checkbox" class="list-cb-exchange" data-field="exchangeDone"' + exchangeC + lockedAttr + '> 교환</label></td>';
        rowsHtml += '<td><label><input type="checkbox" class="list-cb-invalid" data-field="invalidInfo"' + invalidC + lockedAttr + '> 잘못</label></td>';
        rowsHtml += '<td><label><input type="checkbox" class="list-cb-sixCans" data-field="sixCansOrMore"' + sixCansC + '> 6캔이상</label></td>';
        rowsHtml += '<td class="cell-flag">' + (d.refundComplete ? 'Y' : '-') + '</td>';
        rowsHtml += '<td class="cell-flag">' + (d.exchangeComplete ? 'Y' : '-') + '</td>';
        rowsHtml += '<td class="cell-flag">' + (d.proofError ? 'Y' : '-') + '</td>';
        rowsHtml += '<td><span class="cell-text">' + escapeHtml(d.proofErrorReason || '-') + '</span></td>';
        rowsHtml += '<td><span class="cell-text">' + escapeHtml(d.bankName || '-') + '</span></td>';
        rowsHtml += '<td><span class="cell-text">' + escapeHtml(d.bankAccountNumber || '-') + '</span></td>';
        rowsHtml += '<td><span class="cell-text">' + escapeHtml(d.bankAccountName || '-') + '</span></td>';
        rowsHtml += '<td><span class="cell-text">' + escapeHtml(String(d.purchaseAmount || '')) + '</span></td>';
        rowsHtml += '<td><span class="cell-text">' + (d.quantity != null ? d.quantity : '-') + '</span></td>';
        for (let i = 0; i < 12; i++) {
          rowsHtml += '<td><span class="cell-text">' + escapeHtml(u12[i].productName || '-') + '</span></td>';
          const uniqueCode = (u12[i].uniqueCode || '').trim();
          const batchNumber = (u12[i].batchNumber || '').trim();
          // 해당 제조번호+고유번호 조합만 강조
          let isUniqueCodeDuplicate = false;
          if (uniqueCode) {
            const normalizedCombination = normalizeBatchUniqueCombination(batchNumber, uniqueCode);
            isUniqueCodeDuplicate = normalizedCombination && duplicateUniqueCodes.has(normalizedCombination);
          }
          const dupCellAttr = isUniqueCodeDuplicate ? ' class="cell-duplicate-highlight"' : '';
          rowsHtml += '<td' + dupCellAttr + '><span class="cell-text">' + escapeHtml(batchNumber || '-') + '</span></td>';
          rowsHtml += '<td' + dupCellAttr + '><span class="cell-text">' + escapeHtml(uniqueCode || '-') + '</span></td>';
        }
        rowsHtml += '<td class="cell-flag">' + (d.callComplete ? 'Y' : '-') + '</td>';
        rowsHtml += '<td><button type="button" class="btn btn-primary btn-counseling-view" style="font-size:11px;padding:2px 6px;" data-id="' + escapeAttr(d.id) + '" data-date-key="' + escapeAttr(dateKey) + '" data-prefix="' + escapeAttr(prefix) + '">상담이력</button></td>';
        rowsHtml += '<td><button type="button" class="btn btn-primary btn-processing-view" style="font-size:11px;padding:2px 6px;" data-id="' + escapeAttr(d.id) + '" data-date-key="' + escapeAttr(dateKey) + '" data-prefix="' + escapeAttr(prefix) + '">처리내역</button></td>';
        rowsHtml += '</tr>';
      });

      const tableHtml =
        '<div class="admin-table-wrapper">' +
          '<table class="admin-table">' +
            '<thead><tr>' + headerRow + '</tr></thead>' +
            '<tbody>' + rowsHtml + '</tbody>' +
          '</table>' +
        '</div>';
      const paginationHtml =
        '<div class="admin-pagination">' +
          '<button type="button" class="btn btn-primary admin-page-btn" data-page="' + (paginationPage - 1) + '" ' + (paginationPage <= 1 ? 'disabled' : '') + '>이전</button>' +
          '<span class="admin-page-info">페이지 ' + paginationPage + ' / ' + totalPages + ' (총 ' + total + '건)</span>' +
          '<button type="button" class="btn btn-primary admin-page-btn" data-page="' + (paginationPage + 1) + '" ' + (paginationPage >= totalPages ? 'disabled' : '') + '>다음</button>' +
          '<button type="button" class="btn btn-primary admin-page-btn" data-page="' + totalPages + '" ' + (paginationPage >= totalPages ? 'disabled' : '') + '>마지막</button>' +
        '</div>';

      listEl.innerHTML = tableHtml + paginationHtml;
      const infoP = document.createElement('p');
      infoP.className = 'msg info';
      const filterLabel = viewFilter === 'all' ? '' : (viewFilter === 'proofError' ? '증빙오류(반려)' : (viewFilter === 'noRefundExchange' ? '환불·교환 미체크' : ''));
      const baseMsg = (searchFilters.name || searchFilters.contact || searchFilters.customsCode || searchFilters.uniqueCode) ? ('검색 결과 ' + total + '건 (전체 ' + allItems.length + '건 중)') : (filterLabel ? '[' + filterLabel + '] ' + total + '건' : '전체 ' + total + '건');
      infoP.textContent = baseMsg + ', 페이지당 30건. 환불/교환/잘못된정보/6캔이상 체크 변경 가능.';
      listEl.insertBefore(infoP, listEl.firstChild);

      listEl.querySelectorAll('.admin-page-btn').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const targetPage = Number(btn.getAttribute('data-page'));
          if (!targetPage || targetPage === paginationPage) return;
          paginationPage = targetPage;
          renderTable();
        });
      });

      attachCheckboxListeners();
      attachPhotoViewButtons();
      attachCounselingAndProcessingButtons();
      attachCellTooltips();
    }

    function attachCellTooltips() {
      const tip = document.getElementById('cellTooltip');
      if (!tip) return;
      const table = listEl.querySelector('.admin-table');
      if (!table) return;
      const show = (el, text) => {
        if (!text || (typeof text === 'string' && text.trim() === '') || text === '-') return;
        tip.textContent = text;
        tip.classList.add('show');
        tip.setAttribute('aria-hidden', 'false');
        requestAnimationFrame(() => {
          const rect = el.getBoundingClientRect();
          const tipRect = tip.getBoundingClientRect();
          const gap = 8;
          let top = rect.top - tipRect.height - gap;
          if (top < 8) top = rect.bottom + gap;
          let left = rect.left + (rect.width / 2) - (tipRect.width / 2);
          if (left < 8) left = 8;
          if (left + tipRect.width > window.innerWidth - 8) left = window.innerWidth - tipRect.width - 8;
          tip.style.top = top + 'px';
          tip.style.left = left + 'px';
        });
      };
      const hide = () => {
        tip.classList.remove('show');
        tip.setAttribute('aria-hidden', 'true');
      };
      table.querySelectorAll('.cell-text, td[title]').forEach((el) => {
        const text = el.getAttribute('title') || (el.textContent && el.textContent.trim()) || '';
        if (!text) return;
        el.removeAttribute('title');
        el.setAttribute('data-fulltext', text);
        el.addEventListener('mouseenter', (e) => {
          e.stopPropagation();
          show(el, text);
        });
        el.addEventListener('mouseleave', (e) => {
          e.stopPropagation();
          hide();
        });
      });
    }

    function enforceSingleFlag(row) {
      const cbRefund = row.querySelector('.list-cb-refund');
      const cbExchange = row.querySelector('.list-cb-exchange');
      const cbInvalid = row.querySelector('.list-cb-invalid');
      if (cbRefund && cbRefund.checked) { if (cbExchange) cbExchange.checked = false; if (cbInvalid) cbInvalid.checked = false; }
      else if (cbExchange && cbExchange.checked) { if (cbRefund) cbRefund.checked = false; if (cbInvalid) cbInvalid.checked = false; }
      else if (cbInvalid && cbInvalid.checked) { if (cbRefund) cbRefund.checked = false; if (cbExchange) cbExchange.checked = false; }
    }

    function getRowCustomerInfo(r) {
      const tds = r.querySelectorAll('td');
      const name = (tds[3] && tds[3].textContent) ? tds[3].textContent.trim() : '';
      const contact = (tds[4] && tds[4].textContent) ? tds[4].textContent.trim() : '';
      return (name || contact) ? '이 고객 [' + name + ' / ' + contact + ']' : '이 고객';
    }

    function getPhotoListFromData(d, singleKey, listKey) {
      if (!d) return [];
      if (Array.isArray(d[listKey])) return d[listKey];
      const single = d[singleKey];
      return single ? [single] : [];
    }

    function openDetailModal(d) {
      if (!d || !db) return;
      currentDetailData = d;
      const modal = document.getElementById('detailModal');
      const titleEl = document.getElementById('detailModalTitle');
      const infoRowsEl = document.getElementById('detailModalInfoRows');
      const flagsEl = document.getElementById('detailModalFlags');
      titleEl.textContent = '고객 상세 · 사진 보기 — ' + (d.name || d.contact || d.id || '');
      infoRowsEl.innerHTML =
        '<div class="info-row"><strong>이름</strong> ' + escapeHtml(d.name || '-') + '</div>' +
        '<div class="info-row"><strong>연락처</strong> ' + escapeHtml(d.contact || '-') + '</div>' +
        '<div class="info-row"><strong>주소</strong> ' + escapeHtml(d.address || '-') + '</div>' +
        '<div class="info-row"><strong>상세주소</strong> ' + escapeHtml(d.addressDetail || '-') + '</div>' +
        '<div class="info-row"><strong>개인통관부호</strong> ' + escapeHtml(d.customsCode || '-') + '</div>' +
        '<div class="info-row"><strong>접수ID</strong> ' + escapeHtml(d.id || '-') + '</div>' +
        '<div class="info-row"><strong>접수일시</strong> ' + formatDate(d.createdAt) + '</div>';
      const rC = d.refundDone ? ' checked' : '';
      const eC = d.exchangeDone ? ' checked' : '';
      const iC = d.invalidInfo ? ' checked' : '';
      const sC = d.sixCansOrMore ? ' checked' : '';
      const dmLocked = !!(d.refundComplete || d.exchangeComplete);
      const dmLockedAttr = dmLocked ? ' disabled title="처리 완료 건 — 수정 불가"' : '';
      flagsEl.innerHTML =
        '<h3>상태 체크 (저장됨)</h3>' +
        (dmLocked ? '<p style="font-size:12px;color:#856404;margin-bottom:8px;">※ 환불완료/교환완료 건 — 환불·교환·잘못된정보는 수정 불가</p>' : '') +
        '<label><input type="checkbox" id="dm-cb-refund" data-field="refundDone"' + rC + dmLockedAttr + '> 환불</label>' +
        '<label><input type="checkbox" id="dm-cb-exchange" data-field="exchangeDone"' + eC + dmLockedAttr + '> 교환</label>' +
        '<label><input type="checkbox" id="dm-cb-invalid" data-field="invalidInfo"' + iC + dmLockedAttr + '> 잘못된정보</label>' +
        '<label><input type="checkbox" id="dm-cb-sixCans" data-field="sixCansOrMore"' + sC + '> 6캔이상</label>' +
        '<p style="font-size:12px;margin-top:8px;color:#555;">환불완료 ' + (d.refundComplete ? 'Y' : '-') + ' / 교환완료 ' + (d.exchangeComplete ? 'Y' : '-') + ' / 증빙오류(반려) ' + (d.proofError ? 'Y' : '-') + (d.proofErrorReason ? ' — ' + escapeHtml(d.proofErrorReason) : '') + '</p>';
      document.getElementById('detailModalPhotos').textContent = '사진 불러오는 중…';
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
      loadDetailModalPhotos(d);
      attachDetailModalCheckboxListeners();
    }

    function closeDetailModal() {
      const modal = document.getElementById('detailModal');
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
      currentDetailData = null;
    }

    function loadDetailModalPhotos(d) {
      const prefix = d._prefix || '';
      const dateKey = d._dateKey || '';
      const id = d.id;
      const isLegacy = !!d._isLegacy;
      const subPath = isLegacy ? prefix + '/submissions/' + id : prefix + '/submissions/' + dateKey + '/' + id;
      const container = document.getElementById('detailModalPhotos');
      get(child(dbRef(db), subPath)).then(snap => {
        if (!snap.exists()) {
          container.innerHTML = '<p class="no-image">해당 접수 데이터가 없습니다.</p>';
          return;
        }
        const data = snap.val();
        const p1List = getPhotoListFromData(data, 'photo1', 'photo1List');
        const p2List = getPhotoListFromData(data, 'photo2', 'photo2List');
        const p3List = getPhotoListFromData(data, 'photo3', 'photo3List');
        let html = '<div class="detail-modal-photo-box"><h3>1. 구매 시 영수증</h3><div class="caption">업로드된 사진</div>';
        if (p1List.length) p1List.forEach((url) => { html += '<img src="' + url.replace(/"/g, '&quot;') + '" alt="영수증" data-url="' + url.replace(/"/g, '&quot;') + '">'; });
        else html += '<div class="no-image">없음</div>';
        html += '</div><div class="detail-modal-photo-box"><h3>2. 제품 앞면</h3><div class="caption">업로드된 사진</div>';
        if (p2List.length) p2List.forEach((url) => { html += '<img src="' + url.replace(/"/g, '&quot;') + '" alt="제품 앞면" data-url="' + url.replace(/"/g, '&quot;') + '">'; });
        else html += '<div class="no-image">없음</div>';
        html += '</div><div class="detail-modal-photo-box"><h3>3. 제품 뒷면/바닥면</h3><div class="caption">업로드된 사진</div>';
        if (p3List.length) p3List.forEach((url) => { html += '<img src="' + url.replace(/"/g, '&quot;') + '" alt="제품 뒷면" data-url="' + url.replace(/"/g, '&quot;') + '">'; });
        else html += '<div class="no-image">없음</div>';
        html += '</div>';
        container.innerHTML = html;
        // 모든 사진 URL 수집
        const allPhotoUrls = [];
        container.querySelectorAll('img[data-url]').forEach(img => {
          const url = img.getAttribute('data-url');
          if (url) allPhotoUrls.push(url);
        });
        
        // 전역 변수에 사진 목록 저장
        window.currentPhotoList = allPhotoUrls;
        window.currentPhotoIndex = -1;
        
        container.querySelectorAll('img[data-url]').forEach((img, index) => {
          img.style.cursor = 'pointer';
          img.addEventListener('click', (e) => {
            e.stopPropagation();
            const url = img.getAttribute('data-url');
            if (!url) return;
            // showPhotoLightbox 함수 사용
            showPhotoLightbox(index);
          });
        });
      }).catch(() => { container.innerHTML = '<p class="no-image">사진을 불러올 수 없습니다.</p>'; });
    }

    function enforceDetailModalSingleFlag() {
      const cbRefund = document.getElementById('dm-cb-refund');
      const cbExchange = document.getElementById('dm-cb-exchange');
      const cbInvalid = document.getElementById('dm-cb-invalid');
      if (!cbRefund || !cbExchange || !cbInvalid) return;
      if (cbRefund.checked) { cbExchange.checked = false; cbInvalid.checked = false; }
      else if (cbExchange.checked) { cbRefund.checked = false; cbInvalid.checked = false; }
      else if (cbInvalid.checked) { cbRefund.checked = false; cbExchange.checked = false; }
    }

    async function saveFlagsOnlyByData(payload) {
      const d = currentDetailData;
      if (!d || !db) return;
      const locked = !!(d.refundComplete || d.exchangeComplete);
      if (locked) {
        payload.refundDone = !!d.refundDone;
        payload.exchangeDone = !!d.exchangeDone;
        payload.invalidInfo = !!d.invalidInfo;
      }
      const id = d.id;
      const dateKey = (d._dateKey || '').trim();
      const isLegacy = !!d._isLegacy;
      const prefix = (d._prefix || '').trim();
      if (!id || !prefix) return;
      if (!isLegacy && !dateKey) return;
      const subPath = isLegacy ? prefix + '/submissions/' + id : prefix + '/submissions/' + dateKey + '/' + id;
      const metaPath = dateKey ? (prefix + '/submissions_meta/' + dateKey + '/' + id) : '';
      try {
        await update(dbRef(db, subPath), payload);
        if (metaPath) await update(dbRef(db, metaPath), payload);
        const it = allItems.find((i) => String(i.id) === String(id) && (i._dateKey || '') === dateKey && i._prefix === prefix);
        if (it) {
          it.refundDone = payload.refundDone;
          it.exchangeDone = payload.exchangeDone;
          it.invalidInfo = payload.invalidInfo;
          it.sixCansOrMore = payload.sixCansOrMore;
        }
        const tbody = listEl.querySelector('tbody');
        if (tbody) tbody.querySelectorAll('tr').forEach((r) => {
          if (r.getAttribute('data-id') !== id || r.getAttribute('data-prefix') !== prefix) return;
          const row = r;
          const set = (sel, val) => { const c = row.querySelector(sel); if (c) c.checked = !!val; };
          set('.list-cb-refund', payload.refundDone);
          set('.list-cb-exchange', payload.exchangeDone);
          set('.list-cb-invalid', payload.invalidInfo);
          set('.list-cb-sixCans', payload.sixCansOrMore);
        });
      } catch (err) {
        console.error('저장 오류:', err);
        alert('저장 실패: ' + (err.message || err));
      }
    }

    function attachDetailModalCheckboxListeners() {
      const flagsEl = document.getElementById('detailModalFlags');
      if (!flagsEl) return;
      const cbRefund = document.getElementById('dm-cb-refund');
      const cbExchange = document.getElementById('dm-cb-exchange');
      const cbInvalid = document.getElementById('dm-cb-invalid');
      const cbSix = document.getElementById('dm-cb-sixCans');
      const saveFromModal = () => {
        const refundDone = !!cbRefund?.checked;
        const exchangeDone = !!cbExchange?.checked;
        const invalidInfo = !!cbInvalid?.checked;
        const sixCansOrMore = !!cbSix?.checked;
        saveFlagsOnlyByData({ refundDone, exchangeDone, invalidInfo, sixCansOrMore });
      };
      [cbRefund, cbExchange, cbInvalid].forEach(cb => {
        if (!cb) return;
        cb.addEventListener('change', () => {
          const field = cb.getAttribute('data-field');
          if (cb.checked && (field === 'refundDone' || field === 'exchangeDone' || field === 'invalidInfo')) {
            const label = field === 'refundDone' ? '환불' : (field === 'exchangeDone' ? '교환' : '잘못된 정보');
            if (!confirm('이 고객\n\n' + label + ' 체크가 맞습니까?\n\n확인 시 저장됩니다.')) { cb.checked = false; return; }
          }
          enforceDetailModalSingleFlag();
          saveFromModal();
        });
      });
      if (cbSix) cbSix.addEventListener('change', saveFromModal);
    }

    function attachPhotoViewButtons() {
      listEl.querySelectorAll('.photo-view-btn').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const row = btn.closest('tr');
          if (!row) return;
          const id = row.getAttribute('data-id');
          const dateKey = row.getAttribute('data-date-key') || '';
          const prefix = row.getAttribute('data-prefix') || '';
          const d = allItems.find((it) => String(it.id) === String(id) && (it._dateKey || '') === dateKey && it._prefix === prefix);
          if (d) {
            const isLegacy = !dateKey;
            const url = 'photo_view.html?id=' + encodeURIComponent(id) + 
                       (dateKey ? '&dateKey=' + encodeURIComponent(dateKey) : '') +
                       (isLegacy ? '&legacy=1' : '') +
                       '&prefix=' + encodeURIComponent(prefix);
            window.open(url, '_blank', 'width=1400,height=900,scrollbars=yes');
          }
        });
      });
    }

    // 상담이력/처리내역 조회 (Firebase + localStorage 아웃바운드 목업 fallback)
    function loadProcessingHistoryForView(prefix, dateKey, id) {
      const key = prefix + '_' + dateKey + '_' + id;
      try {
        const stored = localStorage.getItem('outbound_cs_processing_history');
        if (stored) {
          const map = new Map(JSON.parse(stored));
          const arr = map.get(key) || [];
          return Array.isArray(arr) ? arr.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)) : [];
        }
      } catch (e) {}
      return [];
    }
    function loadCounselingHistoryForView(prefix, dateKey, id) {
      const key = prefix + '_' + dateKey + '_' + id;
      try {
        const stored = localStorage.getItem('outbound_cs_counseling_history');
        if (stored) {
          const map = new Map(JSON.parse(stored));
          const arr = map.get(key) || [];
          return Array.isArray(arr) ? arr.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)) : [];
        }
      } catch (e) {}
      return [];
    }
    function formatHistoryDate(t) {
      if (!t) return '-';
      const d = typeof t === 'number' ? new Date(t) : new Date(t);
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0') + ' ' +
        String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
    }
    async function openHistoryViewModal(type, d) {
      const modal = document.getElementById('historyViewModal');
      const titleEl = document.getElementById('historyViewModalTitle');
      const contentEl = document.getElementById('historyViewModalContent');
      if (!modal || !contentEl) return;
      const id = d.id;
      const dateKey = d._dateKey || '';
      const prefix = d._prefix || '';
      if (type === 'counseling') {
        titleEl.textContent = '상담이력 — ' + (d.name || d.contact || id || '');
        let data = d.counselingHistory;
        if (Array.isArray(data)) {
          const arr = data.length ? data : loadCounselingHistoryForView(prefix, dateKey, id);
          if (arr.length === 0) {
            contentEl.innerHTML = '<p style="color:#666;">등록된 상담이력이 없습니다.</p>';
          } else {
            contentEl.innerHTML = arr.map((h) =>
              '<div style="margin-bottom:12px;padding:10px;background:#f0f7ff;border-radius:6px;border-left:4px solid #17a;">' +
              '<div style="font-size:11px;color:#666;margin-bottom:4px;">' + formatHistoryDate(h.timestamp) + ' — ' + escapeHtml(h.account || '-') + '</div>' +
              '<div style="font-size:13px;white-space:pre-wrap;">' + escapeHtml(h.content || '') + '</div></div>'
            ).join('');
          }
        } else if (typeof data === 'string' && data.trim()) {
          contentEl.innerHTML = '<div style="white-space:pre-wrap;">' + escapeHtml(data) + '</div>';
        } else {
          const arr = loadCounselingHistoryForView(prefix, dateKey, id);
          if (arr.length === 0) {
            contentEl.innerHTML = '<p style="color:#666;">등록된 상담이력이 없습니다.</p>';
          } else {
            contentEl.innerHTML = arr.map((h) =>
              '<div style="margin-bottom:12px;padding:10px;background:#f0f7ff;border-radius:6px;border-left:4px solid #17a;">' +
              '<div style="font-size:11px;color:#666;margin-bottom:4px;">' + formatHistoryDate(h.timestamp) + ' — ' + escapeHtml(h.account || '-') + '</div>' +
              '<div style="font-size:13px;white-space:pre-wrap;">' + escapeHtml(h.content || '') + '</div></div>'
            ).join('');
          }
        }
      } else {
        titleEl.textContent = '처리내역 — ' + (d.name || d.contact || id || '');
        let arr = [];
        if (db) {
          const path = prefix + '/processing_history/' + dateKey + '/' + id;
          try {
            const snap = await get(dbRef(db, path));
            if (snap.exists()) {
              snap.forEach((childSnap) => { arr.push(childSnap.val()); });
            }
          } catch (e) {}
        }
        if (arr.length === 0) arr = loadProcessingHistoryForView(prefix, dateKey, id);
        arr.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        if (arr.length === 0) {
          contentEl.innerHTML = '<p style="color:#666;">등록된 처리내역이 없습니다.</p>';
        } else {
          contentEl.innerHTML = arr.map((h) =>
            '<div style="margin-bottom:12px;padding:10px;background:#f9f9f9;border-radius:6px;border-left:4px solid #17a;">' +
            '<div style="font-size:11px;color:#666;margin-bottom:4px;">' + formatHistoryDate(h.timestamp) + ' — ' + escapeHtml(h.account || '-') + '</div>' +
            '<div style="font-size:13px;">' + escapeHtml(h.changes || '') + '</div></div>'
          ).join('');
        }
      }
      modal.style.display = 'flex';
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
    }
    function closeHistoryViewModal() {
      const modal = document.getElementById('historyViewModal');
      if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
      }
    }
    function attachCounselingAndProcessingButtons() {
      listEl.querySelectorAll('.btn-counseling-view').forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          const id = btn.getAttribute('data-id');
          const dateKey = btn.getAttribute('data-date-key') || '';
          const prefix = btn.getAttribute('data-prefix') || '';
          const d = allItems.find((it) => String(it.id) === String(id) && (it._dateKey || '') === dateKey && it._prefix === prefix);
          if (d) await openHistoryViewModal('counseling', d);
        });
      });
      listEl.querySelectorAll('.btn-processing-view').forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          const id = btn.getAttribute('data-id');
          const dateKey = btn.getAttribute('data-date-key') || '';
          const prefix = btn.getAttribute('data-prefix') || '';
          const d = allItems.find((it) => String(it.id) === String(id) && (it._dateKey || '') === dateKey && it._prefix === prefix);
          if (d) await openHistoryViewModal('processing', d);
        });
      });
      const closeBtn = document.getElementById('historyViewModalClose');
      if (closeBtn) closeBtn.addEventListener('click', closeHistoryViewModal);
      const modal = document.getElementById('historyViewModal');
      if (modal) modal.addEventListener('click', (e) => { if (e.target === modal) closeHistoryViewModal(); });
    }

    (function initDetailModalClose() {
      const modal = document.getElementById('detailModal');
      const closeBtn = document.getElementById('detailModalClose');
      if (closeBtn) closeBtn.addEventListener('click', closeDetailModal);
      if (modal) modal.addEventListener('click', (e) => { if (e.target === modal) closeDetailModal(); });
    })();

    // 사진 넘김 관련 전역 변수
    window.currentPhotoList = [];
    window.currentPhotoIndex = -1;

    function updatePhotoLightboxNav() {
      const prevBtn = document.getElementById('photoLightboxPrev');
      const nextBtn = document.getElementById('photoLightboxNext');
      const counter = document.getElementById('photoLightboxCounter');
      const total = window.currentPhotoList.length;
      const current = window.currentPhotoIndex + 1;
      
      if (prevBtn) prevBtn.disabled = (window.currentPhotoIndex <= 0);
      if (nextBtn) nextBtn.disabled = (window.currentPhotoIndex >= total - 1);
      if (counter && total > 1) {
        counter.textContent = current + ' / ' + total;
        counter.style.display = 'block';
      } else if (counter) {
        counter.style.display = 'none';
      }
    }

    function showPhotoLightbox(index) {
      const lb = document.getElementById('photoLightbox');
      const lbImg = document.getElementById('photoLightboxImg');
      if (!lb || !lbImg || !window.currentPhotoList || window.currentPhotoList.length === 0) return;
      
      if (index < 0) index = 0;
      if (index >= window.currentPhotoList.length) index = window.currentPhotoList.length - 1;
      
      window.currentPhotoIndex = index;
      lbImg.src = window.currentPhotoList[index];
      lb.classList.add('show');
      lb.setAttribute('aria-hidden', 'false');
      updatePhotoLightboxNav();
    }

    function closePhotoLightbox() {
      const lb = document.getElementById('photoLightbox');
      const lbImg = document.getElementById('photoLightboxImg');
      if (lb) { lb.classList.remove('show'); lb.setAttribute('aria-hidden', 'true'); }
      if (lbImg) lbImg.src = '';
      window.currentPhotoIndex = -1;
    }

    function prevPhoto() {
      if (window.currentPhotoIndex > 0) {
        showPhotoLightbox(window.currentPhotoIndex - 1);
      }
    }

    function nextPhoto() {
      if (window.currentPhotoList && window.currentPhotoIndex < window.currentPhotoList.length - 1) {
        showPhotoLightbox(window.currentPhotoIndex + 1);
      }
    }

    (function initPhotoLightbox() {
      const lb = document.getElementById('photoLightbox');
      const closeBtn = document.getElementById('photoLightboxClose');
      const prevBtn = document.getElementById('photoLightboxPrev');
      const nextBtn = document.getElementById('photoLightboxNext');
      const lbImg = document.getElementById('photoLightboxImg');
      
      if (closeBtn) closeBtn.addEventListener('click', (e) => { e.stopPropagation(); closePhotoLightbox(); });
      if (prevBtn) prevBtn.addEventListener('click', (e) => { e.stopPropagation(); prevPhoto(); });
      if (nextBtn) nextBtn.addEventListener('click', (e) => { e.stopPropagation(); nextPhoto(); });
      
      // 키보드 화살표 키 지원
      document.addEventListener('keydown', (e) => {
        if (!lb || !lb.classList.contains('show')) return;
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          prevPhoto();
        } else if (e.key === 'ArrowRight') {
          e.preventDefault();
          nextPhoto();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          closePhotoLightbox();
        }
      });
      
      // 라이트박스 배경 클릭 시에만 닫기 (이미지나 버튼 클릭은 제외)
      if (lb) {
        lb.addEventListener('click', (e) => {
          // 이미지, 버튼, 카운터를 클릭한 경우가 아니면 닫기
          if (e.target === lb) {
            closePhotoLightbox();
          }
        });
      }
      // 이미지 클릭 시 이벤트 전파 중지 (라이트박스가 닫히지 않도록)
      if (lbImg) {
        lbImg.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }
    })();

    async function saveFlagsOnly(row) {
      const id = row.getAttribute('data-id');
      const dateKey = (row.getAttribute('data-date-key') || '').trim();
      const isLegacy = row.getAttribute('data-legacy') === '1';
      const prefix = (row.getAttribute('data-prefix') || '').trim();
      if (!id || !prefix || !db) return;
      if (!isLegacy && !dateKey) {
        alert('저장할 수 없습니다. 접수 정보(dateKey)가 없습니다.');
        return;
      }
      const item = allItems.find((i) => String(i.id) === String(id) && (i._dateKey || '') === dateKey && i._prefix === prefix);
      const locked = !!(item && (item.refundComplete || item.exchangeComplete));
      enforceSingleFlag(row);
      let refundDone = !!row.querySelector('.list-cb-refund')?.checked;
      let exchangeDone = !!row.querySelector('.list-cb-exchange')?.checked;
      let invalidInfo = !!row.querySelector('.list-cb-invalid')?.checked;
      const sixCansOrMore = !!row.querySelector('.list-cb-sixCans')?.checked;
      if (locked && item) {
        refundDone = !!item.refundDone;
        exchangeDone = !!item.exchangeDone;
        invalidInfo = !!item.invalidInfo;
      }
      const payload = { refundDone, exchangeDone, invalidInfo, sixCansOrMore };
      const subPath = isLegacy ? prefix + '/submissions/' + id : prefix + '/submissions/' + dateKey + '/' + id;
      const metaPath = prefix + '/submissions_meta/' + dateKey + '/' + id;
      try {
        await update(dbRef(db, subPath), payload);
        await update(dbRef(db, metaPath), payload);
        const it = allItems.find((i) => String(i.id) === String(id) && (i._dateKey || '') === dateKey && i._prefix === prefix);
        if (it) {
          it.refundDone = refundDone;
          it.exchangeDone = exchangeDone;
          it.invalidInfo = invalidInfo;
          it.sixCansOrMore = sixCansOrMore;
        }
        renderTable();
      } catch (err) {
        console.error('저장 오류:', err);
        alert('저장 실패: ' + (err.message || err));
      }
    }

    function attachCheckboxListeners() {
      const tbody = listEl.querySelector('tbody');
      if (!tbody) return;
      tbody.querySelectorAll('tr').forEach((row) => {
        row.querySelectorAll('.list-cb-refund, .list-cb-exchange, .list-cb-invalid, .list-cb-sixCans').forEach((cb) => {
          cb.addEventListener('change', () => {
            const field = cb.getAttribute('data-field');
            if (field === 'sixCansOrMore') {
              saveFlagsOnly(row);
              return;
            }
            if (cb.checked) {
              const label = field === 'refundDone' ? '환불' : (field === 'exchangeDone' ? '교환' : '잘못된 정보');
              const info = getRowCustomerInfo(row);
              cb.checked = false;
              if (!confirm(info + '\n\n' + label + ' 체크가 맞습니까?\n\n확인 시 체크 후 저장됩니다.')) return;
              row.querySelector('.list-cb-refund').checked = (cb === row.querySelector('.list-cb-refund'));
              row.querySelector('.list-cb-exchange').checked = (cb === row.querySelector('.list-cb-exchange'));
              row.querySelector('.list-cb-invalid').checked = (cb === row.querySelector('.list-cb-invalid'));
              saveFlagsOnly(row);
              return;
            }
            saveFlagsOnly(row);
          });
        });
      });
    }

    // 소비기한 확인 모달
    const expiryModal = document.getElementById('expiryModal');
    const expiryModalClose = document.getElementById('expiryModalClose');
    const expiryModalTitle = document.getElementById('expiryModalTitle');
    const expiryModalImg = document.getElementById('expiryModalImg');
    
    // 각 몰별 사진 경로 (유베이스 어드민에서는 자체 resorce 폴더 사용)
    const expiryImagePaths = [
      'resorce/회수제품 리스트_1_아이베.png',
      'resorce/회수제품 리스트_2_림인터네셔널.png',
      'resorce/회수제품 리스트_3_크린랩.png',
      'resorce/회수제품 리스트_4_몰테일.png'
    ];
    
    // 소비기한 확인 버튼 이벤트
    document.querySelectorAll('[data-expiry-site]').forEach(btn => {
      btn.addEventListener('click', () => {
        const siteIndex = parseInt(btn.getAttribute('data-expiry-site'), 10);
        if (siteIndex >= 0 && siteIndex < PROJECT_LABELS.length) {
          const siteName = PROJECT_LABELS[siteIndex];
          const imagePath = expiryImagePaths[siteIndex];
          
          if (expiryModalTitle) {
            expiryModalTitle.textContent = siteName + ' - 대상제품 소비기한 확인';
          }
          if (expiryModalImg) {
            expiryModalImg.src = imagePath;
            expiryModalImg.alt = siteName + ' 회수제품 리스트';
          }
          if (expiryModal) {
            expiryModal.classList.add('active');
            document.body.style.overflow = 'hidden';
          }
        }
      });
    });
    
    // 모달 닫기
    if (expiryModalClose) {
      expiryModalClose.addEventListener('click', () => {
        if (expiryModal) {
          expiryModal.classList.remove('active');
          document.body.style.overflow = '';
        }
      });
    }
    
    if (expiryModal) {
      expiryModal.addEventListener('click', (e) => {
        if (e.target === expiryModal) {
          expiryModal.classList.remove('active');
          document.body.style.overflow = '';
        }
      });
    }

  </script>
</body>
</html>
