<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>사진 보기 - 압타밀 통합 조회</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    body { padding: 20px; max-width: 900px; margin: 0 auto; background: #f5f5f5; }
    .detail-page-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; }
    .detail-page-header h1 { margin: 0; font-size: 1.25rem; }
    .back-link { padding: 8px 16px; background: #1a1a1a; color: #fff; text-decoration: none; border-radius: 4px; font-size: 14px; }
    .back-link:hover { background: #333; color: #fff; }
    #detailRoot { background: #fff; padding: 24px; border-radius: 8px; border: 1px solid #e0e0e0; }
    .detail-section { margin-bottom: 24px; }
    .detail-section h2 { font-size: 16px; margin: 0 0 12px 0; }
    .detail-photos { display: flex; flex-wrap: wrap; gap: 16px; }
    .photo-box { border: 1px solid #e0e0e0; padding: 12px; border-radius: 4px; }
    .photo-box .caption { font-size: 12px; color: #666; margin-bottom: 8px; }
    .detail-photo-img { max-width: 200px; max-height: 200px; cursor: pointer; display: block; }
    .no-image { color: #999; font-size: 13px; }
    .msg.error { color: #c00; }
  </style>
</head>
<body>
  <div class="detail-page-header">
    <h1 id="detailPageTitle">사진 보기</h1>
    <a href="#" id="backToListBtn" class="back-link">← 목록으로</a>
  </div>
  <div id="detailRoot">불러오는 중…</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getDatabase, ref as dbRef, get, child } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCxNwnAzMn0JUkHGDXgY4taTPJYeABDohg",
      authDomain: "eibe-nutricia.firebaseapp.com",
      databaseURL: "https://eibe-nutricia-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "eibe-nutricia",
      storageBucket: "eibe-nutricia.firebasestorage.app",
      messagingSenderId: "605906618980",
      appId: "1:605906618980:web:d947540696a573c4856d71"
    };

    const params = new URLSearchParams(window.location.search);
    const id = params.get('id') || '';
    const dateKey = params.get('dateKey') || '';
    const isLegacy = params.get('legacy') === '1' || params.get('legacy') === 'true';
    const prefix = params.get('prefix') || 'nutricia-x9fQ2kM7-1';

    let app, db;
    try {
      app = initializeApp(firebaseConfig);
      db = getDatabase(app);
    } catch (err) {
      document.getElementById('detailRoot').innerHTML = '<p class="msg error">Firebase 초기화에 실패했습니다.</p>';
      throw err;
    }

    document.getElementById('backToListBtn').addEventListener('click', (e) => {
      e.preventDefault();
      if (window.opener) window.close();
      else window.location.href = 'index.html';
    });

    function getPhotoListFromData(d, singleKey, listKey) {
      if (!d) return [];
      if (Array.isArray(d[listKey])) return d[listKey];
      const single = d[singleKey];
      return single ? [single] : [];
    }

    function dataURLtoBlob(dataURL) {
      const parts = dataURL.split(',');
      const meta = parts[0];
      const base64 = parts[1];
      const mimeMatch = meta.match(/data:(.*?);base64/);
      const mime = mimeMatch ? mimeMatch[1] : 'application/octet-stream';
      const binary = atob(base64);
      const len = binary.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
      return new Blob([bytes], { type: mime });
    }

    const root = document.getElementById('detailRoot');
    if (!id || !prefix) {
      root.innerHTML = '<p class="msg error">접수 ID 또는 프로젝트 정보가 없습니다. 목록에서 사진 보기를 눌러 열어주세요.</p>';
    } else {
      const rootRef = dbRef(db);
      const subPath = isLegacy ? prefix + '/submissions/' + id : prefix + '/submissions/' + dateKey + '/' + id;
      get(child(rootRef, subPath)).then(snap => {
        if (!snap.exists()) {
          root.innerHTML = '<p class="msg error">해당 접수를 찾을 수 없습니다.</p>';
          return;
        }
        const d = snap.val();
        const p1List = getPhotoListFromData(d, 'photo1', 'photo1List');
        const p2List = getPhotoListFromData(d, 'photo2', 'photo2List');
        const p3List = getPhotoListFromData(d, 'photo3', 'photo3List');

        let html = '<div class="detail-section"><h2>1. 구매 시 영수증</h2><div class="detail-photos"><div class="photo-box"><div class="caption">업로드된 사진</div>';
        if (p1List.length) p1List.forEach((url) => { html += '<img src="' + url.replace(/"/g, '&quot;') + '" alt="영수증" class="detail-photo-img" data-url="' + url.replace(/"/g, '&quot;') + '" style="cursor:pointer">'; });
        else html += '<div class="no-image">없음</div>';
        html += '</div></div></div>';
        html += '<div class="detail-section"><h2>2. 제품 앞면</h2><div class="detail-photos"><div class="photo-box"><div class="caption">업로드된 사진</div>';
        if (p2List.length) p2List.forEach((url) => { html += '<img src="' + url.replace(/"/g, '&quot;') + '" alt="제품 앞면" class="detail-photo-img" data-url="' + url.replace(/"/g, '&quot;') + '" style="cursor:pointer">'; });
        else html += '<div class="no-image">없음</div>';
        html += '</div></div></div>';
        html += '<div class="detail-section"><h2>3. 제품 뒷면/바닥면</h2><div class="detail-photos"><div class="photo-box"><div class="caption">업로드된 사진</div>';
        if (p3List.length) p3List.forEach((url) => { html += '<img src="' + url.replace(/"/g, '&quot;') + '" alt="제품 뒷면" class="detail-photo-img" data-url="' + url.replace(/"/g, '&quot;') + '" style="cursor:pointer">'; });
        else html += '<div class="no-image">없음</div>';
        html += '</div></div></div>';
        root.innerHTML = html;

        root.querySelectorAll('.detail-photo-img').forEach(img => {
          img.addEventListener('click', () => {
            const url = img.getAttribute('data-url');
            if (!url) return;
            try {
              if (url.startsWith('data:')) {
                const blob = dataURLtoBlob(url);
                const blobUrl = URL.createObjectURL(blob);
                window.open(blobUrl, '_blank');
                setTimeout(() => URL.revokeObjectURL(blobUrl), 5000);
              } else { window.open(url, '_blank'); }
            } catch (err) { alert('사진을 열 수 없습니다.'); }
          });
        });
      }).catch(err => {
        root.innerHTML = '<p class="msg error">불러오기 실패: ' + (err.message || err) + '</p>';
      });
    }
  </script>
</body>
</html>
